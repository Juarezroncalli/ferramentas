<!doctype html>
<html lang="pt-BR">
  <head>
    <script>
      // Desabilita o clique direito
      document.addEventListener("contextmenu", (event) =>
        event.preventDefault(),
      );
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Extrator DMED/NFSe [Enterprise]</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
      :root {
        /* --- NEXUS THEME (LIGHT MODE) --- */
        --bg-app: #f6f8fa; /* Soft Gray Background */
        --bg-surface: #ffffff;
        --bg-panel: #ffffff;
        --bg-sidebar: #ffffff; /* White Sidebar */
        --bg-input: #f0f2f5;
        --bg-hover: #fcfcfd; /* Very subtle hover */
        --bg-tooltip: #1e2130;

        --text-primary: #1e2130; /* Dark Blue-Black */
        --text-secondary: #5e6c84; /* Cool Gray */
        --text-tertiary: #8f9bb3;
        --text-inverse: #ffffff;

        --border-subtle: #edf1f7; /* Very light border */
        --border-focus: #887cfd; /* Nexus Light Purple */
        --border-dashed: #3f3f46;

        /* Neon Highlight */
        --highlight-color: #887cfd;
        --highlight-bg: rgba(136, 124, 253, 0.25);

        --accent-primary: #5347ce; /* Nexus Purple */
        --accent-glow: rgba(83, 71, 206, 0.2);
        --accent-surface-hover: rgba(83, 71, 206, 0.05);

        /* Cores de Dados - Nexus Palette */
        --data-purple: #5347ce;
        --data-green: #16c8c7; /* Teal */
        --data-blue: #4896fe;
        --data-orange: #ffab00; /* Adjusted for better visibility */
        --data-red: #ff5630;

        /* Badges Backgrounds - Softer */
        --badge-green-bg: rgba(22, 200, 199, 0.12);
        --badge-purple-bg: rgba(83, 71, 206, 0.12);
        --badge-blue-bg: rgba(72, 150, 254, 0.12);
        --badge-red-bg: rgba(255, 86, 48, 0.12);
        --badge-orange-bg: rgba(255, 171, 0, 0.12);
        --badge-neutral-bg: #f7f9fc;
        --badge-mark-bg: #dbeafe;

        /* Design Tokens */
        --radius-sm: 8px;
        --radius-md: 16px; /* Modern rounded corners */
        --radius-lg: 24px;

        --shadow-card: 0px 4px 20px rgba(0, 0, 0, 0.05); /* Soft diffuse shadow */
        --shadow-float: 0px 8px 30px rgba(0, 0, 0, 0.12);
        --upload-pattern: radial-gradient(#e4e9f2 1px, transparent 1px);

        --font-ui:
          "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        --font-code: "JetBrains Mono", monospace;
      }

      /* --- DARK MODE OVERRIDES --- */
      [data-theme="dark"] {
        /* Nexus Dark Theme */
        --bg-app: #0f111a; /* Deep Navy/Black */
        --bg-surface: #1e2130; /* Dark Blue-Gray */
        --bg-panel: #1e2130;
        --bg-sidebar: #151725;
        --bg-input: #151725;
        --bg-hover: #2a2e42;
        --bg-tooltip: #2a2e42;

        --text-primary: #ffffff;
        --text-secondary: #a0aec0;
        --text-tertiary: #718096;
        --text-inverse: #0f111a;

        --border-subtle: #2d3748;
        --border-focus: #887cfd;
        --border-dashed: #4a5568;

        --accent-primary: #887cfd; /* Lighter Purple for Dark Mode */
        --accent-glow: rgba(136, 124, 253, 0.25);
        --accent-surface-hover: rgba(255, 255, 255, 0.05);

        /* Data Colors - Adjusted for Dark Mode */
        --data-purple: #887cfd;
        --data-green: #2dd4bf; /* Brighter Teal */
        --data-blue: #60a5fa;
        --data-orange: #fbbf24;
        --data-red: #f87171;

        /* Badges */
        --badge-green-bg: rgba(45, 212, 191, 0.15);
        --badge-purple-bg: rgba(136, 124, 253, 0.15);
        --badge-blue-bg: rgba(96, 165, 250, 0.15);
        --badge-red-bg: rgba(248, 113, 113, 0.15);
        --badge-orange-bg: rgba(251, 191, 36, 0.15);
        --badge-neutral-bg: #2d3748;
        --badge-mark-bg: rgba(56, 189, 248, 0.15);

        --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        --shadow-float: 0 10px 25px -5px rgba(0, 0, 0, 0.6);
        --upload-pattern: radial-gradient(#2d3748 1px, transparent 1px);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        outline: none;
      }

      body {
        font-family: var(--font-ui);
        background-color: var(--bg-app);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        display: flex;
        -webkit-font-smoothing: antialiased;
        font-size: 13px;
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      /* Scrollbar Dark Mode Compatible */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
      }
      [data-theme="dark"] ::-webkit-scrollbar-thumb {
        background: #3f3f46;
      }

      /* SIDEBAR */
      .sidebar {
        width: 72px;
        background: var(--bg-sidebar);
        padding: 2rem 0.8rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        flex-shrink: 0;
        color: var(--text-primary);
        z-index: 20;
        transition: background-color 0.3s ease;
        box-shadow: 1px 0 0 var(--border-subtle);
        position: relative;
        overflow-x: hidden;
      }

      [data-theme="dark"] .sidebar {
        box-shadow: 1px 0 0 var(--border-subtle);
        border-right: none;
      }

      .logo {
        padding-left: 0;
        justify-content: center;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        opacity: 1;
      }

      .logo i {
        color: var(--data-purple);
        font-size: 20px;
        background: var(--badge-purple-bg);
        padding: 8px;
        border-radius: 8px;
      }

      .nav-item {
        background: transparent;
        color: var(--text-secondary);
        padding: 0.8rem 0;
        margin-bottom: 0.8rem;
        width: 44px;
        height: 44px;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }

      .nav-item i {
        font-size: 18px;
      }

      .nav-item:hover {
        background-color: var(--bg-hover);
        color: var(--data-purple);
      }

      .nav-item.active {
        background-color: var(--badge-purple-bg);
        color: var(--data-purple);
      }

      /* MAIN CONTENT */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        background: var(--bg-app);
        background-image: linear-gradient(
          to bottom,
          var(--bg-surface) 0%,
          var(--bg-app) 100%
        );
        background-size: 100% 400px;
        background-repeat: no-repeat;
        transition: background 0.3s ease;
      }

      [data-theme="dark"] .main-content {
        background-image: none;
      }

      .scroll-content {
        flex: 1;
        overflow-y: auto;
        padding: 2rem 3rem;
        padding-bottom: 100px;
      }

      /* HEADER & THEME TOGGLE */
      .neo-header {
        background: transparent;
        border: none;
        padding: 0;
        margin-bottom: 1.5rem;
        box-shadow: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .neo-header h1 {
        font-weight: 600;
        font-size: 18px;
        color: var(--text-primary);
        letter-spacing: -0.01em;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .theme-toggle {
        background: transparent;
        border: 1px solid var(--data-purple);
        color: var(--data-purple);
        width: auto;
        padding: 0 14px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
        font-size: 11px;
      }
      .theme-toggle:hover {
        background: var(--data-purple);
        color: #ffffff;
        box-shadow: 0 0 10px rgba(98, 91, 246, 0.4);
      }
      [data-theme="dark"] .theme-toggle {
        border-color: var(--data-purple);
        color: var(--data-purple);
      }
      [data-theme="dark"] .theme-toggle:hover {
        background: var(--data-purple);
        color: #fff;
      }

      /* DASHBOARD */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .metric-card {
        background: var(--bg-surface);
        border: none;
        border-radius: var(--radius-md);
        padding: 1.5rem;
        box-shadow: var(--shadow-card);
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-float);
      }

      .metric-card::after {
        display: none;
      }

      .metric-icon-bg {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        font-size: 18px;
      }

      .metric-title {
        font-weight: 600;
        text-transform: none;
        font-size: 12px;
        color: var(--text-tertiary);
        margin-bottom: 0.5rem;
      }
      .metric-value {
        font-family: var(--font-ui);
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.02em;
      }
      .metric-card.purple .metric-value {
        color: var(--data-purple);
      }
      .metric-card.green .metric-value {
        color: var(--data-green);
      }
      .metric-card.blue .metric-value {
        color: var(--data-blue);
      }
      .metric-card.orange .metric-value {
        color: var(--data-orange);
      }

      /* UPLOAD */
      .upload-area {
        background: var(--bg-panel);
        border: 1px dashed var(--border-dashed);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        background-image: var(--upload-pattern);
        background-size: 20px 20px;
      }
      .upload-area:hover {
        border-color: var(--data-blue);
        background-color: var(--bg-hover);
      }
      .upload-label {
        font-weight: 500;
        font-size: 12px;
        color: var(--text-primary);
      }
      .upload-label i {
        color: var(--text-tertiary);
        margin-bottom: 0.5rem;
        font-size: 20px;
        transition: color 0.2s;
      }
      .upload-area:hover .upload-label i {
        color: var(--data-blue);
      }
      #xmlInput {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      /* FILTROS */
      .filters-container {
        margin-bottom: 2rem;
      }
      .filters-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: flex-end;
      }

      .form-group {
        flex: 1;
        min-width: 120px;
      }

      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        font-size: 12px;
        color: var(--text-secondary);
      }

      .neo-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid transparent;
        border-radius: var(--radius-sm);
        background: var(--bg-input);
        font-family: var(--font-ui);
        font-size: 13px;
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        transition: all 0.2s ease;
      }
      .neo-input:hover {
        background: var(--bg-hover);
      }
      .neo-input:focus {
        background: var(--bg-surface);
        border-color: var(--border-focus);
        box-shadow: 0 0 0 4px var(--accent-glow);
      }

      /* TOGGLES */
      .crt-toggles {
        display: flex;
        background: var(--bg-input);
        padding: 4px;
        border-radius: var(--radius-sm);
        height: 40px;
        gap: 4px;
      }
      .btn-toggle {
        flex: 1;
        background: transparent;
        border: none;
        font-family: var(--font-ui);
        font-size: 11px;
        font-weight: 600;
        color: var(--text-tertiary);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .btn-toggle:hover {
        color: var(--text-primary);
        background: rgba(0, 0, 0, 0.03);
      }
      .btn-toggle.active {
        background: var(--bg-surface);
        color: var(--data-purple);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .btn-filter {
        background: var(--data-purple);
        color: #ffffff;
        border: none;
        padding: 0 24px;
        font-family: var(--font-ui);
        font-weight: 600;
        border-radius: var(--radius-sm);
        font-size: 13px;
        cursor: pointer;
        height: 40px;
        transition: all 0.2s;
        box-shadow: 0 4px 12px rgba(83, 71, 206, 0.2);
      }
      [data-theme="dark"] .btn-filter {
        background: var(--data-purple);
        color: #fff;
      }
      .btn-filter:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(83, 71, 206, 0.3);
      }
      .btn-filter:active {
        transform: translateY(0);
      }

      .btn-print {
        background-color: var(--data-red);
        color: white;
      }

      /* TABELA */
      .table-container {
        width: 100%;
        overflow-x: hidden;
        border: none;
        border-radius: var(--radius-md);
        background: var(--bg-surface);
        box-shadow: var(--shadow-card);
        margin-bottom: 2rem;
        transition:
          background-color 0.3s,
          border-color 0.3s;
      }
      table {
        width: 100%;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0;
        font-family: var(--font-ui);
        font-size: 12px;
      }

      thead tr {
        background: var(--bg-surface);
      }

      th {
        color: var(--text-secondary);
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        border-bottom: 1px solid var(--border-subtle);
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--bg-surface);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      td {
        padding: 12px 12px;
        border-bottom: 1px solid var(--border-subtle);
        vertical-align: middle;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: background-color 0.2s;
      }

      /* Discriminação (last column) - Full View */
      td:last-child {
        white-space: pre-wrap;
        word-break: break-word;
        overflow: visible;
        text-overflow: clip;
        font-size: 13px;
        line-height: 1.5;
      }

      tr:last-child td {
        border-bottom: none;
      }
      tr:hover td {
        background: var(--bg-hover);
      }

      .marked-row td {
        background-color: var(--badge-mark-bg) !important;
      }

      .mark-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        color: var(--text-tertiary);
        font-size: 14px;
        transition: color 0.1s;
      }
      .mark-btn:hover {
        color: var(--text-primary);
      }
      .mark-btn.active {
        color: var(--data-green);
      }

      /* LARGURAS DE COLUNAS OTIMIZADAS PARA DMED */
      th:nth-child(1) {
        width: 5%;
        text-align: center;
      } /* Checkbox */
      th:nth-child(2) {
        width: 8%;
      } /* Número */
      th:nth-child(3) {
        width: 8%;
      } /* Emissão */
      th:nth-child(4) {
        width: 15%;
      } /* Prestador */
      th:nth-child(5) {
        width: 20%;
      } /* Tomador */
      th:nth-child(6) {
        width: 12%;
      } /* CPF/CNPJ */
      th:nth-child(7) {
        width: 6%;
      } /* Tipo */
      th:nth-child(8) {
        width: 10%;
        text-align: right;
      } /* Valor */
      th:nth-child(9) {
        width: auto;
      } /* Discriminação */

      .badge-crt {
        padding: 2px 5px;
        border-radius: 4px;
        font-size: 8px;
        font-weight: 600;
        border: 1px solid transparent;
      }
      .crt-simples {
        background: var(--badge-green-bg);
        color: var(--data-green);
        border-color: rgba(46, 184, 138, 0.2);
      }
      .crt-normal {
        background: var(--badge-purple-bg);
        color: var(--data-purple);
        border-color: rgba(98, 91, 246, 0.2);
      }

      .center {
        text-align: center;
      }

      .neon-highlight {
        color: #fff;
        background-color: var(--data-purple);
        text-shadow: 0 0 2px #fff;
        box-shadow:
          0 0 5px var(--accent-primary),
          0 0 10px var(--accent-primary);
        border-radius: 2px;
        padding: 0 2px;
        font-weight: bold;
      }

      /* FOOTER */
      .footer-controls {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 6px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: fixed;
        bottom: 0;
        left: 72px;
        right: 0;
        z-index: 100;
        height: 36px;
        transition:
          background-color 0.3s,
          border-color 0.3s;
      }
      [data-theme="dark"] .footer-controls {
        background: rgba(9, 9, 11, 0.9);
        border-top: 1px solid var(--border-subtle);
      }

      .status-bar {
        font-size: 10px;
        color: var(--text-secondary);
        font-family: var(--font-code);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      @media print {
        html,
        body {
          height: auto !important;
          overflow: visible !important;
          background: white !important;
          display: block !important;
        }
        .no-print,
        .upload-section,
        header,
        marquee,
        .sidebar,
        .filters-container,
        .dashboard-grid,
        .footer-controls {
          display: none !important;
        }
        .main-content {
          height: auto !important;
          overflow: visible !important;
          background: white !important;
          display: block !important;
        }
        .scroll-content {
          padding: 0;
          overflow: visible;
        }
        .table-container {
          height: auto !important;
          overflow: visible !important;
          box-shadow: none !important;
        }
        .container {
          width: 100%;
          max-width: none;
          padding: 0;
          margin: 0;
        }
        table {
          font-size: 10px;
          color: black;
        }
        .marked-row td {
          background-color: #f0f0f0 !important;
          color: black !important;
        }
        /* Se a classe print-marked estiver no body, esconde as não marcadas */
        body.print-marked-only tbody tr:not(.marked-row) {
          display: none !important;
        }
        body.print-marked-only tbody tr.marked-row {
          display: table-row !important;
        }
        #tableContainer {
          display: block !important;
          width: 100% !important;
        }
        #resultTable {
          display: table !important;
          width: 100% !important;
        }
        tbody {
          display: table-row-group !important;
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar no-print" id="appSidebar">
      <div class="logo">
        <i class="fas fa-file-invoice"></i>
      </div>
      <nav>
        <div class="nav-item active" title="Extração">
          <i class="fas fa-bolt"></i>
        </div>
        <div
          class="nav-item"
          onclick="document.getElementById('xmlInput').click()"
          title="Carregar XML"
        >
          <i class="fas fa-upload"></i>
        </div>
        <div
          class="nav-item"
          id="btnExportSidebar"
          style="display: none"
          onclick="exportToExcel()"
          title="Exportar Excel"
        >
          <i class="fas fa-file-excel"></i>
        </div>
        <div class="nav-item" onclick="limparSessao()" title="Limpar">
          <i class="fas fa-eraser"></i>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="scroll-content">
        <header class="neo-header no-print">
          <div>
            <h1>Extrator DMED / NFSe</h1>
          </div>
          <div class="header-actions">
            <button id="themeToggle" class="theme-toggle" title="Alternar Tema">
              <i class="fas fa-moon"></i> <span>Alterar Tema</span>
            </button>
          </div>
        </header>

        <div class="dashboard-grid no-print">
          <div class="metric-card purple">
            <div
              class="metric-icon-bg"
              style="
                background: var(--badge-purple-bg);
                color: var(--data-purple);
              "
            >
              <i class="fas fa-file-invoice"></i>
            </div>
            <div>
              <div class="metric-title">Notas Encontradas</div>
              <div class="metric-value" id="totalNotas">0</div>
            </div>
          </div>
          <div class="metric-card green">
            <div
              class="metric-icon-bg"
              style="
                background: var(--badge-green-bg);
                color: var(--data-green);
              "
            >
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div>
              <div class="metric-title">Valor Total (R$)</div>
              <div class="metric-value" id="valorTotal">0,00</div>
            </div>
          </div>
          <div class="metric-card blue">
            <div
              class="metric-icon-bg"
              style="background: var(--badge-blue-bg); color: var(--data-blue)"
            >
              <i class="fas fa-users"></i>
            </div>
            <div>
              <div class="metric-title">Tomadores Únicos</div>
              <div class="metric-value" id="totalTomadores">0</div>
            </div>
          </div>
          <div class="metric-card orange">
            <div
              class="metric-icon-bg"
              style="
                background: var(--badge-orange-bg);
                color: var(--data-orange);
              "
            >
              <i class="fas fa-check-square"></i>
            </div>
            <div>
              <div class="metric-title">Itens Marcados</div>
              <div class="metric-value" id="totalMarcados">0</div>
            </div>
          </div>
        </div>

        <div class="upload-area no-print">
          <input
            type="file"
            id="xmlInput"
            accept=".xml,.zip"
            multiple
            onchange="handleFileSelect(event)"
          />
          <div class="upload-label">
            <i class="fas fa-cloud-upload"></i><br />
            <span style="color: var(--text-primary); font-weight: 600"
              >Clique ou Arraste seus arquivos (XML ou ZIP)</span
            >
            <br /><span
              style="
                color: var(--text-tertiary);
                font-size: 11px;
                font-weight: 400;
              "
              >Suporta Múltiplos XMLs e Arquivos ZIP</span
            >
          </div>
        </div>

        <div
          class="filters-container no-print"
          id="filtersContainer"
          style="display: none"
        >
          <div class="filters-grid">
            <div class="form-group" style="flex: 2">
              <label>Busca na Discriminação</label>
              <input
                type="text"
                id="searchInput"
                class="neo-input"
                placeholder="Digite para filtrar..."
                onkeyup="applyFilters()"
              />
            </div>

            <div class="form-group" style="min-width: 200px">
              <label>Tipo de Documento</label>
              <div class="crt-toggles">
                <button
                  class="btn-toggle active"
                  id="btnTypeAll"
                  onclick="setFilterType('all')"
                >
                  Todos
                </button>
                <button
                  class="btn-toggle"
                  id="btnTypeCPF"
                  onclick="setFilterType('cpf')"
                >
                  CPF
                </button>
                <button
                  class="btn-toggle"
                  id="btnTypeCNPJ"
                  onclick="setFilterType('cnpj')"
                >
                  CNPJ
                </button>
              </div>
            </div>

            <button
              class="btn-filter"
              style="background: var(--data-blue); display: none"
              id="btnMarkAllVisible"
              onclick="markVisibleRows()"
              title="Marcar todas as notas que estão visíveis na lista abaixo"
            >
              <i class="fas fa-check-double" style="margin-right: 8px"></i>
              Marcar Visíveis
            </button>

            <button
              class="btn-filter"
              style="background: var(--data-green); display: none"
              id="btnExportFilter"
              onclick="exportToExcel()"
            >
              Exportar Seleção (Excel)
            </button>
          </div>
        </div>

        <div class="table-container" id="tableContainer" style="display: none">
          <table id="resultTable">
            <thead>
              <tr>
                <th style="width: 5%; text-align: center">
                  <i class="fas fa-check-square"></i>
                </th>
                <th style="width: 8%">Número</th>
                <th style="width: 8%">Emissão</th>
                <th style="width: 15%">Prestador</th>
                <th style="width: 20%">Tomador</th>
                <th style="width: 12%">CPF/CNPJ</th>
                <th style="width: 6%">Tipo</th>
                <th style="width: 10%">Valor (R$)</th>
                <th>Discriminação</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="footer-controls no-print">
        <div class="status-bar" id="statusMsg">
          <span style="color: var(--text-tertiary)">●</span> Aguardando
          arquivo...
        </div>
      </div>
    </main>

    <script>
      // Theme Management
      const themeToggleBtn = document.getElementById("themeToggle");
      const themeIcon = themeToggleBtn.querySelector("i");

      function setTheme(theme) {
        if (theme === "dark") {
          document.body.setAttribute("data-theme", "dark");
          themeIcon.className = "fas fa-sun";
          localStorage.setItem("theme", "dark");
        } else {
          document.body.removeAttribute("data-theme");
          themeIcon.className = "fas fa-moon";
          localStorage.setItem("theme", "light");
        }
      }

      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "light") {
        setTheme("light");
      } else {
        setTheme("dark");
      }

      themeToggleBtn.addEventListener("click", () => {
        const currentTheme = document.body.getAttribute("data-theme");
        setTheme(currentTheme === "dark" ? "light" : "dark");
      });

      // Data Management
      let currentFilterType = "all";
      let currentSearchTerm = "";

      async function handleFileSelect(evt) {
        const files = Array.from(evt.target.files);
        if (files.length === 0) return;

        document.getElementById("statusMsg").innerHTML =
          '<span style="color: var(--data-blue)">●</span> Processando arquivos...';

        let allXmlContents = [];

        const readFileAsText = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
          });
        };

        try {
          for (const file of files) {
            const lowerName = file.name.toLowerCase();
            if (lowerName.endsWith(".xml")) {
              const text = await readFileAsText(file);
              // Remove declarações XML para evitar erros na concatenação
              allXmlContents.push(text.replace(/<\?xml[^>]*\?>/g, ""));
            } else if (lowerName.endsWith(".zip")) {
              try {
                const zip = await JSZip.loadAsync(file);
                for (const filename of Object.keys(zip.files)) {
                  if (filename.toLowerCase().endsWith(".xml")) {
                    if (!zip.files[filename].dir) {
                      const text = await zip.files[filename].async("text");
                      allXmlContents.push(text.replace(/<\?xml[^>]*\?>/g, ""));
                    }
                  }
                }
              } catch (e) {
                console.error("Erro ao ler ZIP:", e);
                alert(`Erro ao ler o arquivo ZIP: ${file.name}`);
              }
            }
          }

          if (allXmlContents.length === 0) {
            alert("Nenhum arquivo XML válido encontrado.");
            document.getElementById("statusMsg").innerHTML =
              '<span style="color: var(--text-tertiary)">●</span> Aguardando arquivo...';
            return;
          }

          // Envolve todo o conteúdo em uma raiz única fictícia para o parser aceitar múltiplos nós raiz
          const aggregatedContent =
            "<Root>" + allXmlContents.join("\n") + "</Root>";

          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(aggregatedContent, "text/xml");
          processXML(xmlDoc);

          document.getElementById("filtersContainer").style.display = "block";
          document.getElementById("tableContainer").style.display = "block";
          document.getElementById("btnExportSidebar").style.display = "flex";
          document.getElementById("btnMarkAllVisible").style.display =
            "inline-block";
          document.getElementById("btnExportFilter").style.display =
            "inline-block";
        } catch (error) {
          console.error(error);
          alert("Ocorreu um erro ao processar os arquivos.");
          document.getElementById("statusMsg").innerHTML =
            '<span style="color: var(--data-red)">●</span> Erro no processamento.';
        }
      }

      function processXML(xml) {
        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";

        // COLETA UNIVERSAL DE NOTAS (Suporta Padrão ABRASF e Padrão Nacional/SPED)
        let notas = [];

        // 1. Padrão ABRASF / Ginfes (XML inicial do arquivo)
        xml.querySelectorAll("InfNfse").forEach((n) => notas.push(n));

        // 2. Fallbacks de containers antigos
        if (notas.length === 0)
          xml.querySelectorAll("CompNfse").forEach((n) => notas.push(n));
        if (notas.length === 0)
          xml.querySelectorAll("Nfse").forEach((n) => notas.push(n));

        // 3. Padrão Nacional / SPED (XMLs anexados no final do arquivo) - Tag <infNFSe>
        xml.querySelectorAll("infNFSe").forEach((n) => notas.push(n));

        // 4. Padrão Matozinhos (Tag <item> dentro de <notas>)
        if (notas.length === 0)
          xml.querySelectorAll("notas > item").forEach((n) => notas.push(n));

        // Fallback robusto antigo (mantido para segurança)
        if (notas.length === 0) {
          const nNFSeElements = xml.querySelectorAll("nNFSe");
          if (nNFSeElements.length > 0) {
            const parents = new Set();
            nNFSeElements.forEach((el) => parents.add(el.parentElement));
            notas = Array.from(parents);
          }
        }

        // Helper para pegar texto de múltiplos seletores (primeiro que encontrar)
        const getText = (parent, selectors) => {
          for (const sel of selectors) {
            const el = parent.querySelector(sel);
            if (el && el.textContent) return el.textContent.trim();
          }
          return "";
        };

        // Ordenação das notas por DATA (Menor para Maior)
        notas.sort((a, b) => {
          let dateA =
            getText(a, ["DataEmissao", "dCompet", "Data", "dhEmi"]) || "";
          let dateB =
            getText(b, ["DataEmissao", "dCompet", "Data", "dhEmi"]) || "";

          // Normaliza formato ISO (YYYY-MM-DD) removendo hora se houver
          if (dateA.includes("T")) dateA = dateA.split("T")[0];
          if (dateB.includes("T")) dateB = dateB.split("T")[0];

          // Comparação de string funciona bem para YYYY-MM-DD
          return dateA.localeCompare(dateB);
        });

        let totalNotasCount = 0;
        let totalValorSum = 0;
        let uniqueTomadores = new Set();
        let marcardosCount = 0;

        notas.forEach((nota) => {
          // Apenas processa se tiver um número de nota válido para evitar nós vazios
          const numero = getText(nota, ["Numero", "nNFSe", "NuNfse", "numero"]);
          if (!numero) return;

          totalNotasCount++;

          // 1. Data
          // Old: DataEmissao | New (SPED): dhEmi | Other: Data | Matozinhos: data_emissao
          let dataRaw = getText(nota, [
            "DataEmissao",
            "dCompet",
            "Data",
            "dhEmi",
            "data_emissao",
          ]);
          // Tratamento de Data (pode vir com 'T' ou com espaço separando a hora do dia)
          if (dataRaw.includes("T")) dataRaw = dataRaw.split("T")[0];
          if (dataRaw.includes(" ")) dataRaw = dataRaw.split(" ")[0];

          let data = "N/A";
          if (dataRaw) {
            if (dataRaw.includes("-")) {
              data = dataRaw.split("-").reverse().join("/");
            } else {
              // Assume que já está DD/MM/AAAA ou limpo
              data = dataRaw;
            }
          }

          // 1.5 Prestador (Razão Social)
          const prestadorRazao =
            getText(nota, [
              "PrestadorServico RazaoSocial",
              "prestadorservico RazaoSocial", // Lowercase tag
              "emit xNome",
              "Prestador RazaoSocial",
              "prestacao_servico razao_social",
            ]) || "N/A";

          // 2. Tomador
          const razaoSocial =
            getText(nota, [
              "TomadorServico RazaoSocial",
              "toma xNome", // Genérico e SPED
              "Tomador RazaoSocial",
              "Tomador Servico RazaoSocial",
              "DPS infDPS toma xNome", // Caminho explícito SPED
              "tomador_servico razao_social",
            ]) || "N/A";

          if (razaoSocial !== "N/A") uniqueTomadores.add(razaoSocial);

          // 3. DOC (CPF/CNPJ)
          let cpf = getText(nota, [
            "TomadorServico Cpf",
            "toma CPF", // SPED
            "Tomador Cpf",
            "Cpf",
            "DPS infDPS toma CPF",
          ]);
          let cnpj = getText(nota, [
            "TomadorServico Cnpj",
            "toma CNPJ", // SPED
            "Tomador Cnpj",
            "Cnpj",
            "DPS infDPS toma CNPJ",
          ]);

          let docMisto = getText(nota, [
            "tomador_servico cpf_cnpj",
            "cpf_cnpj",
          ]);
          if (docMisto) {
            docMisto = docMisto.replace(/[^0-9]/g, "");
            if (docMisto.length <= 11) cpf = docMisto;
            else cnpj = docMisto;
          }

          let tomadorDoc = "N/A";
          let tipoDoc = "OUTRO";

          if (cpf.length > 0) {
            tomadorDoc = cpf;
            tipoDoc = "CPF";
          } else if (cnpj.length > 0) {
            tomadorDoc = cnpj;
            tipoDoc = "CNPJ";
          }

          // 4. Valor
          const valorRaw =
            getText(nota, [
              "ValorServicos",
              "vServ",
              "ValorServico",
              "vLiq",
              "valor_servico",
            ]) || "0.00";
          // Normaliza valor para float: "R$ 3.650,00" -> 3650.00
          let valorStr = valorRaw.replace(/R\$/g, "").trim();
          if (valorStr.includes(".") && valorStr.includes(",")) {
            // Formato 3.650,00 -> remove pontos e troca virgula
            valorStr = valorStr.replace(/\./g, "").replace(",", ".");
          } else if (valorStr.includes(",")) {
            // Formato 3650,00
            valorStr = valorStr.replace(",", ".");
          }
          const valorFloat = parseFloat(valorStr);
          const valor = isNaN(valorFloat)
            ? "0,00"
            : valorFloat.toLocaleString("pt-BR", {
                minimumFractionDigits: 2,
              });
          if (!isNaN(valorFloat)) totalValorSum += valorFloat;

          // 5. Discriminação
          const discriminacao =
            getText(nota, [
              "Discriminacao",
              "xDescServ", // SPED
              "DiscriminacaoServico",
              "DPS infDPS serv cServ xDescServ",
              "discriminacao",
            ]) || "";

          // Mark Logic
          const rowId = `marked_nfse_${numero}`;
          const isMarked = localStorage.getItem(rowId) === "true";
          if (isMarked) marcardosCount++;

          const iconClass = isMarked ? "fas fa-check-square" : "far fa-square";
          const tr = document.createElement("tr");
          if (isMarked) tr.classList.add("marked-row");

          tr.dataset.type = tipoDoc.toLowerCase();
          tr.dataset.rowId = rowId;

          tr.innerHTML = `
                <td class="center">
                    <button class="mark-btn ${isMarked ? "active" : ""}" onclick="toggleMark(this, '${rowId}')">
                        <i class="${iconClass}"></i>
                    </button>
                </td>
                <td>${numero}</td>
                <td>${data}</td>
                <td>${prestadorRazao}</td>
                <td>${razaoSocial}</td>
                <td>${tomadorDoc}</td>
                <td><span class="badge-crt ${tipoDoc === "CPF" ? "crt-simples" : tipoDoc === "CNPJ" ? "crt-normal" : ""}">${tipoDoc}</span></td>
                <td>${valor}</td>
                <td style="color: var(--text-secondary)">${discriminacao}</td>
              `;

          tbody.appendChild(tr);
        });

        // Aciona o filtro (que agora também atualiza o Dashboard)
        applyFilters();

        document.getElementById("statusMsg").innerHTML =
          `<span style="color: var(--data-green)">●</span> Processado com sucesso.`;
      }

      function toggleMark(btn, rowId) {
        const tr = btn.closest("tr");
        const isNowMarked = !tr.classList.contains("marked-row");
        const icon = btn.querySelector("i");

        if (isNowMarked) {
          tr.classList.add("marked-row");
          btn.classList.add("active");
          icon.className = "fas fa-check-square";
          localStorage.setItem(rowId, "true");
        } else {
          tr.classList.remove("marked-row");
          btn.classList.remove("active");
          icon.className = "far fa-square";
          localStorage.removeItem(rowId);
        }
        updateDashboardMetrics();
      }

      function markVisibleRows() {
        const rows = document.querySelectorAll("#resultTable tbody tr");
        let changed = false;
        rows.forEach((row) => {
          if (
            row.style.display !== "none" &&
            !row.classList.contains("marked-row")
          ) {
            const rowId = row.dataset.rowId;
            const btn = row.querySelector(".mark-btn");
            const icon = btn.querySelector("i");

            row.classList.add("marked-row");
            btn.classList.add("active");
            icon.className = "fas fa-check-square";
            localStorage.setItem(rowId, "true");
            changed = true;
          }
        });
        if (changed) updateDashboardMetrics();
      }

      function setFilterType(type) {
        currentFilterType = type;
        document.getElementById("btnTypeAll").classList.remove("active");
        document.getElementById("btnTypeCPF").classList.remove("active");
        document.getElementById("btnTypeCNPJ").classList.remove("active");

        if (type === "all")
          document.getElementById("btnTypeAll").classList.add("active");
        if (type === "cpf")
          document.getElementById("btnTypeCPF").classList.add("active");
        if (type === "cnpj")
          document.getElementById("btnTypeCNPJ").classList.add("active");

        applyFilters();
      }

      function applyFilters() {
        const term = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#resultTable tbody tr");

        // Escape regex special characters securely
        const escapeRegExp = (string) => {
          return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        };

        rows.forEach((row) => {
          const rowType = row.dataset.type;
          // Discriminação is the last column (index 8)
          const discCell = row.children[8];
          // Use textContent to always get the raw text, clearing previous spans
          const originalText = discCell.textContent;
          const discText = originalText.toLowerCase();

          const matchType =
            currentFilterType === "all" || rowType === currentFilterType;
          const matchSearch = discText.includes(term);

          if (matchType && matchSearch) {
            row.style.display = "";

            // Logic for Highlighting
            if (term !== "") {
              const regex = new RegExp(`(${escapeRegExp(term)})`, "gi");
              // Replace matching content with neon highlight span
              // We rely on HTML replacement here since we want to inject spans
              discCell.innerHTML = originalText.replace(
                regex,
                '<span class="neon-highlight">$1</span>',
              );
            } else {
              // If search is cleared, ensure we show plain text
              discCell.textContent = originalText;
            }
          } else {
            row.style.display = "none";
          }
        });

        updateDashboardMetrics();
      }

      function updateDashboardMetrics() {
        const rows = document.querySelectorAll("#resultTable tbody tr");
        let totalNotasCount = 0;
        let totalValorSum = 0;
        let uniqueTomadores = new Set();
        let marcadosCount = 0;

        rows.forEach((row) => {
          if (row.style.display !== "none") {
            totalNotasCount++;

            // Get Tomador (column index 4)
            const razaoSocial = row.children[4].textContent.trim();
            if (razaoSocial && razaoSocial !== "N/A") {
              uniqueTomadores.add(razaoSocial);
            }

            // Get Valor (column index 7)
            const valorText = row.children[7].textContent.trim();
            // Convert back to float
            let valorStr = valorText.replace(/\./g, "").replace(",", ".");
            const valorFloat = parseFloat(valorStr);
            if (!isNaN(valorFloat)) {
              totalValorSum += valorFloat;
            }

            // check if marked
            if (row.classList.contains("marked-row")) {
              marcadosCount++;
            }
          }
        });

        // Update Metrics
        document.getElementById("totalNotas").textContent = totalNotasCount;
        document.getElementById("valorTotal").textContent =
          totalValorSum.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
        document.getElementById("totalTomadores").textContent =
          uniqueTomadores.size;
        document.getElementById("totalMarcados").textContent = marcadosCount;
      }

      function printMarked() {
        document.body.classList.add("print-marked-only");
        window.print();
        document.body.classList.remove("print-marked-only");
      }

      function exportToExcel() {
        // Função para normalizar texto: remove quebras de linha e caracteres estranhos
        // Isso garante que a discriminação não quebre linhas ou colunas no Excel
        const cleanText = (text) => {
          if (!text) return "";
          return text
            .replace(/[\r\n]+/g, " ") // Troca quebras de linha por espaço
            .replace(/\s+/g, " ") // Remove espaços múltiplos
            .trim();
        };

        // Coleta dados
        const data = [];
        // Cabeçalho
        data.push([
          "Marcado",
          "Número",
          "Emissão",
          "Prestador",
          "Razão Social",
          "CPF/CNPJ",
          "Tipo",
          "Valor (R$)",
          "Discriminação",
        ]);

        const rows = document.querySelectorAll("#resultTable tbody tr");

        rows.forEach((row) => {
          if (row.style.display === "none") return;

          const cols = row.querySelectorAll("td");
          const isMarked = row.classList.contains("marked-row") ? "Sim" : "Não";

          const numero = cols[1].innerText.trim();
          const emissao = cols[2].innerText.trim();
          const prestador = cols[3].innerText.trim();
          const razao = cols[4].innerText.trim();
          const doc = cols[5].innerText.trim();
          const tipo = cols[6].innerText.trim();
          const valor = cols[7].innerText.trim();

          // Aplica a limpeza na discriminação para evitar "cortes" ou quebras de linha
          const discriminacao = cleanText(cols[8].textContent);

          data.push([
            isMarked,
            numero,
            emissao,
            prestador,
            razao,
            doc,
            tipo,
            valor,
            discriminacao,
          ]);
        });

        // Cria Workbook e Worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Ajusta largura das colunas
        const wscols = [
          { wch: 8 }, // Marcado
          { wch: 10 }, // Numero
          { wch: 12 }, // Emissao
          { wch: 25 }, // Prestador
          { wch: 30 }, // Razao
          { wch: 18 }, // Doc
          { wch: 10 }, // Tipo
          { wch: 15 }, // Valor
          { wch: 50 }, // Discriminacao
        ];
        ws["!cols"] = wscols;

        XLSX.utils.book_append_sheet(wb, ws, "Extração");

        // Salva o arquivo
        XLSX.writeFile(wb, "extracao_notas.xlsx");
      }

      function limparSessao() {
        if (confirm("Deseja realmente limpar todas as marcações salvas?")) {
          Object.keys(localStorage).forEach((key) => {
            if (key.startsWith("marked_nfse_")) {
              localStorage.removeItem(key);
            }
          });
          // Reload
          location.reload();
        }
      }
    </script>
  </body>
</html>
