<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador de Layout NFS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f4f9;
        margin: 0;
        padding: 2rem;
      }
      .container {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        margin-bottom: 2rem;
      }
      .btn {
        background: #4f0072;
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        margin: 0.3rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn:hover {
        background: #370052;
      }
      .actions {
        text-align: center;
        margin-top: 1.5rem;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 2rem;
        text-align: center;
        margin: 1rem 0;
        cursor: pointer;
        border-radius: 8px;
      }
      .upload-area.dragover {
        background: #f0e6fa;
        border-color: #4f0072;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 0.6rem;
        text-align: center;
      }
      th {
        background: #4f0072;
        color: white;
      }
      #resultBox {
        margin-top: 2rem;
        padding: 1rem;
        border: 1px solid #ccc;
        background: #f9f9f9;
        white-space: pre-wrap;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <i class="fa-solid fa-file-lines"></i> Gerador de Layout de Notas
        Fiscais
      </h1>

      <div class="actions">
        <button id="downloadExcel" class="btn">
          <i class="fa-solid fa-download"></i> Baixar Modelo Excel
        </button>
        <input
          type="file"
          id="uploadExcel"
          accept=".xlsx, .xls"
          style="display: none"
        />
        <button id="uploadBtn" class="btn">
          <i class="fa-solid fa-upload"></i> Importar Excel
        </button>
        <button id="generateTxt" class="btn">
          <i class="fa-solid fa-file-export"></i> Gerar TXT
        </button>
      </div>

      <div class="upload-area" id="uploadArea">
        Arraste e solte o arquivo Excel aqui ou clique em "Importar Excel".
      </div>

      <table id="dataTable">
        <thead>
          <tr>
            <th>Espécie</th>
            <th>CNPJ</th>
            <th>Acumulador</th>
            <th>CFOP</th>
            <th>NF</th>
            <th>Data Entrada</th>
            <th>Valor NF</th>
            <th>Valor IRRF</th>
            <th>Valor CSRF</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="resultBox"></div>
    </div>

    <script>
      const downloadExcelBtn = document.getElementById("downloadExcel");
      const uploadExcelInput = document.getElementById("uploadExcel");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadArea = document.getElementById("uploadArea");
      const dataTableBody = document.querySelector("#dataTable tbody");
      const generateTxtBtn = document.getElementById("generateTxt");
      const resultBox = document.getElementById("resultBox");

      let importedData = [];

      // ==== Funções de formatação ====
      function formatDate(value) {
        if (!value) return "";
        if (!isNaN(value) && Number(value) > 30000) {
          // Serial Excel
          const date = XLSX.SSF.parse_date_code(Number(value));
          return `${String(date.d).padStart(2, "0")}/${String(date.m).padStart(
            2,
            "0"
          )}/${date.y}`;
        }
        if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(value)) return value;
        return value;
      }

      function formatValue(value) {
        if (!value) return "";
        let num = parseFloat(String(value).replace(",", "."));
        if (isNaN(num)) return "";
        return num.toFixed(2).replace(".", ",");
      }

      // ==== Baixar modelo Excel ====
      downloadExcelBtn.addEventListener("click", () => {
        const headers = [
          [
            "Especie",
            "CNPJ",
            "Acumulador",
            "CFOP",
            "NF",
            "Data Entrada",
            "Valor NF",
            "Valor IRRF",
            "Valor CSRF",
          ],
        ];
        const ws = XLSX.utils.aoa_to_sheet(headers);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Modelo");
        XLSX.writeFile(wb, "modelo_notas.xlsx");
      });

      // ==== Upload Excel ====
      uploadBtn.addEventListener("click", () => uploadExcelInput.click());

      ["dragenter", "dragover"].forEach((evt) =>
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add("dragover");
        })
      );
      ["dragleave", "drop"].forEach((evt) =>
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove("dragover");
        })
      );
      uploadArea.addEventListener("drop", (e) =>
        handleFile(e.dataTransfer.files[0])
      );
      uploadExcelInput.addEventListener("change", (e) =>
        handleFile(e.target.files[0])
      );

      function handleFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          const wb = XLSX.read(new Uint8Array(e.target.result), {
            type: "array",
          });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          importedData = XLSX.utils.sheet_to_json(sheet, { defval: "" });
          renderTable();
        };
        reader.readAsArrayBuffer(file);
      }

      function renderTable() {
        dataTableBody.innerHTML = "";
        importedData.forEach((row) => {
          const tr = document.createElement("tr");
          [
            "Especie",
            "CNPJ",
            "Acumulador",
            "CFOP",
            "NF",
            "Data Entrada",
            "Valor NF",
            "Valor IRRF",
            "Valor CSRF",
          ].forEach((col) => {
            const td = document.createElement("td");
            if (col.includes("Data")) {
              td.textContent = formatDate(row[col]);
            } else if (col.includes("Valor")) {
              td.textContent = formatValue(row[col]);
            } else {
              td.textContent = row[col] || "";
            }
            tr.appendChild(td);
          });
          dataTableBody.appendChild(tr);
        });
      }

      // ==== Gerar TXT ====
      generateTxtBtn.addEventListener("click", () => {
        if (importedData.length === 0) {
          alert("Nenhum dado importado!");
          return;
        }
        let txtContent = "";
        importedData.forEach((row) => {
          const especie = row["Especie"] || "";
          const cnpj = row["CNPJ"] || "";
          const acumulador = row["Acumulador"] || "";
          const cfop = row["CFOP"] || "";
          const nf = row["NF"] || "";
          const data = formatDate(row["Data Entrada"]);
          const valor = formatValue(row["Valor NF"]);
          const irrf = formatValue(row["Valor IRRF"]);
          const csrf = formatValue(row["Valor CSRF"]);

          txtContent += `|3000|45|||603||${nf}|||${data}|${data}|${valor}||||||||0|||${valor}||||\n`;

          if (irrf) {
            txtContent += `|3020|IRRF||${valor}|1,50|${irrf}|||||${valor}|\n`;
          }
          if (csrf) {
            txtContent += `|3020|CSRF||${valor}|4,65|${csrf}|||||${valor}|\n`;
          }
        });

        resultBox.textContent = txtContent;

        const blob = new Blob([txtContent], {
          type: "text/plain;charset=utf-8",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "notas_layout.txt";
        link.click();
      });
    </script>
  </body>
</html>
