<!doctype html>
<html lang="pt-BR">
  <head>
    <script>
      document.addEventListener("contextmenu", (event) =>
        event.preventDefault(),
      );
      document.onkeydown = function (e) {
        if (e.keyCode == 123) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 73) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 74) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 67) return false;
        if (e.ctrlKey && e.keyCode == 85) return false;
        if (e.ctrlKey && e.keyCode == 83) return false;
      };
    </script>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-6XKND47T4H"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-6XKND47T4H", {
        anonymize_ip: true,
        allow_google_signals: false,
        allow_ad_personalization_signals: false,
      });
    </script>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Informe de Rendimentos - Consolidador</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script id="tailwind-config">
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1E40AF",
              accent: "#F97316",
              danger: "#DC2626",
              success: "#059669",
              "background-light": "#F8FAFC",
              "card-light": "#FFFFFF",
              "border-light": "#E2E8F0",
              "text-main": "#1E293B",
              "text-muted": "#64748B",
            },
            fontFamily: {
              display: ["Inter", "sans-serif"],
              mono: ["'Courier New'", "monospace"],
            },
            borderRadius: {
              DEFAULT: "0px",
              md: "4px",
              lg: "8px",
              xl: "12px",
              full: "9999px",
            },
          },
        },
      };
    </script>

    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>

    <style type="text/tailwindcss">
      body {
        font-family: "Inter", sans-serif;
        background-color: theme("colors.background-light");
        color: theme("colors.text-main");
        min-height: 100vh;
        scroll-behavior: smooth;
        -webkit-font-smoothing: antialiased;
      }
      .custom-scrollbar::-webkit-scrollbar {
        height: 6px;
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      .loading-overlay {
        background-color: rgba(248, 250, 252, 0.95);
        backdrop-filter: blur(4px);
      }
      .section-header {
        background: theme("colors.primary");
        color: white;
        padding: 0.625rem 1rem;
        font-weight: 800;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .item-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.625rem 1rem;
        border-bottom: 1px solid theme("colors.border-light");
        transition: background-color 0.15s ease;
      }
      .item-row:last-child {
        border-bottom: none;
      }
      .item-row:hover {
        background: #f8fafc;
      }
      .item-value {
        font-family: "Courier New", monospace;
        font-weight: 700;
        font-size: 0.875rem;
        min-width: 130px;
        text-align: right;
      }
      @keyframes revealUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-reveal {
        animation: revealUp 0.35s ease-out forwards;
        opacity: 0;
      }
      .flat-btn {
        transition:
          background-color 0.15s ease,
          transform 0.1s ease;
      }
      .flat-btn:active {
        transform: scale(0.97);
      }
      .func-row:hover {
        background: #f1f5f9 !important;
      }
      .func-row {
        cursor: pointer;
        transition: background 0.15s;
      }
      .card-flat {
        background: white;
        border: 1px solid theme("colors.border-light");
        transition: all 0.2s ease;
      }
      .card-flat:hover {
        border-color: theme("colors.primary");
        box-shadow:
          0 4px 6px -1px rgba(30, 64, 175, 0.05),
          0 2px 4px -1px rgba(30, 64, 175, 0.03);
      }
    </style>
  </head>

  <body
    class="bg-background-light text-text-main antialiased font-display overflow-hidden select-none"
    oncontextmenu="return false;"
  >
    <!-- Loading Overlay -->
    <div
      id="loading"
      class="fixed inset-0 z-[100] hidden flex-col items-center justify-center loading-overlay transition-opacity duration-300 opacity-0"
    >
      <div
        class="size-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"
      ></div>
      <h3 id="loadingText" class="text-lg font-semibold text-primary font-mono">
        Processando PDF...
      </h3>
      <div class="w-64 h-1.5 bg-slate-200 rounded-full mt-4 overflow-hidden">
        <div
          id="loadingBar"
          class="h-full bg-primary rounded-full transition-all duration-300"
          style="width: 0%"
        ></div>
      </div>
      <span
        id="loadingPercent"
        class="text-xs text-text-muted mt-2 font-mono"
      ></span>
    </div>

    <div class="flex h-screen overflow-hidden">
      <!-- Modal Exclusão -->
      <div
        id="deleteModal"
        class="fixed inset-0 z-[200] hidden flex-col items-center justify-center bg-text-main/20 backdrop-blur-sm transition-opacity duration-300 opacity-0"
      >
        <div
          class="bg-card-light border border-border-light p-8 rounded-xl shadow-xl max-w-sm w-full text-center transform scale-95 transition-transform duration-300"
          id="deleteModalContent"
        >
          <div
            class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 border border-orange-100"
          >
            <span class="material-symbols-outlined text-accent text-3xl"
              >delete_forever</span
            >
          </div>
          <h2 class="text-xl font-bold text-text-main mb-2">Limpar Dados</h2>
          <p class="text-sm text-text-muted mb-6">
            Tem certeza que deseja apagar todos os dados processados? Esta ação
            não pode ser desfeita e você precisará processar o PDF novamente.
          </p>
          <div class="flex gap-3 justify-center">
            <button
              onclick="closeDeleteModal()"
              class="px-5 py-2.5 rounded-md text-sm font-bold bg-slate-100 hover:bg-slate-200 text-text-main transition-colors border border-slate-200 flex-1 flat-btn"
            >
              Cancelar
            </button>
            <button
              onclick="confirmLimpar()"
              class="px-5 py-2.5 rounded-md text-sm font-bold bg-accent hover:bg-orange-600 text-white transition-colors flex-1 flat-btn"
            >
              Sim, Apagar
            </button>
          </div>
        </div>
      </div>
      <!-- Sidebar -->
      <aside
        class="flex flex-col items-center py-6 w-20 bg-primary border-r border-primary shrink-0 z-50 text-white"
      >
        <div class="mb-10 text-white">
          <span class="material-symbols-outlined text-3xl">bolt</span>
        </div>
        <nav class="flex flex-col gap-5 flex-1">
          <button
            onclick="showView('consolidado')"
            class="p-3 bg-white/10 hover:bg-white/20 rounded-lg text-white transition-all flat-btn"
            title="Consolidado"
          >
            <span class="material-symbols-outlined">analytics</span>
          </button>
          <button
            onclick="showView('individual')"
            class="p-3 hover:bg-white/10 rounded-lg text-white/70 hover:text-white transition-all flat-btn"
            title="Por Funcionário"
          >
            <span class="material-symbols-outlined">groups</span>
          </button>
          <button
            onclick="exportExcel()"
            class="p-3 hover:bg-white/10 rounded-lg text-white/70 hover:text-white transition-all flat-btn"
            title="Exportar Excel"
          >
            <span class="material-symbols-outlined">file_download</span>
          </button>
          <button
            id="btnZipSidebar"
            onclick="downloadZip()"
            class="hidden p-3 hover:bg-white/10 rounded-lg text-white/70 hover:text-white transition-all flat-btn"
            title="PDFs Individuais (.ZIP)"
          >
            <span class="material-symbols-outlined">folder_zip</span>
          </button>
          <button
            onclick="limparDados()"
            class="p-3 hover:bg-white/10 rounded-lg text-white/70 hover:text-red-400 transition-all flat-btn"
            title="Limpar Dados"
          >
            <span class="material-symbols-outlined">delete</span>
          </button>
        </nav>
        <div class="text-[9px] text-white/30 font-mono mt-auto">v1.0</div>
      </aside>

      <!-- Main Content -->
      <main
        class="flex-1 flex flex-col overflow-hidden p-4 lg:p-8 space-y-6 bg-background-light"
      >
        <!-- Header -->
        <header class="flex items-center justify-between px-2 flex-wrap gap-4">
          <div>
            <h1
              class="text-2xl font-extrabold tracking-tight text-primary flex items-center gap-3"
            >
              Informe de Rendimentos
              <span
                class="text-[10px] font-mono text-white bg-accent px-2 py-0.5 rounded-sm"
                >CONSOLIDADOR</span
              >
            </h1>
            <div class="mt-2 flex items-center gap-2" id="empresaDisplay">
              <span
                class="text-[10px] font-bold text-text-muted tracking-widest uppercase"
                >Fonte Pagadora</span
              >
              <span
                class="text-xs font-bold text-text-main bg-white px-2.5 py-1 rounded border border-border-light"
                >Aguardando Arquivo...</span
              >
            </div>
          </div>

          <div class="flex items-center gap-3 flex-1 max-w-md mx-6">
            <div class="relative w-full">
              <span
                class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-muted text-sm"
                >search</span
              >
              <input
                id="searchInput"
                oninput="handleSearch(this.value)"
                class="w-full bg-white border border-border-light rounded-md pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-primary focus:border-primary text-sm transition-all placeholder:text-slate-400 outline-none"
                placeholder="Filtrar por nome ou CPF..."
                type="text"
              />
            </div>
          </div>

          <div class="flex items-center gap-3">
            <button
              id="btnZipHeader"
              onclick="downloadZip()"
              class="hidden bg-primary hover:bg-slate-800 text-white px-4 py-2.5 rounded-md text-xs font-bold transition-all flat-btn items-center gap-2"
            >
              <span class="material-symbols-outlined text-sm">folder_zip</span>
              ZIP
            </button>
            <button
              onclick="exportExcel()"
              class="bg-primary hover:bg-blue-800 text-white px-5 py-2.5 rounded-md text-xs font-bold transition-all flat-btn flex items-center gap-2"
            >
              <span class="material-symbols-outlined text-sm">download</span>
              EXCEL
            </button>
          </div>
        </header>

        <!-- Dashboard Area -->
        <div
          id="dashboard"
          class="flex-1 overflow-y-auto custom-scrollbar space-y-6 pr-2"
        >
          <!-- Metrics -->
          <div
            id="metricsGrid"
            class="grid grid-cols-1 md:grid-cols-4 gap-4 animate-reveal"
          >
            <div
              class="bg-white border border-border-light p-5 rounded-lg relative overflow-hidden group"
            >
              <span
                class="text-[10px] font-bold text-text-muted uppercase tracking-widest"
                >Beneficiários</span
              >
              <h3
                class="text-3xl font-black text-primary mt-1.5"
                id="metricTotal"
              >
                0
              </h3>
            </div>
            <div
              class="bg-white border border-border-light p-5 rounded-lg relative overflow-hidden group"
            >
              <span
                class="text-[10px] font-bold text-text-muted uppercase tracking-widest"
                >Rend. Tributáveis</span
              >
              <h3
                class="text-3xl font-black text-primary mt-1.5"
                id="metricRend"
              >
                R$ 0,00
              </h3>
            </div>
            <div
              class="bg-white border border-border-light p-5 rounded-lg relative overflow-hidden group"
            >
              <span
                class="text-[10px] font-bold text-text-muted uppercase tracking-widest"
                >IRRF Retido</span
              >
              <h3
                class="text-3xl font-black text-accent mt-1.5"
                id="metricIRRF"
              >
                R$ 0,00
              </h3>
            </div>
            <div
              class="bg-white border border-border-light p-5 rounded-lg relative overflow-hidden group"
            >
              <span
                class="text-[10px] font-bold text-text-muted uppercase tracking-widest"
                >13º Salário Líq.</span
              >
              <h3 class="text-3xl font-black text-success mt-1.5" id="metric13">
                R$ 0,00
              </h3>
            </div>
          </div>

          <!-- Upload Section -->
          <div
            id="uploadSection"
            class="bg-white border-2 border-dashed border-accent/30 rounded-lg p-16 transition-all hover:bg-slate-50 hover:border-accent group relative animate-reveal"
          >
            <input
              type="file"
              id="fileInput"
              accept=".pdf"
              onchange="handleFile(this.files[0])"
              class="absolute inset-0 opacity-0 cursor-pointer z-10"
            />
            <div
              class="flex flex-col items-center justify-center text-center space-y-4"
            >
              <div
                class="size-20 rounded-full bg-blue-50 text-primary flex items-center justify-center border border-blue-100"
              >
                <span class="material-symbols-outlined text-4xl"
                  >upload_file</span
                >
              </div>
              <div>
                <h3 class="text-xl font-bold">
                  Importar Comprovante de Rendimentos (.pdf)
                </h3>
                <p class="text-text-muted text-sm">
                  Arraste o arquivo ou clique para selecionar
                </p>
              </div>
            </div>
          </div>

          <!-- CONSOLIDADO VIEW -->
          <div id="viewConsolidado" class="hidden space-y-6">
            <div class="flex justify-between items-center">
              <h2
                class="text-lg font-bold text-primary flex items-center gap-2"
              >
                <span class="material-symbols-outlined text-primary"
                  >summarize</span
                >
                <span id="viewTitle">Informe Consolidado</span>
              </h2>
              <span
                id="viewBadge"
                class="bg-primary text-white text-[10px] font-bold px-2.5 py-1 uppercase rounded"
                >Todos</span
              >
            </div>

            <!-- Section 3 -->
            <div
              class="bg-white border border-border-light rounded-lg overflow-hidden shadow-sm"
            >
              <div class="section-header">
                <span
                  >3. Rendimentos Tributáveis, Deduções e Imposto Retido na
                  Fonte</span
                >
                <span class="text-[10px] font-mono opacity-70"
                  >Valores em Reais</span
                >
              </div>
              <div id="sec3Content"></div>
            </div>

            <!-- Section 4 -->
            <div
              class="bg-white border border-border-light rounded-lg overflow-hidden shadow-sm"
            >
              <div class="section-header">
                <span>4. Rendimentos Isentos e Não Tributáveis</span>
                <span class="text-[10px] font-mono opacity-70"
                  >Valores em Reais</span
                >
              </div>
              <div id="sec4Content"></div>
            </div>

            <!-- Section 5 -->
            <div
              class="bg-white border border-border-light rounded-lg overflow-hidden shadow-sm"
            >
              <div class="section-header">
                <span
                  >5. Rendimentos Sujeitos à Tributação Exclusiva (rendimento
                  líquido)</span
                >
                <span class="text-[10px] font-mono opacity-70"
                  >Valores em Reais</span
                >
              </div>
              <div id="sec5Content"></div>
            </div>
          </div>

          <!-- INDIVIDUAL VIEW (lista de funcionários) -->
          <div id="viewIndividual" class="hidden space-y-4">
            <h2 class="text-lg font-bold text-primary flex items-center gap-2">
              <span class="material-symbols-outlined text-primary">groups</span>
              Beneficiários Individuais
            </h2>
            <div
              class="bg-white border border-border-light rounded-lg overflow-hidden shadow-sm"
            >
              <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-xs">
                  <thead class="sticky top-0 z-10">
                    <tr class="bg-primary text-white text-left">
                      <th class="p-3 font-bold">CPF</th>
                      <th class="p-3 font-bold min-w-[200px]">BENEFICIÁRIO</th>
                      <th class="p-3 font-bold text-right">REND. TRIB.</th>
                      <th class="p-3 font-bold text-right">PREV. OFICIAL</th>
                      <th class="p-3 font-bold text-right">IRRF</th>
                      <th class="p-3 font-bold text-right">13º SALÁRIO</th>
                    </tr>
                  </thead>
                  <tbody
                    id="individualBody"
                    class="divide-y divide-border-light"
                  ></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer
          class="flex items-center justify-between text-xs text-text-muted pt-3 pb-1 border-t border-border-light"
        >
          <div class="flex items-center gap-1.5">
            <span class="size-2 rounded-full bg-green-500"></span>
            <span class="font-bold">SECURE-V1 ACTIVO</span>
          </div>
          <div class="font-bold text-xs uppercase">
            Desenvolvido por
            <span class="text-primary">J.Roncalli</span>
          </div>
        </footer>
      </main>
    </div>

    <script>
      // ============================================================
      // DEFINIÇÃO DOS CAMPOS EXATOS DO INFORME DE RENDIMENTOS
      // ============================================================
      const SEC_LABELS = {
        sec3: {
          "01": "Total dos rendimentos (inclusive férias)",
          "02": "Contribuição previdenciária oficial",
          "03": "Contribuição a entidades de previdência complementar, pública ou privada, e a Fundo de Aposentadoria Programada Individual - (Fapi) (preencher também o Quadro 7)",
          "04": "Pensão alimentícia (preencher também o Quadro 7)",
          "05": "Imposto sobre a Renda Retido na Fonte (IRRF)",
        },
        sec4: {
          "01": "Parcela isenta dos proventos de aposentadoria, reserva remunerada, reforma e pensão (65 anos ou mais), exceto a parcela isenta do 13º (décimo terceiro) salário",
          "02": "Parcela isenta do 13º salário de aposentadoria, reserva remunerada, reforma e pensão (65 anos ou mais)",
          "03": "Diárias e ajudas de custo",
          "04": "Pensão e proventos de aposentadoria ou reforma por moléstia grave; proventos de aposentadoria ou reforma por acidente em serviço",
          "05": "Lucros e dividendos, apurados a partir de 1996, pagos por pessoa jurídica (lucro real, presumido ou arbitrado)",
          "06": "Valores pagos ao titular ou sócio da microempresa ou empresa de pequeno porte, exceto pró-labore, aluguéis ou serviços prestados",
          "07": "Indenizações por rescisão de contrato de trabalho, inclusive a título de PDV e por acidente de trabalho",
          "08": "Juros de mora recebidos, devidos pelo atraso no pagamento de remuneração por exercício de emprego, cargo ou função",
          "09": "Outros (especificar)",
        },
        sec5: {
          "01": "13º (décimo terceiro) salário",
          "02": "Imposto sobre a Renda Retido na Fonte sobre 13º (décimo terceiro) salário",
          "03": "Outros",
        },
      };

      // ============================================================
      // ESTADO GLOBAL
      // ============================================================
      let db = {
        empresa: "",
        cnpj: "",
        anoCalendario: "",
        funcionarios: [],
        consolidado: { sec3: {}, sec4: {}, sec5: {} },
      };

      let pdfSourceBytes = null;
      let paginaParaFuncionario = [];
      let currentView = "consolidado";
      let selectedCpf = null;

      // ============================================================
      // HELPERS
      // ============================================================
      function parseBrl(str) {
        if (!str || typeof str !== "string") return 0;
        let clean = str.replace(/[^\d,.-]/g, "").trim();
        if (!clean) return 0;
        // Ex: 1.768,74 -> 1768.74
        if (clean.includes(".") && clean.includes(",")) {
          clean = clean.replace(/\./g, "").replace(",", ".");
        } else if (clean.includes(",")) {
          clean = clean.replace(",", ".");
        }
        const val = parseFloat(clean);
        return isNaN(val) ? 0 : val;
      }

      function formatBrl(val) {
        return val.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      function limparDados() {
        const modal = document.getElementById("deleteModal");
        const content = document.getElementById("deleteModalContent");
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        setTimeout(() => {
          modal.classList.remove("opacity-0");
          content.classList.remove("scale-95");
          content.classList.add("scale-100");
        }, 10);
      }

      function closeDeleteModal() {
        const modal = document.getElementById("deleteModal");
        const content = document.getElementById("deleteModalContent");
        modal.classList.add("opacity-0");
        content.classList.remove("scale-100");
        content.classList.add("scale-95");
        setTimeout(() => {
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }, 300);
      }

      function confirmLimpar() {
        location.reload();
      }

      function showLoading(show, msg, percent) {
        const el = document.getElementById("loading");
        const txt = document.getElementById("loadingText");
        const bar = document.getElementById("loadingBar");
        const pct = document.getElementById("loadingPercent");
        if (show) {
          el.classList.remove("hidden", "opacity-0");
          el.classList.add("flex");
          txt.innerText = msg || "Processando...";
          if (percent !== undefined) {
            bar.style.width = percent + "%";
            pct.innerText = Math.round(percent) + "%";
          }
        } else {
          el.classList.add("opacity-0");
          setTimeout(() => {
            el.classList.add("hidden");
            el.classList.remove("flex");
          }, 300);
        }
      }

      // ============================================================
      // PROCESSAMENTO DO PDF
      // ============================================================
      async function handleFile(file) {
        if (!file) return;
        showLoading(true, "Lendo PDF...", 0);

        const reader = new FileReader();
        reader.onload = async function () {
          try {
            pdfSourceBytes = new Uint8Array(this.result);
            const pdfCopy = new Uint8Array(this.result.slice(0));
            const pdf = await pdfjsLib.getDocument(pdfCopy).promise;

            db = {
              empresa: "",
              cnpj: "",
              anoCalendario: "",
              funcionarios: [],
              consolidado: { sec3: {}, sec4: {}, sec5: {} },
            };
            paginaParaFuncionario = [];

            for (let i = 1; i <= pdf.numPages; i++) {
              showLoading(
                true,
                `Processando página ${i} de ${pdf.numPages}...`,
                (i / pdf.numPages) * 100,
              );
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const lines = groupTextByLines(textContent.items);
              const info = processPage(lines);
              paginaParaFuncionario.push(info);
            }

            showLoading(false);
            document.getElementById("uploadSection").classList.add("hidden");
            showView("consolidado");
            renderAll();
          } catch (e) {
            console.error(e);
            alert("Erro ao processar o PDF: " + e.message);
            showLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function groupTextByLines(items) {
        const lines = [];
        const tolerance = 3;
        items.sort((a, b) => {
          if (Math.abs(a.transform[5] - b.transform[5]) > tolerance)
            return b.transform[5] - a.transform[5];
          return a.transform[4] - b.transform[4];
        });
        let currentLine = [];
        let currentY = null;
        items.forEach((item) => {
          if (
            currentY === null ||
            Math.abs(item.transform[5] - currentY) > tolerance
          ) {
            if (currentLine.length > 0) lines.push(currentLine);
            currentLine = [];
            currentY = item.transform[5];
          }
          currentLine.push(item.str);
        });
        if (currentLine.length > 0) lines.push(currentLine);
        return lines;
      }

      function processPage(lines) {
        let foundCpf = null;
        let foundNome = "DESCONHECIDO";

        // 1. Buscar empresa / CNPJ / Ano-calendário no topo de cada página
        for (let i = 0; i < lines.length; i++) {
          const lineStr = lines[i].join(" ").trim();

          // Ano-calendário
          if (!db.anoCalendario && lineStr.includes("Ano-calendário")) {
            const anoM = lineStr.match(/Ano[- ]calend[aá]rio[\s:]*(\d{4})/i);
            if (anoM) db.anoCalendario = anoM[1];
          }

          // CNPJ e Nome da empresa (Seção 1)
          if (!db.cnpj) {
            const cnpjM = lineStr.match(/(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2})/);
            if (cnpjM) {
              db.cnpj = cnpjM[1];
              // O nome da empresa geralmente vem depois do CNPJ na mesma linha ou na próxima
              const afterCnpj = lineStr
                .substring(lineStr.indexOf(cnpjM[1]) + cnpjM[1].length)
                .trim();
              if (afterCnpj.length > 3) {
                db.empresa = afterCnpj.split("  ")[0].trim();
              } else if (i + 1 < lines.length) {
                db.empresa = lines[i + 1].join(" ").trim();
              }
            }
          }

          // CPF do beneficiário (Seção 2)
          const cpfPattern = /(\d{3}\.\d{3}\.\d{3}-\d{2})/;
          if (!foundCpf && lineStr.match(cpfPattern)) {
            // Evita capturar o CNPJ como CPF
            if (!lineStr.includes("/")) {
              const cpfM = lineStr.match(cpfPattern);
              if (cpfM) {
                foundCpf = cpfM[1];
                const afterCpf = lineStr
                  .substring(lineStr.indexOf(foundCpf) + foundCpf.length)
                  .trim();
                if (afterCpf.length > 2) {
                  foundNome = afterCpf.split("  ")[0].trim();
                } else if (i + 1 < lines.length) {
                  const nextLine = lines[i + 1].join(" ").trim();
                  if (
                    nextLine.length > 2 &&
                    !nextLine.match(/^\d/) &&
                    !nextLine.includes("Rendimentos")
                  ) {
                    foundNome = nextLine;
                  }
                }
              }
            }
          }
        }

        if (!foundCpf) return null;

        // Verificar se já existe este funcionário
        let func = db.funcionarios.find((f) => f.cpf === foundCpf);
        if (!func) {
          func = {
            cpf: foundCpf,
            nome: foundNome,
            sec3: {},
            sec4: {},
            sec5: {},
          };
          db.funcionarios.push(func);
        }

        // 2. Extrair valores das seções 3, 4, 5
        let currentSec = null;
        for (let i = 0; i < lines.length; i++) {
          const lineStr = lines[i].join(" ").trim();

          // Detecção de seções
          if (
            lineStr.includes("3.") &&
            lineStr.toLowerCase().includes("rendimentos tributáveis")
          ) {
            currentSec = "sec3";
            continue;
          }
          if (
            lineStr.includes("4.") &&
            lineStr.toLowerCase().includes("rendimentos isentos")
          ) {
            currentSec = "sec4";
            continue;
          }
          if (
            lineStr.includes("5.") &&
            lineStr.toLowerCase().includes("rendimentos sujeitos")
          ) {
            currentSec = "sec5";
            continue;
          }
          if (
            (lineStr.includes("6.") &&
              lineStr.toLowerCase().includes("informações")) ||
            lineStr.toLowerCase().includes("responsável pelas informações")
          ) {
            currentSec = null;
            continue;
          }

          if (currentSec) {
            // Procura linhas começando com "N." (de 1. a 9.)
            const itemMatch = lineStr.match(/^(\d{1,2})\.\s/);
            if (itemMatch) {
              const num = itemMatch[1].padStart(2, "0");

              // Verificar se este item pertence à seção ativa
              if (!SEC_LABELS[currentSec][num]) continue;

              // Encontrar o valor monetário na linha
              // Pode estar no final da mesma linha OU na próxima (se quebrada)
              let valStr = "";

              // Estratégia: pegar o ÚLTIMO token numérico da linha inteira
              const tokens = lines[i];
              for (let t = tokens.length - 1; t >= 0; t--) {
                const tk = tokens[t].trim();
                if (/^[\d.,]+$/.test(tk) && tk.includes(",")) {
                  valStr = tk;
                  break;
                }
              }

              // Se não encontrou na mesma linha, tenta a próxima
              if (!valStr && i + 1 < lines.length) {
                const nextTokens = lines[i + 1];
                const nextStr = nextTokens.join(" ").trim();
                if (/^[\d.,]+$/.test(nextStr)) {
                  valStr = nextStr;
                } else {
                  for (let t = nextTokens.length - 1; t >= 0; t--) {
                    const tk = nextTokens[t].trim();
                    if (/^[\d.,]+$/.test(tk) && tk.includes(",")) {
                      valStr = tk;
                      break;
                    }
                  }
                }
              }

              const val = parseBrl(valStr);

              func[currentSec][num] = (func[currentSec][num] || 0) + val;
              db.consolidado[currentSec][num] =
                (db.consolidado[currentSec][num] || 0) + val;
            }
          }
        }

        return { cpf: foundCpf, nome: foundNome };
      }

      // ============================================================
      // RENDERIZAÇÃO
      // ============================================================
      function renderAll() {
        // Atualizar display da empresa
        const empresaEl = document.getElementById("empresaDisplay");
        empresaEl.innerHTML = `
          <span class="text-[10px] font-bold text-text-muted tracking-widest uppercase">Fonte Pagadora</span>
          <span class="text-xs font-bold text-primary bg-blue-50 px-2.5 py-1 rounded border border-blue-200">${db.empresa || "NÃO IDENTIFICADA"}</span>
          ${db.cnpj ? `<span class="text-[10px] font-mono text-text-muted">CNPJ: ${db.cnpj}</span>` : ""}
          ${db.anoCalendario ? `<span class="text-[10px] font-mono text-primary font-bold">Ano: ${db.anoCalendario}</span>` : ""}
        `;

        // Mostrar botão ZIP se temos PDF
        if (pdfSourceBytes) {
          document.getElementById("btnZipSidebar").classList.remove("hidden");
          document.getElementById("btnZipHeader").classList.remove("hidden");
          document.getElementById("btnZipHeader").classList.add("flex");
        }

        // Métricas
        document.getElementById("metricTotal").innerText =
          db.funcionarios.length;
        document.getElementById("metricRend").innerText = formatBrl(
          db.consolidado.sec3["01"] || 0,
        );
        document.getElementById("metricIRRF").innerText = formatBrl(
          db.consolidado.sec3["05"] || 0,
        );
        document.getElementById("metric13").innerText = formatBrl(
          db.consolidado.sec5["01"] || 0,
        );

        renderConsolidadoView();
        renderIndividualView();
      }

      function renderConsolidadoView(dataOverride, title, badge) {
        const data = dataOverride || db.consolidado;
        document.getElementById("viewTitle").innerText =
          title || "Informe Consolidado";
        document.getElementById("viewBadge").innerText =
          badge || `${db.funcionarios.length} Beneficiários`;

        renderSection("sec3Content", "sec3", data.sec3 || data);
        renderSection("sec4Content", "sec4", data.sec4 || {});
        renderSection("sec5Content", "sec5", data.sec5 || {});
      }

      function renderSection(containerId, secKey, data) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        const labels = SEC_LABELS[secKey];

        for (let k in labels) {
          const val = data[k] || 0;
          const row = document.createElement("div");
          row.className = "item-row";

          const isHighlight =
            (secKey === "sec3" && k === "05") ||
            (secKey === "sec5" && k === "02");

          row.innerHTML = `
            <span class="text-[13px] text-text-main leading-snug pr-4 flex-1">
              <span class="font-bold text-text-muted">${parseInt(k)}.</span> ${labels[k]}
            </span>
            <span class="item-value ${isHighlight ? "text-accent" : val > 0 ? "text-primary" : "text-slate-400"}">${formatBrl(val)}</span>
          `;
          container.appendChild(row);
        }
      }

      function renderIndividualView(filter = "") {
        const tbody = document.getElementById("individualBody");
        tbody.innerHTML = "";

        const filteredList = db.funcionarios.filter(
          (f) =>
            !filter ||
            f.nome.toLowerCase().includes(filter.toLowerCase()) ||
            f.cpf.includes(filter),
        );

        filteredList.forEach((f) => {
          const tr = document.createElement("tr");
          tr.className = "func-row";
          tr.onclick = () => {
            selectedCpf = f.cpf;
            showView("consolidado");
            renderConsolidadoView(f, f.nome, `CPF: ${f.cpf}`);

            // Rolar para o topo
            document.getElementById("dashboard").scrollTop = 0;
          };

          tr.innerHTML = `
            <td class="p-3 font-mono text-xs text-text-main">${f.cpf}</td>
            <td class="p-3 font-semibold text-text-main">${f.nome}</td>
            <td class="p-3 text-right font-mono ${(f.sec3["01"] || 0) > 0 ? "text-primary font-bold" : "text-slate-400"}">${formatBrl(f.sec3["01"] || 0)}</td>
            <td class="p-3 text-right font-mono ${(f.sec3["02"] || 0) > 0 ? "text-text-main" : "text-slate-400"}">${formatBrl(f.sec3["02"] || 0)}</td>
            <td class="p-3 text-right font-mono ${(f.sec3["05"] || 0) > 0 ? "text-accent font-bold" : "text-slate-400"}">${formatBrl(f.sec3["05"] || 0)}</td>
            <td class="p-3 text-right font-mono ${(f.sec5["01"] || 0) > 0 ? "text-success font-bold" : "text-slate-400"}">${formatBrl(f.sec5["01"] || 0)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // ============================================================
      // NAVEGAÇÃO DE VIEWS
      // ============================================================
      function showView(view) {
        currentView = view;
        const consView = document.getElementById("viewConsolidado");
        const indView = document.getElementById("viewIndividual");

        if (view === "consolidado") {
          consView.classList.remove("hidden");
          indView.classList.add("hidden");
          // Se não há seleção individual, mostrar consolidado
          if (!selectedCpf) {
            renderConsolidadoView();
          }
        } else {
          consView.classList.add("hidden");
          indView.classList.remove("hidden");
          selectedCpf = null;
          renderIndividualView();
        }
      }

      function handleSearch(val) {
        if (val.trim()) {
          showView("individual");
          renderIndividualView(val);
        } else {
          renderIndividualView();
        }
      }

      // ============================================================
      // EXPORTAÇÃO EXCEL
      // ============================================================
      function exportExcel() {
        if (!db.funcionarios.length) return alert("Nenhum dado para exportar.");

        const wb = XLSX.utils.book_new();

        // Sheet 1: Consolidado
        const consData = [
          ["INFORME DE RENDIMENTOS - CONSOLIDADO"],
          ["Empresa:", db.empresa, "CNPJ:", db.cnpj],
          [],
          ["SEÇÃO", "ITEM", "DESCRIÇÃO", "VALOR"],
        ];

        ["sec3", "sec4", "sec5"].forEach((sec) => {
          const secNum = sec.replace("sec", "");
          for (let k in SEC_LABELS[sec]) {
            consData.push([
              secNum,
              k,
              SEC_LABELS[sec][k],
              db.consolidado[sec][k] || 0,
            ]);
          }
        });

        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.aoa_to_sheet(consData),
          "Consolidado",
        );

        // Sheet 2: Individual
        const header = ["CPF", "NOME"];
        ["sec3", "sec4", "sec5"].forEach((sec) => {
          for (let k in SEC_LABELS[sec]) {
            const secNum = sec.replace("sec", "");
            header.push(`S${secNum}.${k}`);
          }
        });

        const funcData = [header];
        db.funcionarios.forEach((f) => {
          const row = [f.cpf, f.nome];
          ["sec3", "sec4", "sec5"].forEach((sec) => {
            for (let k in SEC_LABELS[sec]) {
              row.push(f[sec][k] || 0);
            }
          });
          funcData.push(row);
        });

        XLSX.utils.book_append_sheet(
          wb,
          XLSX.utils.aoa_to_sheet(funcData),
          "Por Beneficiário",
        );

        XLSX.writeFile(
          wb,
          `Informe_Rendimentos_${db.empresa || "Export"}.xlsx`,
        );
      }

      // ============================================================
      // ZIP COM PDFs INDIVIDUAIS
      // ============================================================
      async function downloadZip() {
        if (!pdfSourceBytes || paginaParaFuncionario.length === 0) {
          return alert("Nenhum PDF disponível.");
        }
        showLoading(true, "Separando PDFs...", 0);
        try {
          const zip = new JSZip();
          const { PDFDocument } = PDFLib;
          const mainPdf = await PDFDocument.load(pdfSourceBytes);

          const map = {};
          paginaParaFuncionario.forEach((info, idx) => {
            if (info && info.cpf) {
              if (!map[info.cpf])
                map[info.cpf] = { nome: info.nome, pages: [] };
              map[info.cpf].pages.push(idx);
            }
          });

          const cpfs = Object.keys(map);
          for (let c = 0; c < cpfs.length; c++) {
            const cpf = cpfs[c];
            const func = map[cpf];
            showLoading(
              true,
              `Criando PDF: ${func.nome} (${c + 1}/${cpfs.length})`,
              ((c + 1) / cpfs.length) * 100,
            );

            const newDoc = await PDFDocument.create();
            const pages = await newDoc.copyPages(mainPdf, func.pages);
            pages.forEach((p) => newDoc.addPage(p));
            const bytes = await newDoc.save();
            zip.file(`${func.nome.replace(/[/\\?%*:|"<>]/g, "-")}.pdf`, bytes);
          }

          showLoading(true, "Gerando ZIP...", 100);
          const blob = await zip.generateAsync({ type: "blob" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `${(db.empresa || "Empresa").replace(/[/\\?%*:|"<>]/g, "-")}.zip`;
          link.click();
          showLoading(false);
        } catch (e) {
          console.error(e);
          alert("Erro ao criar ZIP: " + e.message);
          showLoading(false);
        }
      }
    </script>
  </body>
</html>
