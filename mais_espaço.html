<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador de Importação Financeira</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f4f4f9;
        margin: 0;
        padding: 2rem;
      }
      .container {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        text-align: center;
        margin-bottom: 1.5rem;
        color: #333;
      }
      .config-area {
        background: #f0e6fa;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        border: 1px solid #4f0072;
      }
      .input-group {
        display: flex;
        flex-direction: column;
      }
      .input-group label {
        font-weight: bold;
        font-size: 0.9rem;
        color: #4f0072;
        margin-bottom: 0.3rem;
      }
      .input-group input {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
      }
      .btn {
        background: #4f0072;
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        margin: 0.3rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s;
      }
      .btn:hover {
        background: #370052;
      }
      .actions {
        text-align: center;
        margin-top: 1.5rem;
      }
      .upload-area {
        border: 2px dashed #ccc;
        padding: 2rem;
        text-align: center;
        margin: 1rem 0;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.3s;
      }
      .upload-area.dragover {
        background: #f0e6fa;
        border-color: #4f0072;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 0.6rem;
        text-align: center;
      }
      th {
        background: #4f0072;
        color: white;
      }
      #statusMsg {
        text-align: center;
        margin: 10px 0;
        font-weight: bold;
        color: #4f0072;
      }
      #resultBox {
        margin-top: 2rem;
        padding: 1rem;
        border: 1px solid #ccc;
        background: #f9f9f9;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <i class="fa-solid fa-file-invoice-dollar"></i> Gerador de Importação de Cobranças
      </h1>

      <div class="config-area">
        <div class="input-group">
          <label for="contaCartao">Conta Banco/Cartão (Débito)</label>
          <input type="text" id="contaCartao" placeholder="Ex: 1001" />
        </div>
        <div class="input-group">
          <label for="contaClientes">Conta Clientes (Crédito)</label>
          <input type="text" id="contaClientes" placeholder="Ex: 2001" />
        </div>
      </div>

      <div class="actions">
        <input
          type="file"
          id="uploadExcel"
          accept=".xlsx, .xls, .csv"
          style="display: none"
        />
        <button id="uploadBtn" class="btn">
          <i class="fa-solid fa-upload"></i> Importar CSV / Excel
        </button>
        <button id="generateTxt" class="btn">
          <i class="fa-solid fa-file-export"></i> Gerar TXT
        </button>
      </div>

      <div class="upload-area" id="uploadArea">
        Arraste e solte o arquivo (CSV ou Excel) aqui ou clique no botão acima.
      </div>
      
      <div id="statusMsg"></div>

      <table id="dataTable">
        <thead>
          <tr>
            <th>ID (Fatura)</th>
            <th>Data Pagamento</th>
            <th>Valor</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="resultBox"></div>
    </div>

    <script>
      const uploadExcelInput = document.getElementById("uploadExcel");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadArea = document.getElementById("uploadArea");
      const dataTableBody = document.querySelector("#dataTable tbody");
      const generateTxtBtn = document.getElementById("generateTxt");
      const resultBox = document.getElementById("resultBox");
      const statusMsg = document.getElementById("statusMsg");

      const inputContaCartao = document.getElementById("contaCartao");
      const inputContaClientes = document.getElementById("contaClientes");

      let importedData = [];

      // ==== Funções Auxiliares ====
      function formatDate(value) {
        if (!value) return "";
        // Excel Serial
        if (!isNaN(value) && Number(value) > 20000) {
          const date = XLSX.SSF.parse_date_code(Number(value));
          return `${String(date.d).padStart(2, "0")}/${String(date.m).padStart(2, "0")}/${date.y}`;
        }
        // String ISO (yyyy-mm-dd) comum em CSVs
        if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
            const parts = value.split(" ")[0].split("-"); // remove hora se houver
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return value;
      }

      function formatValue(value) {
        if (!value) return "0,00";
        // Remove R$ ou espaços
        let strVal = String(value).replace("R$", "").trim();
        
        // Se for formato brasileiro (1.000,00), remove ponto e troca virgula por ponto para JS entender
        if (strVal.includes(",") && strVal.includes(".")) {
             strVal = strVal.replace(/\./g, "").replace(",", ".");
        } else if (strVal.includes(",")) {
             strVal = strVal.replace(",", ".");
        }

        let num = parseFloat(strVal);
        if (isNaN(num)) return "0,00";
        return num.toFixed(2).replace(".", ",");
      }

      // ==== Upload ====
      uploadBtn.addEventListener("click", () => uploadExcelInput.click());

      ["dragenter", "dragover"].forEach((evt) =>
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.add("dragover");
        })
      );
      ["dragleave", "drop"].forEach((evt) =>
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          uploadArea.classList.remove("dragover");
        })
      );
      uploadArea.addEventListener("drop", (e) =>
        handleFile(e.dataTransfer.files[0])
      );
      uploadExcelInput.addEventListener("change", (e) =>
        handleFile(e.target.files[0])
      );

      function handleFile(file) {
        if (!file) return;
        statusMsg.textContent = "Lendo arquivo...";
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            // Tenta ler com codificação padrão. Se falhar caracteres, o SheetJS geralmente lida bem com UTF8/CP1252
            const wb = XLSX.read(data, { type: "array", codepage: 65001 }); 
            const sheet = wb.Sheets[wb.SheetNames[0]];
            
            // 1. Converter tudo para array de arrays para encontrar o cabeçalho
            const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // 2. Procurar a linha que contem "Cobrança.Id"
            let headerRowIndex = -1;
            
            for (let i = 0; i < rawData.length; i++) {
                const rowStr = JSON.stringify(rawData[i]);
                // Verifica se a linha contem o termo chave (flexivel)
                if (rowStr.includes("Cobrança.Id")) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) {
                statusMsg.textContent = "Erro: Coluna 'Cobrança.Id' não encontrada no arquivo.";
                alert("Não encontrei a coluna 'Cobrança.Id'. Verifique se o arquivo está correto.");
                return;
            }

            // 3. Importar novamente usando a linha correta como cabeçalho
            importedData = XLSX.utils.sheet_to_json(sheet, { range: headerRowIndex, defval: "" });
            
            statusMsg.textContent = `Arquivo carregado! Cabeçalho encontrado na linha ${headerRowIndex + 1}. ${importedData.length} registros.`;
            renderTable();

          } catch (err) {
            console.error(err);
            statusMsg.textContent = "Erro ao processar o arquivo. Verifique o console.";
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function renderTable() {
        dataTableBody.innerHTML = "";
        
        // Limita a exibição às primeiras 50 linhas para não travar se for gigante
        const previewData = importedData.slice(0, 100);

        previewData.forEach((row) => {
          // Busca pelas colunas exatas
          const id = row["Cobrança.Id"];
          const data = row["Cobrança.DataDePagamento"];
          const valor = row["Cobrança.Valor"];

          // Se a linha estiver vazia nas chaves principais, pula
          if (!id && !valor) return;

          const tr = document.createElement("tr");
          
          const tdId = document.createElement("td");
          tdId.textContent = id || "";
          
          const tdData = document.createElement("td");
          tdData.textContent = formatDate(data);
          
          const tdValor = document.createElement("td");
          tdValor.textContent = formatValue(valor);

          tr.appendChild(tdId);
          tr.appendChild(tdData);
          tr.appendChild(tdValor);
          
          dataTableBody.appendChild(tr);
        });
      }

      // ==== Gerar TXT ====
      generateTxtBtn.addEventListener("click", () => {
        if (importedData.length === 0) {
          alert("Importe o arquivo primeiro.");
          return;
        }

        const contaCartao = inputContaCartao.value.trim();
        const contaClientes = inputContaClientes.value.trim();

        if (!contaCartao || !contaClientes) {
            alert("Preencha os campos de Conta Débito e Crédito.");
            return;
        }

        let txtContent = "";
        
        importedData.forEach((row) => {
          const id = row["Cobrança.Id"];
          if (!id) return; // Pula linhas de totais ou vazias

          const dataPagamento = formatDate(row["Cobrança.DataDePagamento"]);
          const valor = formatValue(row["Cobrança.Valor"]);
          
          // Layout solicitado
          const linha = `${dataPagamento};${contaCartao};${contaClientes};${valor};;RECEITA DE LOCACAO, CONF. FATURA ${id};;;;`;
          txtContent += linha + "\n";
        });

        resultBox.textContent = txtContent;

        const blob = new Blob([txtContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "layout_importacao.txt";
        link.click();
      });
    </script>
  </body>
</html>