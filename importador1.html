<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-6XKND47T4H"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      // Configura√ß√µes para prote√ß√£o de dados e privacidade
      gtag("config", "G-6XKND47T4H", {
        anonymize_ip: true,
        allow_google_signals: false,
        allow_ad_personalization_signals: false,
      });
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Importador Cont√°bil - Neo Brutalism</title>
    <link rel="icon" href="icone.ico" type="image/x-icon" />
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* Paleta Neo Brutalism - Conforme solicitado */
        --bg-body: #ffde00;
        --card-bg: #ffffff;
        --border-black: #000000;
        --c-purple: #8b5cf6;
        --c-pink: #ff90e8;
        --c-blue: #06b6d4;
        --c-green: #22c55e;
        --c-red: #ff4d4d;
        --border-width: 3px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Space Grotesk", sans-serif;
        background-color: var(--bg-body);
        background-image: radial-gradient(#000 1px, transparent 1px);
        background-size: 20px 20px;
        color: var(--border-black);
        height: 100vh;
        overflow: hidden;
        display: flex;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        width: 240px;
        background: var(--c-purple);
        border-right: var(--border-width) solid var(--border-black);
        padding: 1.5rem 1rem;
        display: flex;
        flex-direction: column;
        color: #fff;
        flex-shrink: 0;
      }

      .logo {
        font-size: 1.5rem;
        font-weight: 900;
        text-transform: uppercase;
        margin-bottom: 2rem;
        text-shadow: 3px 3px 0 #000;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nav-item {
        background: #fff;
        color: #000;
        padding: 0.8rem;
        margin-bottom: 0.8rem;
        font-weight: 800;
        text-transform: uppercase;
        border: var(--border-width) solid #000;
        box-shadow: 3px 3px 0 0 #000;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.2s;
        font-size: 0.85rem;
      }

      .nav-item.active {
        background: var(--c-blue);
        transform: translate(-2px, -2px);
        box-shadow: 5px 5px 0 0 #000;
      }

      /* --- MAIN CONTENT --- */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow-y: auto;
        padding: 1.5rem;
      }

      .neo-header {
        background: #fff;
        border: var(--border-width) solid #000;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 5px 5px 0 0 #000;
      }

      .neo-header h1 {
        font-weight: 900;
        text-transform: uppercase;
        font-size: 1.8rem;
      }

      /* --- CARDS & UI --- */
      .neo-card {
        background: #fff;
        border: var(--border-width) solid #000;
        padding: 1.5rem;
        box-shadow: 5px 5px 0 0 #000;
        margin-bottom: 1.5rem;
      }

      .card-title {
        font-weight: 900;
        text-transform: uppercase;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Upload Area */
      .upload-area {
        background: var(--c-pink);
        border: 3px dashed #000;
        padding: 2.5rem;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
        position: relative;
        margin-bottom: 1rem;
      }

      .upload-area:hover {
        background: #ffbdf2;
        transform: scale(1.01);
      }

      /* Buttons */
      .neo-btn {
        background: var(--c-green);
        color: #000;
        border: var(--border-width) solid #000;
        padding: 1rem;
        font-weight: 900;
        text-transform: uppercase;
        cursor: pointer;
        font-family: "Space Grotesk";
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 4px 4px 0 0 #000;
        width: 100%;
        transition: 0.1s;
      }

      .neo-btn:active:not(:disabled) {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 0 #000;
      }

      .neo-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn-download {
        background: var(--c-blue);
        margin-top: 1rem;
      }

      /* Preview e Alertas */
      .preview-box {
        background: #000;
        color: #22c55e;
        font-family: "Space Mono", monospace;
        padding: 1rem;
        border: var(--border-width) solid #000;
        overflow-x: auto;
        margin-top: 1rem;
        font-size: 0.8rem;
      }

      .alert {
        padding: 1rem;
        border: var(--border-width) solid #000;
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.8rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .alert-error {
        background: var(--c-red);
        color: #fff;
      }
      .alert-success {
        background: var(--c-green);
      }

      /* Instru√ß√µes */
      .step-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 0.5rem;
        font-family: "Space Mono";
        font-weight: bold;
        font-size: 0.85rem;
      }
      .step-num {
        background: #000;
        color: #fff;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        flex-shrink: 0;
      }

      .hidden {
        display: none !important;
      }

      @media (max-width: 768px) {
        body {
          flex-direction: column;
          overflow: auto;
        }
        .sidebar {
          width: 100%;
          height: auto;
          border-right: none;
          border-bottom: 3px solid #000;
        }
        .main-content {
          height: auto;
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-file-export"></i>
        <span>ImportApp</span>
      </div>
      <nav>
        <div class="nav-item active">
          <i class="fas fa-magic"></i> Conversor
        </div>
        <div class="nav-item"><i class="fas fa-history"></i> Hist√≥rico</div>
      </nav>
      <div
        style="
          margin-top: auto;
          font-family: 'Space Mono';
          font-size: 0.6rem;
          opacity: 0.8;
        "
      >
        SISTEMA DE IMPORTA√á√ÉO V4.0
      </div>
    </aside>

    <main class="main-content">
      <header class="neo-header">
        <h1>Processador Cont√°bil üìÇ</h1>
        <p
          style="font-family: 'Space Mono'; font-weight: 800; font-size: 0.8rem"
        >
          Layout Neo Brutalista / 2026
        </p>
      </header>

      <div class="neo-card" style="background: var(--c-blue)">
        <div class="card-title">
          <i class="fas fa-info-circle"></i> Regras de Neg√≥cio
        </div>
        <div class="step-item">
          <div class="step-num">1</div>
          Ignora as primeiras 5 linhas de cabe√ßalho.
        </div>
        <div class="step-item">
          <div class="step-num">2</div>
          Colunas: dDatLanc, nVlrCred, cDesHist, nCodClTbIP, nCodClTbI.
        </div>
        <div class="step-item">
          <div class="step-num">3</div>
          Gera TXT para importa√ß√£o autom√°tica.
        </div>
      </div>

      <div class="neo-card">
        <div class="upload-area" id="uploadArea">
          <i class="fas fa-cloud-upload-alt fa-3x"></i><br /><br />
          <span
            id="fileName"
            style="font-weight: 900; text-transform: uppercase"
            >Arraste o arquivo Excel (.xlsx)</span
          >
          <p
            id="fileHint"
            style="font-size: 0.7rem; margin-top: 5px; font-weight: bold"
          >
            (O sistema processa localmente no seu navegador)
          </p>
          <input
            type="file"
            id="fileInput"
            accept=".xlsx,.xls"
            class="hidden"
          />
        </div>

        <div id="errorAlert" class="alert alert-error hidden">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="errorMessage">Erro</span>
        </div>

        <button id="processButton" class="neo-btn hidden">
          <i class="fas fa-bolt"></i> PROCESSAR AGORA
        </button>

        <div id="successContainer" class="hidden" style="margin-top: 1.5rem">
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span>Processamento Conclu√≠do!</span>
          </div>

          <div
            style="
              font-family: 'Space Mono';
              font-weight: 900;
              font-size: 0.7rem;
              text-transform: uppercase;
            "
          >
            Pr√©via dos Dados:
          </div>
          <div class="preview-box" id="previewContent"></div>

          <button id="downloadButton" class="neo-btn btn-download">
            <i class="fas fa-download"></i> BAIXAR ARQUIVO .TXT
          </button>
        </div>
      </div>
    </main>

    <script>
      // DOM Elements
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const fileName = document.getElementById("fileName");
      const processButton = document.getElementById("processButton");
      const errorAlert = document.getElementById("errorAlert");
      const errorMessage = document.getElementById("errorMessage");
      const successContainer = document.getElementById("successContainer");
      const previewContent = document.getElementById("previewContent");
      const downloadButton = document.getElementById("downloadButton");

      let selectedFile = null;
      let processedData = null;

      uploadArea.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length > 0) handleFileSelection(e.target.files[0]);
      });

      function handleFileSelection(file) {
        selectedFile = file;
        fileName.textContent = file.name;
        processButton.classList.remove("hidden");
        errorAlert.classList.add("hidden");
        successContainer.classList.add("hidden");
      }

      processButton.addEventListener("click", async () => {
        if (!selectedFile) return;

        processButton.disabled = true;
        processButton.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> LENDO...';

        try {
          const arrayBuffer = await selectedFile.arrayBuffer();
          const workbook = XLSX.read(arrayBuffer, { type: "array" });
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];

          // L√≥gica original: pula 5 linhas (cabe√ßalho na linha 6)
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {
            range: 5,
            raw: true,
            defval: "",
          });

          const rows = jsonData
            .filter((r) => r.dDatLanc && r.nVlrCred && r.nVlrCred !== 0)
            .map((row) => {
              let formattedDate = "";
              const dateValue = row.dDatLanc;

              if (dateValue instanceof Date) {
                formattedDate = `${String(dateValue.getDate()).padStart(
                  2,
                  "0"
                )}/${String(dateValue.getMonth() + 1).padStart(
                  2,
                  "0"
                )}/${dateValue.getFullYear()}`;
              } else if (typeof dateValue === "number") {
                const d = XLSX.SSF.parse_date_code(dateValue);
                formattedDate = `${String(d.d).padStart(2, "0")}/${String(
                  d.m
                ).padStart(2, "0")}/${d.y}`;
              } else {
                formattedDate = String(dateValue);
              }

              const val = Math.abs(Number(row.nVlrCred))
                .toFixed(2)
                .replace(".", ",");
              const desc = row.cDesHist
                ? String(row.cDesHist).replace(/\n/g, "")
                : "";
              const p1 = row.nCodClTbIP || "";
              const p2 = row.nCodClTbI || "";

              return `${formattedDate};${p1};${p2};${val};;${desc};;;;`;
            });

          if (rows.length === 0)
            throw new Error(
              "Nenhum dado v√°lido nas colunas dDatLanc/nVlrCred."
            );

          processedData = rows.join("\n");
          previewContent.textContent =
            rows.slice(0, 5).join("\n") + (rows.length > 5 ? "\n..." : "");
          successContainer.classList.remove("hidden");
          errorAlert.classList.add("hidden");
        } catch (err) {
          errorMessage.textContent = err.message;
          errorAlert.classList.remove("hidden");
        } finally {
          processButton.disabled = false;
          processButton.innerHTML =
            '<i class="fas fa-bolt"></i> PROCESSAR AGORA';
        }
      });

      downloadButton.addEventListener("click", () => {
        if (!processedData) return;
        const blob = new Blob([processedData], {
          type: "text/plain;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `IMPORT_CONTABIL_${Date.now()}.txt`;
        a.click();
      });
    </script>
  </body>
</html>
