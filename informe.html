<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consolidador DIRF - Análise Corporativa</title>

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <script>
      // Configuração do Worker do PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>

    <style>
      :root {
        /* Tema baseado no anexo (Reforma Tributária Panel) */
        --bg-app: #f2f2f0;
        --bg-surface: #fafafa;
        --bg-panel: #fafafa;
        --bg-sidebar: #fafafa;
        --bg-input: #f0f2f5;
        --bg-hover: #fcfcfd;

        --text-primary: #1e2130;
        --text-secondary: #5e6c84;
        --text-tertiary: #8f9bb3;

        --border-subtle: #edf1f7;
        --border-focus: #887cfd;
        --border-dashed: #3f3f46;

        --data-purple: #5347ce;
        --data-green: #16c8c7;
        --data-blue: #4896fe;
        --data-orange: #ffab00;
        --data-red: #ff5630;

        --badge-purple-bg: rgba(83, 71, 206, 0.12);
        --badge-green-bg: rgba(22, 200, 199, 0.12);
        --badge-blue-bg: rgba(72, 150, 254, 0.12);

        --radius-md: 16px;
        --shadow-card: 0px 4px 20px rgba(0, 0, 0, 0.05);

        --font-ui: "Inter", sans-serif;
        --font-code: "Roboto", sans-serif;
      }

      [data-theme="dark"] {
        --bg-app: #0f111a;
        --bg-surface: #1e2130;
        --bg-panel: #1e2130;
        --bg-sidebar: #151725;
        --bg-input: #151725;
        --bg-hover: #2a2e42;

        --text-primary: #ffffff;
        --text-secondary: #a0aec0;
        --text-tertiary: #718096;

        --border-subtle: #2d3748;
        --border-dashed: #4a5568;
      }

      * {
        box-sizing: border-box;
        outline: none;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-ui);
        background-color: var(--bg-app);
        color: var(--text-primary);
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar */
      .sidebar {
        width: 80px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border-subtle);
        padding: 2rem 1rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        z-index: 100;
        transition: width 0.3s ease;
      }
      .sidebar:hover {
        width: 240px;
        align-items: flex-start;
      }

      .logo {
        margin-bottom: 3rem;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .logo i {
        font-size: 24px;
        color: var(--data-purple);
        background: var(--badge-purple-bg);
        padding: 8px;
        border-radius: 8px;
      }
      .logo-text {
        display: none;
        font-weight: 700;
        font-size: 16px;
        white-space: nowrap;
      }
      .sidebar:hover .logo-text {
        display: block;
      }

      .nav-item {
        width: 100%;
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        border-radius: 8px;
        cursor: pointer;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
      }
      .nav-item:hover,
      .nav-item.active {
        background: var(--badge-purple-bg);
        color: var(--data-purple);
      }
      .nav-item span {
        display: none;
        font-weight: 500;
        white-space: nowrap;
      }
      .sidebar:hover .nav-item span {
        display: block;
      }

      /* Main Content */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 2rem;
        overflow-y: auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }
      .header h1 {
        font-size: 24px;
        font-weight: 600;
        letter-spacing: -0.02em;
      }

      .kpi-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .card {
        background: var(--bg-surface);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        box-shadow: var(--shadow-card);
        position: relative;
      }

      .kpi-title {
        font-size: 12px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 0.5rem;
      }
      .kpi-value {
        font-size: 24px;
        font-weight: 700;
        font-family: var(--font-code);
        letter-spacing: -0.02em;
      }
      .c-purple {
        color: var(--data-purple);
      }
      .c-green {
        color: var(--data-green);
      }
      .c-blue {
        color: var(--data-blue);
      }
      .c-orange {
        color: var(--data-orange);
      }

      /* Upload Area */
      .upload-area {
        background: var(--bg-panel);
        border: 2px dashed var(--border-dashed);
        border-radius: var(--radius-md);
        padding: 2rem;
        text-align: center;
        margin-bottom: 2rem;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }
      .upload-area:hover {
        border-color: var(--data-blue);
        background: var(--bg-hover);
      }
      #fileInput {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      /* Table */
      .table-container {
        background: var(--bg-surface);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-card);
        overflow: hidden;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th {
        background: var(--bg-input);
        padding: 1rem;
        text-align: left;
        color: var(--text-secondary);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 11px;
        position: sticky;
        top: 0;
      }
      td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-subtle);
        color: var(--text-primary);
      }
      tr:last-child td {
        border-bottom: none;
      }
      td.money {
        text-align: right;
        font-family: var(--font-code);
        font-variant-numeric: tabular-nums;
      }
      tr.total-row {
        background: var(--badge-purple-bg);
        font-weight: 700;
      }
      tr.total-row td {
        color: var(--data-purple);
      }

      /* Utils */
      .btn {
        background: var(--data-purple);
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: transform 0.1s;
      }
      .btn:active {
        transform: scale(0.98);
      }
      .hidden {
        display: none;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
        color: white;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div id="loading" class="loading-overlay">
      <i
        class="fas fa-circle-notch fa-spin"
        style="font-size: 3rem; margin-bottom: 1rem"
      ></i>
      <h3 id="loadingText">Processando PDF...</h3>
    </div>

    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-file-invoice-dollar"></i>
        <div class="logo-text">DIRF MASTER</div>
      </div>
      <div class="nav-item active">
        <i class="fas fa-chart-pie"></i>
        <span>Visão Geral</span>
      </div>
      <div class="nav-item" onclick="exportExcel()">
        <i class="fas fa-file-excel"></i>
        <span>Exportar Excel</span>
      </div>
      <div class="nav-item" onclick="location.reload()">
        <i class="fas fa-trash-alt"></i>
        <span>Limpar Tudo</span>
      </div>
    </aside>

    <main class="main-content">
      <div class="header">
        <h1>Consolidação DIRF Anual</h1>
        <button
          class="btn"
          onclick="document.getElementById('themeToggle').click()"
        >
          <i class="fas fa-adjust"></i> Tema
        </button>
        <div id="themeToggle" class="hidden" onclick="toggleTheme()"></div>
      </div>

      <div class="kpi-grid">
        <div class="card">
          <div class="kpi-title">Funcionários Processados</div>
          <div class="kpi-value c-purple" id="totalFuncionarios">0</div>
        </div>
        <div class="card">
          <div class="kpi-title">Total Rendimentos Tributáveis</div>
          <div class="kpi-value c-blue" id="totalRendimentos">R$ 0,00</div>
        </div>
        <div class="card">
          <div class="kpi-title">Total Imposto Retido</div>
          <div class="kpi-value c-red" id="totalImposto">R$ 0,00</div>
        </div>
        <div class="card">
          <div class="kpi-title">Total Previdência Oficial</div>
          <div class="kpi-value c-green" id="totalPrev">R$ 0,00</div>
        </div>
      </div>

      <div class="upload-area" id="dropZone">
        <input
          type="file"
          id="fileInput"
          accept=".pdf"
          onchange="handleFile(this.files[0])"
        />
        <i
          class="fas fa-cloud-upload-alt"
          style="
            font-size: 48px;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
          "
        ></i>
        <h3 style="color: var(--text-primary)">
          Arraste seu arquivo PDF (DIRF) aqui
        </h3>
        <p
          style="
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 0.5rem;
          "
        >
          O processamento é feito localmente. Seus dados não saem do navegador.
        </p>
      </div>

      <div class="table-container" id="resultContainer" style="display: none">
        <table id="mainTable">
          <thead>
            <tr>
              <th>Mês</th>
              <th class="money">Rend. Tributável</th>
              <th class="money">Dedução Simpl.</th>
              <th class="money">Prev. Oficial</th>
              <th class="money">Prev. Complem.</th>
              <th class="money">Prev. FAPI</th>
              <th class="money">Dependentes</th>
              <th class="money">Pensão Alim.</th>
              <th class="money">Imposto Retido</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </main>

    <script>
      // === Lógica de Estado ===
      const MESES = [
        "Janeiro",
        "Fevereiro",
        "Março",
        "Abril",
        "Maio",
        "Junho",
        "Julho",
        "Agosto",
        "Setembro",
        "Outubro",
        "Novembro",
        "Dezembro",
        "13° Salário",
      ];

      let dadosConsolidados = {};
      let totalFuncionarios = 0;

      // Inicializa estrutura de dados
      function initDados() {
        MESES.forEach((mes) => {
          dadosConsolidados[mes] = Array(8).fill(0); // 8 colunas de valores
        });
        totalFuncionarios = 0;
      }

      // === Lógica de UI ===
      function toggleTheme() {
        if (document.body.getAttribute("data-theme") === "dark") {
          document.body.removeAttribute("data-theme");
        } else {
          document.body.setAttribute("data-theme", "dark");
        }
      }

      function showLoading(show, msg) {
        const el = document.getElementById("loading");
        const txt = document.getElementById("loadingText");
        if (show) {
          el.style.display = "flex";
          txt.innerText = msg || "Processando...";
        } else {
          el.style.display = "none";
        }
      }

      function formatMoney(val) {
        return val.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      // === Lógica de Processamento do PDF ===

      // Função auxiliar para converter string PT-BR (1.234,56 ou 1.234.56 ou 1234,56) para float
      function parseBrlFloat(str) {
        if (!str || str.trim() === "") return 0;
        let clean = str.replace(/\s/g, ""); // Remove espaços

        // Detecção de anomalia de OCR (ex: 4.273.46 -> deveria ser 4273.46 ou 4.273,46)
        // Se houver dois pontos e nenhuma vírgula, e o último ponto estiver a 2 casas do fim
        if ((clean.match(/\./g) || []).length > 1 && !clean.includes(",")) {
          // Remove todos os pontos exceto o último
          const parts = clean.split(".");
          const decimal = parts.pop();
          const integer = parts.join("");
          return parseFloat(integer + "." + decimal);
        }

        // Padrão normal: remover pontos de milhar, trocar virgula decimal por ponto
        // Cuidado com OCR que lê 189.59 (ponto como decimal)
        if (clean.includes(".") && !clean.includes(",")) {
          // Se tem ponto e não tem vírgula
          // Se tem apenas 2 decimais após o ponto, assume ponto decimal
          if (/\.\d{2}$/.test(clean)) {
            return parseFloat(clean);
          }
        }

        clean = clean.replace(/\./g, ""); // Remove milhar
        clean = clean.replace(",", "."); // Decimal

        // Tratamento de .00 no inicio (ex: .00 -> 0.00)
        if (clean.startsWith(".")) clean = "0" + clean;

        const val = parseFloat(clean);
        return isNaN(val) ? 0 : val;
      }

      async function handleFile(file) {
        if (!file) return;

        initDados();
        showLoading(true, "Lendo PDF...");

        const reader = new FileReader();
        reader.onload = async function (e) {
          try {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;

            showLoading(true, `Processando ${pdf.numPages} páginas...`);

            // Set para contar CPFs únicos (funcionários)
            const cpfsProcessados = new Set();

            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();

              // Reconstrói as linhas baseadas na posição Y
              const lines = groupTextByLines(textContent.items);

              // Processa as linhas da página
              processPageLines(lines, cpfsProcessados);
            }

            totalFuncionarios = cpfsProcessados.size;
            renderResults();
            showLoading(false);
          } catch (error) {
            console.error(error);
            alert("Erro ao processar PDF: " + error.message);
            showLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
      }

      // Agrupa itens de texto que estão na mesma altura (Y) com tolerância
      function groupTextByLines(items) {
        const lines = [];
        const tolerance = 4; // Tolerância de pixels para considerar mesma linha

        // Ordena por Y (decrescente - PDF coord system), depois por X
        items.sort((a, b) => {
          if (Math.abs(a.transform[5] - b.transform[5]) > tolerance) {
            return b.transform[5] - a.transform[5]; // Topo para baixo
          }
          return a.transform[4] - b.transform[4]; // Esquerda para direita
        });

        let currentLine = [];
        let currentY = null;

        items.forEach((item) => {
          if (
            currentY === null ||
            Math.abs(item.transform[5] - currentY) > tolerance
          ) {
            if (currentLine.length > 0) lines.push(currentLine);
            currentLine = [];
            currentY = item.transform[5];
          }
          currentLine.push(item.str);
        });
        if (currentLine.length > 0) lines.push(currentLine);

        return lines;
      }

      function processPageLines(lines, cpfSet) {
        let isMainTable = false;
        let foundBeneficiario = false;

        for (let i = 0; i < lines.length; i++) {
          const lineStr = lines[i].join(" ").trim();

          // Captura CPF para contagem
          if (lineStr.includes("CPF:") && !foundBeneficiario) {
            // Tenta extrair CPF simples
            const match = lineStr.match(/CPF:\s*([\d\.-]+)/);
            if (match) {
              // Verifica se não é o CPF da empresa responsável (geralmente aparece no topo)
              // No layout enviado, tem "CPF responsável empresa" e "INFORMAÇÃO DO BENEFICIÁRIO... CPF:"
              // Vamos assumir que se estiver perto de "BENEFICIÁRIO", é funcionário
              cpfSet.add(match[1]);
              foundBeneficiario = true;
            }
          }

          // Detecta cabeçalho da tabela principal
          if (
            lineStr.includes("Rend. Tributável") &&
            lineStr.includes("Imposto Retido")
          ) {
            isMainTable = true;
            continue;
          }

          // Se saiu da tabela (encontrou outro cabeçalho grande)
          if (
            isMainTable &&
            (lineStr.includes("RENDIMENTOS ISENTOS") ||
              lineStr.includes("INFORMAÇÕES"))
          ) {
            isMainTable = false;
          }

          // Processa linha de dados
          if (isMainTable) {
            // Verifica se a linha começa com um mês válido
            const mesMatch = MESES.find(
              (m) =>
                lineStr.startsWith(m) ||
                lineStr.startsWith(m.replace("°", "º")),
            ); // Compatibilidade 13° vs 13º

            if (mesMatch) {
              // Limpa o nome do mês para sobrar só números
              let valuesStr = lineStr.substring(mesMatch.length).trim();

              // Separa os valores por espaço
              // O PDF.js às vezes junta números ou separa casas decimais.
              // Estratégia: Usar as strings originais da linha (lines[i]) exceto a primeira que é o mês

              const rawValues = lines[i].slice(1); // Pula o nome do mês

              // Filtra apenas o que parece número ou ".00"
              const numericValues = rawValues.filter(
                (v) => /[\d\.,]+/.test(v) && v.trim().length > 0,
              );

              // Mapeia para float e acumula
              // A tabela tem 8 colunas de valores após o mês:
              // 1. Rend. Tributável
              // 2. Dedução Simpl.
              // 3. Prev. Oficial
              // 4. Prev. Complem.
              // 5. Prev. FAPI
              // 6. Dependentes
              // 7. Pensão Alimentícia
              // 8. Imposto Retido

              if (numericValues.length >= 8) {
                // Pega os primeiros 8 valores encontrados (ignora lixo no final da linha)
                for (let col = 0; col < 8; col++) {
                  const val = parseBrlFloat(numericValues[col]);
                  // Normaliza chave do mês (13°)
                  let mesKey = mesMatch;
                  if (mesKey.includes("13")) mesKey = "13° Salário";

                  dadosConsolidados[mesKey][col] += val;
                }
              }
            }
          }
        }
      }

      // === Renderização ===
      function renderResults() {
        document.getElementById("resultContainer").style.display = "block";
        document.getElementById("dropZone").style.display = "none";

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        let grandTotal = Array(8).fill(0);

        // Atualiza KPIs
        document.getElementById("totalFuncionarios").innerText =
          totalFuncionarios;

        MESES.forEach((mes) => {
          const vals = dadosConsolidados[mes];
          const tr = document.createElement("tr");

          let tdMes = `<td>${mes}</td>`;
          let tdVals = "";

          vals.forEach((v, idx) => {
            tdVals += `<td class="money">${formatMoney(v)}</td>`;
            grandTotal[idx] += v;
          });

          tr.innerHTML = tdMes + tdVals;
          tbody.appendChild(tr);
        });

        // Linha de Total
        const trTotal = document.createElement("tr");
        trTotal.className = "total-row";
        let tdTotalLabel = `<td>TOTAL ANUAL</td>`;
        let tdTotalVals = "";
        grandTotal.forEach((v) => {
          tdTotalVals += `<td class="money">${formatMoney(v)}</td>`;
        });
        trTotal.innerHTML = tdTotalLabel + tdTotalVals;
        tbody.appendChild(trTotal);

        // Atualiza KPIs Financeiros
        document.getElementById("totalRendimentos").innerText = formatMoney(
          grandTotal[0],
        );
        document.getElementById("totalImposto").innerText = formatMoney(
          grandTotal[7],
        );
        document.getElementById("totalPrev").innerText = formatMoney(
          grandTotal[2],
        );
      }

      function exportExcel() {
        if (totalFuncionarios === 0) {
          alert("Processe um arquivo primeiro.");
          return;
        }

        const wb = XLSX.utils.book_new();
        const ws_data = [
          [
            "Mês",
            "Rend. Tributável",
            "Dedução Simpl.",
            "Prev. Oficial",
            "Prev. Complem.",
            "Prev. FAPI",
            "Dependentes",
            "Pensão Alim.",
            "Imposto Retido",
          ],
        ];

        MESES.forEach((mes) => {
          const row = [mes, ...dadosConsolidados[mes]];
          ws_data.push(row);
        });

        // Adiciona totais no array de dados
        let totalRow = ["TOTAL ANUAL"];
        for (let i = 0; i < 8; i++) {
          let sum = 0;
          MESES.forEach((m) => (sum += dadosConsolidados[m][i]));
          totalRow.push(sum);
        }
        ws_data.push(totalRow);

        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Consolidado DIRF");
        XLSX.writeFile(wb, "Consolidado_DIRF.xlsx");
      }
    </script>
  </body>
</html>
