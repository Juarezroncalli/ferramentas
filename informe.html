<!DOCTYPE html>
<html class="dark" lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>DIRF Master - High-Density Dashboard</title>
    
    <!-- Scripts Externos -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#8c25f4",
              "accent-cyan": "#00f2ff",
              "background-dark": "#060608",
              "card-dark": "rgba(26, 26, 36, 0.45)",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"],
              "mono": ["'Inter'", "monospace"]
            },
            borderRadius: {
              "DEFAULT": "0.25rem",
              "lg": "0.5rem",
              "xl": "0.75rem",
              "2xl": "1rem",
              "full": "9999px"
            },
          },
        },
      }
    </script>
    
    <script>
      // Configuração do Worker do PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>
    
    <style type="text/tailwindcss">
      :root {
          --glass-border: rgba(255, 255, 255, 0.08);
          --glass-bg: rgba(26, 26, 36, 0.6);
      }
      body {
        font-family: 'Inter', sans-serif;
        background: radial-gradient(circle at 50% 0%, #160d26 0%, #060608 100%);
        min-height: 100vh;
        scroll-behavior: smooth;
      }
      .font-mono {
        font-family: monospace; /* Força uso da mono do sistema/navegador ao invés de webfont que corte o zero */
      }
      .glass-panel {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
      }
      .custom-scrollbar::-webkit-scrollbar {
        height: 6px;
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #3a3a4a;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #8c25f4;
      }
      .loading-overlay {
        backdrop-filter: blur(12px);
      }
      
      .data-cell {
        border-right: 1px solid rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
      }
      .data-cell:last-child {
        border-right: none;
      }

      /* --- Sistema de Animações --- */
      @keyframes revealUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-reveal {
        animation: revealUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        opacity: 0;
      }

      .card-hover {
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }
      .card-hover:hover {
        transform: translateY(-4px);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5);
        border-color: rgba(140, 37, 244, 0.4);
      }

      .upload-pulse {
        animation: pulse-soft 3s ease-in-out infinite;
      }
      @keyframes pulse-soft {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.05); opacity: 0.8; }
      }
    </style>
  </head>
  
  <body class="bg-background-dark text-slate-100 antialiased font-display overflow-hidden">
    
    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center bg-background-dark/80 loading-overlay transition-opacity duration-500 opacity-0">
      <div class="size-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
      <h3 id="loadingText" class="text-xl font-medium text-white font-mono">Processando PDF...</h3>
    </div>

    <div class="flex h-screen overflow-hidden">
      <!-- Sidebar Navigation (Estilo code.html) -->
      <aside class="flex flex-col items-center py-6 w-20 glass-panel m-4 rounded-2xl border-white/5 shrink-0 z-50">
        <div class="mb-10 text-accent-cyan">
          <span class="material-symbols-outlined text-3xl">grid_view</span>
        </div>
        
        <nav class="flex flex-col gap-6 flex-1">
          <button onclick="location.reload()" class="p-3 rounded-xl bg-primary/20 text-primary shadow-lg transition-all" title="Visão Geral">
            <span class="material-symbols-outlined">analytics</span>
          </button>
          
          <button onclick="switchTab('individual')" class="p-3 rounded-xl hover:bg-white/5 text-slate-500 hover:text-white transition-all" title="Indivíduos">
            <span class="material-symbols-outlined">groups</span>
          </button>

          <button onclick="exportExcel()" class="p-3 rounded-xl hover:bg-white/5 text-slate-500 hover:text-white transition-all" title="Exportar Excel">
            <span class="material-symbols-outlined">file_download</span>
          </button>

          <button onclick="limparDados()" class="p-3 rounded-xl hover:bg-white/5 text-slate-400 hover:text-rose-500 transition-all" title="Limpar Dados">
            <span class="material-symbols-outlined">delete_forever</span>
          </button>
        </nav>
        
        <div class="mt-auto flex flex-col gap-5">
          <div class="size-10 rounded-full border border-white/10 overflow-hidden bg-slate-800 flex items-center justify-center" title="J.Roncalli">
            <span class="material-symbols-outlined text-primary text-xl">code</span>
          </div>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col overflow-hidden p-4 lg:p-6 space-y-6">
      
      <!-- Header (Estilo code.html) -->
      <header class="flex items-center justify-between px-2">
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-white flex items-center gap-3">
            DIRF Master <span class="text-xs font-mono text-accent-cyan bg-accent-cyan/10 px-2 py-0.5 rounded border border-accent-cyan/20">2026.v1</span>
          </h1>
          <div class="mt-2 flex items-center gap-2" id="nomeEmpresaDisplay">
            <span class="text-[10px] font-bold text-slate-500 tracking-widest uppercase">Declarante</span>
            <span class="text-xs font-bold text-white bg-white/10 px-2.5 py-1 rounded-md border border-white/20">Aguardando Processamento...</span>
          </div>
        </div>
        
        <div class="flex items-center gap-4 flex-1 max-w-lg mx-8">
          <div class="relative w-full">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">search</span>
            <input 
              id="searchInput"
              oninput="handleSearch(this.value)"
              class="w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-2 focus:ring-1 focus:ring-primary text-xs transition-all placeholder:text-slate-600 outline-none hover:bg-white/10" 
              placeholder="Buscar por funcionário ou CPF..." 
              type="text"
            />
          </div>
        </div>

        <div class="flex items-center gap-3">
          <button 
            onclick="togglePrivacy()" 
            id="privacyToggle"
            class="p-2 rounded-lg bg-white/5 border border-white/10 text-slate-400 hover:text-white transition-all group"
            title="Modo Privacidade"
          >
            <span class="material-symbols-outlined text-sm" id="privacyIcon">visibility</span>
          </button>
          <button onclick="exportExcel()" class="bg-primary hover:bg-primary/80 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
            <span class="material-symbols-outlined text-sm">download</span>
            EXPORTAR
          </button>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar space-y-6 pr-2">
        
        <!-- Metrics Bento Grid (Estilo code.html) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 animate-reveal">
          <!-- Total Funcionários -->
          <div class="glass-panel rounded-xl p-4 flex flex-col justify-between border-l-2 border-l-primary group">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Funcionários</p>
            <div class="mt-1">
              <h3 class="text-4xl xl:text-5xl font-display font-black tracking-tighter text-white" id="totalFuncionarios">0</h3>
              <p class="text-[10px] font-bold text-accent-cyan mt-1">NODES ATIVOS</p>
            </div>
          </div>

          <!-- Total Rendimentos -->
          <div class="glass-panel rounded-xl p-4 flex flex-col justify-between border-l-2 border-l-emerald-400 group">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Rend. Tributáveis</p>
            <div class="mt-1">
              <h3 class="text-3xl xl:text-4xl font-display font-black tracking-tighter text-white truncate" id="totalRendimentos">R$ 0,00</h3>
              <p class="text-[10px] font-bold text-emerald-400 mt-1">BRUTO ACUMULADO</p>
            </div>
          </div>

          <!-- Total Imposto -->
          <div class="glass-panel rounded-xl p-4 flex flex-col justify-between border-l-2 border-l-rose-500 group">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Imposto Retido</p>
            <div class="mt-1">
              <h3 class="text-3xl xl:text-4xl font-display font-black tracking-tighter text-white truncate" id="totalImposto">R$ 0,00</h3>
              <p class="text-[10px] font-bold text-rose-500 mt-1">IRRF TOTAL</p>
            </div>
          </div>

          <!-- Total Previdência -->
          <div class="glass-panel rounded-xl p-4 flex flex-col justify-between border-l-2 border-l-amber-500 group">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Previdência</p>
            <div class="mt-1">
              <h3 class="text-3xl xl:text-4xl font-display font-black tracking-tighter text-white truncate" id="totalPrev">R$ 0,00</h3>
              <p class="text-[10px] font-bold text-amber-500 mt-1">OFICIAL/COMPL.</p>
            </div>
          </div>
        </div>

        <!-- Upload Section (Glassmorphism) -->
        <div id="uploadSection" class="glass-panel rounded-2xl border-2 border-dashed border-white/10 p-12 transition-all hover:border-primary/50 group relative animate-reveal">
          <input
            type="file"
            id="fileInput"
            accept=".pdf"
            onchange="handleFile(this.files[0])"
            class="absolute inset-0 opacity-0 cursor-pointer z-10"
          />
          <div class="flex flex-col items-center justify-center text-center space-y-4">
            <div class="size-20 rounded-full bg-primary/10 text-primary flex items-center justify-center group-hover:scale-110 transition-all duration-500 upload-pulse border border-primary/20">
              <span class="material-symbols-outlined text-4xl">cloud_upload</span>
            </div>
            <div>
              <h3 class="text-xl font-bold group-hover:text-primary transition-colors">Processar Dados DIRF</h3>
              <p class="text-slate-500 text-xs font-mono max-w-sm mt-2">UPLOAD SEU PDF PARA ANÁLISE QUANTUM-S2 LOCAL</p>
            </div>
          </div>
        </div>

        <!-- Tabs Section -->
        <div id="tabsContainer" class="hidden flex gap-2 p-1 bg-white/5 border border-white/10 rounded-xl w-fit">
          <button onclick="switchTab('consolidado')" id="tab-consolidado" class="px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all bg-primary text-white shadow-lg">Consolidado</button>
          <button onclick="switchTab('individual')" id="tab-individual" class="px-6 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-widest transition-all text-slate-500 hover:text-white">Individual</button>
        </div>

        <!-- Results Table Section (Consolidado) -->
        <div id="resultContainer" class="hidden flex-1 glass-panel rounded-xl overflow-hidden flex flex-col">
          <div class="p-3 border-b border-white/5 bg-white/5 flex items-center justify-between">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Detalhamento Mensal Consolidado</span>
            <div class="flex gap-2">
              <button onclick="exportExcel()" class="p-1 text-slate-400 hover:text-white" title="Exportar"><span class="material-symbols-outlined text-sm">spreadsheet</span></button>
            </div>
          </div>
          
          <div class="overflow-auto flex-1 custom-scrollbar">
            <table id="mainTable" class="w-full border-collapse text-[20px] font-display font-bold tracking-tight">
              <thead class="sticky top-0 z-20 bg-background-dark/90 backdrop-blur-md">
                <tr>
                  <th class="p-3 text-left border-b border-r border-white/10 text-slate-500 font-bold bg-white/5 min-w-[150px]">MÊS REF</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">REND. TRIB.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">DED. SIMPL.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PREV. OFIC.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PREV. COMPL.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PREV. FAPI</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">DEPEND.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PENSÃO ALIM.</th>
                  <th class="p-3 text-right border-b border-white/10 text-slate-500 font-bold text-accent-cyan">IRRF RETIDO</th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-white/5">
                <!-- Linhas geradas via JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Individual Table Section -->
        <div id="individualContainer" class="hidden flex-1 glass-panel rounded-xl overflow-hidden flex flex-col">
          <div class="p-3 border-b border-white/5 bg-white/5 flex items-center justify-between">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.2em]">Lista de Beneficiários</span>
          </div>
          <div class="overflow-auto flex-1 custom-scrollbar">
            <table id="individualTable" class="w-full border-collapse text-[16px] font-display font-bold tracking-tight">
              <thead class="sticky top-0 z-20 bg-background-dark/90 backdrop-blur-md">
                <tr>
                  <th class="p-3 text-left border-b border-r border-white/10 text-slate-500 font-bold bg-white/5 sticky left-0 z-30">CPF</th>
                  <th class="p-3 text-left border-b border-r border-white/10 text-slate-500 font-bold bg-white/5 sticky left-[100px] z-30 min-w-[200px]">BENEFICIÁRIO</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">REND. TRIB.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">DED. SIMP.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PREV. OFIC.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PREV. COMP.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PREV. FAPI</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">DEPEND.</th>
                  <th class="p-3 text-right border-b border-r border-white/10 text-slate-500 font-bold">PENSÃO.</th>
                  <th class="p-3 text-right border-b border-white/10 text-slate-500 font-bold text-accent-cyan">IRRF.</th>
                </tr>
              </thead>
              <tbody id="individualBody" class="divide-y divide-white/5">
              </tbody>
            </table>
          </div>
        </div>

        <!-- System Info Footer -->
        <footer class="flex items-center justify-between text-[10px] text-slate-600 font-mono tracking-wider pt-4">
          <div class="flex gap-6">
            <span class="flex items-center gap-1.5"><span class="size-1.5 rounded-full bg-accent-cyan animate-pulse"></span> LEDGER LIVE: DIRF-SECURE-V1</span>
            <span>VERIFICATION: LOCAL-QUANTUM</span>
          </div>
          <div class="flex gap-4">
            <span class="text-slate-500 uppercase">Processamento 100% Client-Side</span>
          </div>
        </footer>
      </div>
    </main>
  </div>

    <script>
      // === Lógica de Estado ===
      const MESES = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro",
        "13° Salário"
      ];

      let dadosConsolidados = {};
      let detalhesPorFuncionario = {}; // { cpf: { nome: "", totais: [8 vals] } }
      let totalFuncionarios = 0;
      let nomeEmpresa = "";
      let privacyMode = localStorage.getItem('privacy_mode') === 'true';
      let currentTab = 'consolidado';

      function initDados() {
        MESES.forEach((mes) => {
          dadosConsolidados[mes] = Array(8).fill(0);
        });
        detalhesPorFuncionario = {};
        totalFuncionarios = 0;
        nomeEmpresa = "";
      }

      function limparDados() {
        if (confirm("Deseja realmente apagar todos os dados processados e resetar o sistema?")) {
          localStorage.removeItem('dirf_data');
          initDados();
          location.reload();
        }
      }

      function saveToLocal() {
        const data = {
          dadosConsolidados,
          detalhesPorFuncionario,
          totalFuncionarios,
          nomeEmpresa,
          lastUpdated: new Date().getTime()
        };
        localStorage.setItem('dirf_data', JSON.stringify(data));
      }

      function loadFromLocal() {
        const saved = localStorage.getItem('dirf_data');
        if (saved) {
          const data = JSON.parse(saved);
          dadosConsolidados = data.dadosConsolidados;
          detalhesPorFuncionario = data.detalhesPorFuncionario;
          totalFuncionarios = data.totalFuncionarios;
          nomeEmpresa = data.nomeEmpresa;
          renderResults();
        }
        updatePrivacyUI();
      }

      function togglePrivacy() {
        privacyMode = !privacyMode;
        localStorage.setItem('privacy_mode', privacyMode);
        updatePrivacyUI();
        renderResults();
      }

      function updatePrivacyUI() {
        const icon = document.getElementById('privacyIcon');
        icon.innerText = privacyMode ? 'visibility_off' : 'visibility';
        const btn = document.getElementById('privacyToggle');
        if (privacyMode) {
          btn.classList.add('bg-primary/20', 'text-primary');
        } else {
          btn.classList.remove('bg-primary/20', 'text-primary');
        }
      }

      function formatMoney(val) {
        if (privacyMode) return "R$ ••••••";
        return val.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      window.onload = loadFromLocal;

      function showLoading(show, msg) {
        const el = document.getElementById("loading");
        const txt = document.getElementById("loadingText");
        if (show) {
          el.classList.remove("opacity-0", "pointer-events-none");
          el.classList.remove("hidden");
          el.classList.add("flex");
          txt.innerText = msg || "Processando...";
        } else {
          el.classList.add("opacity-0", "pointer-events-none");
          setTimeout(() => {
            el.classList.add("hidden");
            el.classList.remove("flex");
          }, 500);
        }
      }

      function animateValue(id, start, end, duration, isMoney = false) {
        const obj = document.getElementById(id);
        if (!obj) return;
        
        // Remove symbols for calculation
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          const current = progress * (end - start) + start;
          
          if (isMoney) {
            obj.innerText = formatMoney(current);
          } else {
            obj.innerText = Math.floor(current).toLocaleString();
          }
          
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }

      // Função auxiliar para converter string PT-BR para float
      function parseBrlFloat(str) {
        if (!str || str.trim() === "") return 0;
        let clean = str.replace(/\s/g, "");
        if ((clean.match(/\./g) || []).length > 1 && !clean.includes(",")) {
          const parts = clean.split(".");
          const decimal = parts.pop();
          const integer = parts.join("");
          return parseFloat(integer + "." + decimal);
        }
        if (clean.includes(".") && !clean.includes(",")) {
          if (/\.\d{2}$/.test(clean)) return parseFloat(clean);
        }
        clean = clean.replace(/\./g, "").replace(",", ".");
        if (clean.startsWith(".")) clean = "0" + clean;
        const val = parseFloat(clean);
        return isNaN(val) ? 0 : val;
      }

      async function handleFile(file) {
        if (!file) return;
        initDados();
        showLoading(true, "Lendo PDF...");
        const reader = new FileReader();
        reader.onload = async function () {
          try {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            showLoading(true, `Processando ${pdf.numPages} páginas...`);
            const cpfsProcessados = new Set();
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const lines = groupTextByLines(textContent.items);
              processPageLines(lines, cpfsProcessados);
            }
            totalFuncionarios = cpfsProcessados.size;
            renderResults();
            showLoading(false);
          } catch (error) {
            console.error(error);
            alert("Erro ao processar PDF: " + error.message);
            showLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function groupTextByLines(items) {
        const lines = [];
        const tolerance = 4;
        items.sort((a, b) => {
          if (Math.abs(a.transform[5] - b.transform[5]) > tolerance) return b.transform[5] - a.transform[5];
          return a.transform[4] - b.transform[4];
        });
        let currentLine = [];
        let currentY = null;
        items.forEach((item) => {
          if (currentY === null || Math.abs(item.transform[5] - currentY) > tolerance) {
            if (currentLine.length > 0) lines.push(currentLine);
            currentLine = [];
            currentY = item.transform[5];
          }
          currentLine.push(item.str);
        });
        if (currentLine.length > 0) lines.push(currentLine);
        return lines;
      }

      function processPageLines(lines, cpfSet) {
        let isMainTable = false;
        let currentCpf = null;
        let currentNome = null;

        for (let i = 0; i < lines.length; i++) {
          const lineStr = lines[i].join(" ").trim();

          // Extração do Nome da Empresa (Declarante)
          if (!nomeEmpresa && (lineStr.includes("Nome empresarial") || lineStr.includes("NOME EMPRESARIAL") || lineStr.includes("Nome da fonte pagadora") || lineStr.startsWith("Empresa:"))) {
            let potentialName = "";
            if (lineStr.includes(":")) {
               potentialName = lineStr.split(":")[1].trim();
            } else {
               const keywords = ["Nome empresarial", "NOME EMPRESARIAL", "Nome da fonte pagadora", "Empresa"];
               for (let key of keywords) {
                 if (lineStr.includes(key)) {
                    potentialName = lineStr.substring(lineStr.indexOf(key) + key.length).trim();
                    break;
                 }
               }
            }
            if (potentialName && potentialName.length > 3) nomeEmpresa = potentialName;
            else if (i + 1 < lines.length) nomeEmpresa = lines[i+1].join(" ").trim();
          }

          // Busca CPF e Nome do Beneficiário
          if (lineStr.includes("CPF:")) {
            const cpfMatch = lineStr.match(/CPF:\s*([\d\.-]+)/);
            const nomeMatch = lineStr.match(/Nome:\s*(.+)$/);
            
            if (cpfMatch) {
              currentCpf = cpfMatch[1].trim();
              cpfSet.add(currentCpf);
              if (!detalhesPorFuncionario[currentCpf]) {
                detalhesPorFuncionario[currentCpf] = {
                  nome: nomeMatch ? nomeMatch[1].trim() : "Não Identificado",
                  totais: Array(8).fill(0)
                };
              }
            }
          }

          if (lineStr.includes("Rend. Tributável") && lineStr.includes("Imposto Retido")) {
            isMainTable = true; continue;
          }
          if (isMainTable && (lineStr.includes("RENDIMENTOS ISENTOS") || lineStr.includes("INFORMAÇÕES"))) {
            isMainTable = false;
          }
          if (isMainTable) {
            const mesMatch = MESES.find(m => lineStr.startsWith(m) || lineStr.startsWith(m.replace("°", "º")));
            if (mesMatch && currentCpf) {
              const rawValues = lines[i].slice(1);
              const numericValues = rawValues.filter(v => /[\d\.,]+/.test(v) && v.trim().length > 0);
              if (numericValues.length >= 8) {
                for (let col = 0; col < 8; col++) {
                  const val = parseBrlFloat(numericValues[col]);
                  let mesKey = mesMatch.includes("13") ? "13° Salário" : mesMatch;
                  dadosConsolidados[mesKey][col] += val;
                  detalhesPorFuncionario[currentCpf].totais[col] += val;
                }
              }
            }
          }
        }
      }

      function switchTab(tab) {
        currentTab = tab;
        const tabs = ['consolidado', 'individual'];
        tabs.forEach(t => {
          const btn = document.getElementById(`tab-${t}`);
          const container = t === 'consolidado' ? document.getElementById('resultContainer') : document.getElementById('individualContainer');
          
          if (t === tab) {
            btn.classList.add('bg-primary', 'text-white', 'shadow-lg');
            btn.classList.remove('text-slate-500');
            if (container) container.classList.remove('hidden');
          } else {
            btn.classList.remove('bg-primary', 'text-white', 'shadow-lg');
            btn.classList.add('text-slate-500');
            if (container) container.classList.add('hidden');
          }
        });
      }

      function handleSearch(query) {
        query = query.toLowerCase();
        renderIndividualBody(query);
        if (query && currentTab !== 'individual') {
          switchTab('individual');
        }
      }

      function renderIndividualBody(filter = "") {
        const tbody = document.getElementById("individualBody");
        if (!tbody) return;
        tbody.innerHTML = "";
        
        let delay = 0;
        Object.keys(detalhesPorFuncionario).forEach(cpf => {
          const func = detalhesPorFuncionario[cpf];
          if (cpf.includes(filter) || func.nome.toLowerCase().includes(filter)) {
            const tr = document.createElement("tr");
            tr.className = "group hover:bg-white/5 animate-reveal";
            tr.style.animationDelay = `${delay}ms`;
            delay = Math.min(delay + 10, 200);
            
            let cellsHtml = `
              <td class="p-3 font-bold text-slate-300 border-r border-white/5 sticky left-0 bg-[#0c0c12] z-20">${cpf}</td>
              <td class="p-3 font-bold text-slate-300 border-r border-white/5 sticky left-[100px] bg-[#0c0c12] z-20">${func.nome}</td>
            `;

            func.totais.forEach((v, idx) => {
              let colorClass = "text-white";
              if (idx === 7) colorClass = "text-accent-cyan";
              cellsHtml += `<td class="p-3 text-right data-cell ${colorClass}">${formatMoney(v)}</td>`;
            });

            tr.innerHTML = cellsHtml;
            tbody.appendChild(tr);
          }
        });
      }

      function renderResults() {
        if (document.getElementById("uploadSection")) document.getElementById("uploadSection").classList.add("hidden");
        if (document.getElementById("tabsContainer")) document.getElementById("tabsContainer").classList.remove("hidden");
        switchTab(currentTab);
        
        if (nomeEmpresa) {
          const empresaDisplay = document.getElementById("nomeEmpresaDisplay");
          if (empresaDisplay) empresaDisplay.innerHTML = `<span class="text-[10px] font-bold text-slate-500 tracking-widest uppercase items-center flex gap-1"><span class="material-symbols-outlined text-[14px] text-emerald-400">check_circle</span> Processado</span> <span class="text-sm font-bold text-white bg-primary/20 px-3 py-1 rounded-md border border-primary/30 ml-2 shadow-lg shadow-primary/10 tracking-wide">${nomeEmpresa.toUpperCase()}</span>`;
        }

        const tbody = document.getElementById("tableBody");
        if (!tbody) return;
        tbody.innerHTML = "";
        let grandTotal = Array(8).fill(0);
        
        // Animating stats
        animateValue("totalFuncionarios", 0, totalFuncionarios, 800);
        
        let delay = 0;
        MESES.forEach((mes) => {
          const vals = dadosConsolidados[mes];
          const tr = document.createElement("tr");
          tr.className = "group hover:bg-white/5 animate-reveal";
          tr.style.animationDelay = `${delay}ms`;
          delay = Math.min(delay + 20, 300);

          let html = `<td class="p-3 font-bold text-slate-300 border-r border-white/10 bg-white/5 min-w-[150px] sticky left-0 z-20">${mes.toUpperCase()}</td>`;
          vals.forEach((v, idx) => {
            let colorClass = "text-white";
            if (idx === 7) colorClass = "text-accent-cyan";
            html += `<td class="p-3 text-right data-cell ${colorClass}">${formatMoney(v)}</td>`;
            grandTotal[idx] += v;
          });
          tr.innerHTML = html;
          tbody.appendChild(tr);
        });
        
        // Row de Total Final
        const trTotal = document.createElement("tr");
        trTotal.className = "bg-primary/20 backdrop-blur-md sticky bottom-0 z-30 font-bold border-t border-primary/30";

        let tdTotalLabel = `<td class="p-3 font-bold text-white border-r border-white/20 bg-primary/40 sticky left-0 z-40">TOTAL ACUMULADO</td>`;
        let tdTotalVals = "";
        grandTotal.forEach((v, idx) => {
          let colorClass = "text-white";
          if (idx === 7) colorClass = "text-accent-cyan";
          tdTotalVals += `<td class="p-3 text-right font-bold ${colorClass}">${formatMoney(v)}</td>`;
        });
        trTotal.innerHTML = tdTotalLabel + tdTotalVals;
        tbody.appendChild(trTotal);
        
        // Animate metrics
        animateValue("totalRendimentos", 0, grandTotal[0], 1000, true);
        animateValue("totalImposto", 0, grandTotal[7], 1000, true);
        animateValue("totalPrev", 0, (grandTotal[2] + grandTotal[3]), 1000, true);
        
        renderIndividualBody();
        saveToLocal();
      }

      function exportExcel() {
        if (totalFuncionarios === 0) { alert("Processe um arquivo primeiro."); return; }
        const wb = XLSX.utils.book_new();
        const ws_data = [["Mês", "Rend. Tributável", "Dedução Simpl.", "Prev. Oficial", "Prev. Complem.", "Prev. FAPI", "Dependentes", "Pensão Alim.", "Imposto Retido"]];
        MESES.forEach((mes) => { ws_data.push([mes, ...dadosConsolidados[mes]]); });
        let totalRow = ["TOTAL ANUAL"];
        for (let i = 0; i < 8; i++) {
          let sum = 0;
          MESES.forEach((m) => (sum += dadosConsolidados[m][i]));
          totalRow.push(sum);
        }
        ws_data.push(totalRow);
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Consolidado DIRF");
        XLSX.writeFile(wb, "Consolidado_DIRF.xlsx");
      }
    </script>
  </body>
</html>
