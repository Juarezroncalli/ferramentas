<!DOCTYPE html>
<html class="dark" lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Consolidador DIRF - Modern Dashboard</title>
    
    <!-- Scripts Externos -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#197fe6",
              "background-light": "#f6f7f8",
              "background-dark": "#0f1115",
              "surface-dark": "#1e2128",
              "border-dark": "#2d333d"
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {
              "DEFAULT": "0.25rem",
              "lg": "0.5rem",
              "xl": "0.75rem",
              "full": "9999px"
            },
          },
        },
      }
    </script>
    
    <script>
      // Configuração do Worker do PDF.js
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .custom-scrollbar::-webkit-scrollbar {
        height: 6px;
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #2d333d;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #197fe6;
      }
      .loading-overlay {
        backdrop-filter: blur(8px);
      }
      /* Animação suave para hover de linhas */
      tr {
        transition: background-color 0.2s;
      }
    </style>
  </head>
  
  <body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex font-display">
    
    <!-- Loading Overlay -->
    <div id="loading" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center bg-background-dark/80 loading-overlay">
      <div class="size-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
      <h3 id="loadingText" class="text-xl font-medium text-white">Processando PDF...</h3>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="w-20 lg:w-64 border-r border-slate-200 dark:border-border-dark flex flex-col bg-white dark:bg-background-dark sticky top-0 h-screen transition-all duration-300">
      <div class="p-6 flex items-center gap-3">
        <div class="size-8 bg-primary rounded-lg flex items-center justify-center text-white shrink-0">
          <span class="material-symbols-outlined">payments</span>
        </div>
        <span class="text-xl font-bold tracking-tight hidden lg:block">DIRF Master</span>
      </div>
      
      <nav class="flex-1 px-4 py-4 space-y-2">
        <a class="flex items-center gap-3 px-4 py-3 rounded-xl bg-primary/10 text-primary font-medium group transition-all" href="#" onclick="location.reload()">
          <span class="material-symbols-outlined">dashboard</span>
          <span class="hidden lg:block text-sm">Visão Geral</span>
        </a>
        <button onclick="exportExcel()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark transition-colors group">
          <span class="material-symbols-outlined">file_download</span>
          <span class="hidden lg:block text-sm">Exportar Excel</span>
        </button>
        <button onclick="location.reload()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark transition-colors group">
          <span class="material-symbols-outlined">delete</span>
          <span class="hidden lg:block text-sm">Limpar Dados</span>
        </button>
      </nav>
      
      <div class="p-4 border-t border-slate-200 dark:border-border-dark space-y-1">
        <div class="flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400">
          <span class="material-symbols-outlined text-primary">code</span>
          <div class="flex flex-col hidden lg:block">
            <span class="text-[10px] uppercase font-bold tracking-tighter text-slate-500">Developed by</span>
            <span class="text-xs font-black text-slate-300">J.Roncalli</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-y-auto overflow-x-hidden bg-background-light dark:bg-background-dark custom-scrollbar">
      
      <!-- Header -->
      <header class="h-20 border-b border-slate-200 dark:border-border-dark flex items-center justify-between px-8 bg-white/50 dark:bg-background-dark/50 backdrop-blur-md sticky top-0 z-50">
        <div class="flex flex-col">
          <h1 class="text-xl font-bold">Consolidação DIRF Anual</h1>
          <p class="text-xs text-slate-500 dark:text-slate-400">Análise corporativa de rendimentos e tributação</p>
        </div>
        
        <div class="flex items-center flex-1 max-w-xl">
          <div class="relative w-full">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
            <input 
              id="searchInput"
              oninput="handleSearch(this.value)"
              class="w-full bg-slate-100 dark:bg-surface-dark border-none rounded-xl pl-10 pr-4 py-3 focus:ring-2 focus:ring-primary text-sm transition-all" 
              placeholder="Buscar funcionário por nome ou CPF..." 
              type="text"
            />
          </div>
        </div>
        
        <div class="flex items-center gap-4">
          <button 
            onclick="togglePrivacy()" 
            id="privacyToggle"
            class="size-12 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-surface-dark text-slate-500 dark:text-slate-400 hover:bg-slate-200 transition-all group"
            title="Alternar Modo Privacidade"
          >
            <span class="material-symbols-outlined transition-transform group-active:scale-90" id="privacyIcon">visibility</span>
          </button>

          <div class="flex items-center gap-3">
            <div class="text-right hidden sm:block">
              <p class="text-3xl font-black text-primary tracking-tight" id="nomeEmpresaDisplay">Usuário Fiscal</p>
              <p class="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase tracking-widest">Empresa Declarante Selecionada</p>
            </div>
            <div class="size-10 rounded-xl bg-primary/20 flex items-center justify-center overflow-hidden border-2 border-primary/50">
              <span class="material-symbols-outlined text-primary">account_circle</span>
            </div>
          </div>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="p-8 space-y-8 max-w-[1600px] mx-auto w-full">
        
        <!-- Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Total Funcionários -->
          <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-border-dark shadow-sm hover:shadow-md transition-all group">
            <div class="flex justify-between items-start mb-4">
              <div class="p-2 rounded-xl bg-primary/10 text-primary">
                <span class="material-symbols-outlined">groups</span>
              </div>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Funcionários Processados</p>
            <h3 class="text-2xl font-bold mt-1" id="totalFuncionarios">0</h3>
          </div>

          <!-- Total Rendimentos -->
          <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-border-dark shadow-sm hover:shadow-md transition-all">
            <div class="flex justify-between items-start mb-4">
              <div class="p-2 rounded-xl bg-emerald-500/10 text-emerald-500">
                <span class="material-symbols-outlined">payments</span>
              </div>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Rend. Tributáveis</p>
            <h3 class="text-2xl font-bold mt-1" id="totalRendimentos">R$ 0,00</h3>
          </div>

          <!-- Total Imposto -->
          <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-border-dark shadow-sm hover:shadow-md transition-all">
            <div class="flex justify-between items-start mb-4">
              <div class="p-2 rounded-xl bg-rose-500/10 text-rose-500">
                <span class="material-symbols-outlined">receipt_long</span>
              </div>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Imposto Retido</p>
            <h3 class="text-2xl font-bold mt-1" id="totalImposto">R$ 0,00</h3>
          </div>

          <!-- Total Previdência -->
          <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl border border-slate-200 dark:border-border-dark shadow-sm hover:shadow-md transition-all">
            <div class="flex justify-between items-start mb-4">
              <div class="p-2 rounded-xl bg-amber-500/10 text-amber-500">
                <span class="material-symbols-outlined">savings</span>
              </div>
            </div>
            <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Previdência Oficial</p>
            <h3 class="text-2xl font-bold mt-1" id="totalPrev">R$ 0,00</h3>
          </div>
        </div>

        <!-- Upload Section -->
        <div id="uploadSection" class="bg-white dark:bg-surface-dark rounded-2xl border-2 border-dashed border-slate-200 dark:border-border-dark p-12 transition-all hover:border-primary/50 group relative">
          <input
            type="file"
            id="fileInput"
            accept=".pdf"
            onchange="handleFile(this.files[0])"
            class="absolute inset-0 opacity-0 cursor-pointer z-10"
          />
          <div class="flex flex-col items-center justify-center text-center space-y-4">
            <div class="size-20 rounded-full bg-primary/10 text-primary flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
              <span class="material-symbols-outlined text-4xl">cloud_upload</span>
            </div>
            <div>
              <h3 class="text-xl font-bold">Faça o upload do seu PDF DIRF</h3>
              <p class="text-slate-500 dark:text-slate-400 max-w-sm mt-2">Arraste o arquivo aqui ou clique para selecionar. O processamento é feito 100% no seu navegador.</p>
            </div>
          </div>
        </div>

        <!-- Tabs Section -->
        <div id="tabsContainer" class="hidden flex gap-2 p-1 bg-slate-200/50 dark:bg-border-dark/30 rounded-xl w-fit">
          <button onclick="switchTab('consolidado')" id="tab-consolidado" class="px-6 py-2 rounded-lg text-sm font-bold transition-all bg-white dark:bg-surface-dark shadow-sm text-primary">Visão Consolidada</button>
          <button onclick="switchTab('individual')" id="tab-individual" class="px-6 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">Visão Individual</button>
        </div>

        <!-- Results Table Section (Consolidade) -->
        <div id="resultContainer" class="hidden space-y-6">
          <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-border-dark overflow-hidden shadow-sm flex flex-col">
            <div class="px-8 py-6 border-b border-slate-200 dark:border-border-dark flex items-center justify-between">
              <div>
                <h2 class="text-lg font-bold">Detalhamento Mensal Consolidado</h2>
                <p class="text-sm text-slate-500 dark:text-slate-400">Valores totais somados de todos os beneficiários processados.</p>
              </div>
              <div class="flex items-center gap-3">
                <button onclick="exportExcel()" class="flex items-center gap-2 px-4 py-2 rounded-xl bg-primary text-white hover:bg-primary/90 text-sm font-medium transition-all shadow-lg shadow-primary/20">
                  <span class="material-symbols-outlined text-sm">download</span>
                  Exportar CSV/Excel
                </button>
              </div>
            </div>
            
            <div class="overflow-x-auto custom-scrollbar">
              <table id="mainTable" class="w-full text-left border-collapse min-w-[1200px]">
                <thead>
                  <tr class="bg-slate-50 dark:bg-background-dark/50">
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider sticky left-0 bg-slate-50 dark:bg-background-dark/50 border-r border-slate-200 dark:border-border-dark z-10">Mês</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Rend. Tributável</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Dedução Simpl.</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Prev. Oficial</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Prev. Complem.</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Prev. FAPI</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Dependentes</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Pensão Alim.</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right">Imposto Retido</th>
                  </tr>
                </thead>
                <tbody id="tableBody" class="divide-y divide-slate-100 dark:divide-border-dark text-sm">
                  <!-- Linhas geradas via JavaScript -->
                </tbody>
              </table>
            </div>
            
            <div class="px-8 py-4 bg-slate-50 dark:bg-background-dark/30 border-t border-slate-200 dark:border-border-dark flex items-center justify-between">
              <p class="text-xs text-slate-500 dark:text-slate-400">Processamento concluído com sucesso.</p>
              <div class="flex items-center gap-2">
                <span class="text-xs font-medium text-slate-400 italic"></span>
              </div>
            </div>
          </div>
        </div>

        <!-- System Alerts / Info -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 pb-12">
          <div class="bg-primary/5 border border-primary/20 rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-4">
              <span class="material-symbols-outlined text-primary">info</span>
              <h4 class="font-bold text-primary">Segurança de Dados</h4>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
              Este dashboard opera inteiramente no <b>lado do cliente</b>. Nenhum dado de remuneração ou identificação pessoal de funcionários é enviado para servidores externos. O PDF é lido e processado localmente na memória do seu navegador.
            </p>
          </div>
          <div class="bg-emerald-500/5 border border-emerald-500/20 rounded-2xl p-6">
            <div class="flex items-center gap-3 mb-4">
              <span class="material-symbols-outlined text-emerald-500">task_alt</span>
              <h4 class="font-bold text-emerald-500">Dica de Uso</h4>
            </div>
            <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed">
              Certifique-se de que o PDF da DIRF segue o layout padrão da Receita Federal para garantir a precisão máxima na extração automática dos valores por mês.
            </p>
          </div>
        </div>

        <!-- Individual Table Section -->
        <div id="individualContainer" class="hidden space-y-6">
          <div class="bg-white dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-border-dark overflow-hidden shadow-sm flex flex-col">
            <div class="px-8 py-6 border-b border-slate-200 dark:border-border-dark">
              <h2 class="text-lg font-bold">Lista de Funcionários</h2>
              <p class="text-sm text-slate-500 dark:text-slate-400">Total acumulado anual por beneficiário.</p>
            </div>
            <div class="overflow-x-auto custom-scrollbar">
              <table id="individualTable" class="w-full text-left border-collapse">
                <thead>
                  <tr class="bg-slate-50 dark:bg-background-dark/50">
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider sticky left-0 bg-slate-50 z-10">CPF</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider sticky left-[120px] bg-slate-50 z-10">Nome do Funcionário</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Rend. Tributável</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Ded. Simpl.</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Prev. Oficial</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Prev. Compl.</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Prev. FAPI</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Dependentes</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Pensão Alim.</th>
                    <th class="px-6 py-4 text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider text-right whitespace-nowrap">Imposto Retido</th>
                  </tr>
                </thead>
                <tbody id="individualBody" class="divide-y divide-slate-100 dark:divide-border-dark text-sm">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // === Lógica de Estado ===
      const MESES = [
        "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
        "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro",
        "13° Salário"
      ];

      let dadosConsolidados = {};
      let detalhesPorFuncionario = {}; // { cpf: { nome: "", totais: [8 vals] } }
      let totalFuncionarios = 0;
      let nomeEmpresa = "";
      let privacyMode = localStorage.getItem('privacy_mode') === 'true';
      let currentTab = 'consolidado';

      function initDados() {
        MESES.forEach((mes) => {
          dadosConsolidados[mes] = Array(8).fill(0);
        });
        detalhesPorFuncionario = {};
        totalFuncionarios = 0;
        nomeEmpresa = "";
        localStorage.removeItem('dirf_data');
      }

      function saveToLocal() {
        const data = {
          dadosConsolidados,
          detalhesPorFuncionario,
          totalFuncionarios,
          nomeEmpresa,
          lastUpdated: new Date().getTime()
        };
        localStorage.setItem('dirf_data', JSON.stringify(data));
      }

      function loadFromLocal() {
        const saved = localStorage.getItem('dirf_data');
        if (saved) {
          const data = JSON.parse(saved);
          dadosConsolidados = data.dadosConsolidados;
          detalhesPorFuncionario = data.detalhesPorFuncionario;
          totalFuncionarios = data.totalFuncionarios;
          nomeEmpresa = data.nomeEmpresa;
          renderResults();
        }
        updatePrivacyUI();
      }

      function togglePrivacy() {
        privacyMode = !privacyMode;
        localStorage.setItem('privacy_mode', privacyMode);
        updatePrivacyUI();
        renderResults();
      }

      function updatePrivacyUI() {
        const icon = document.getElementById('privacyIcon');
        icon.innerText = privacyMode ? 'visibility_off' : 'visibility';
        const btn = document.getElementById('privacyToggle');
        if (privacyMode) {
          btn.classList.add('bg-primary/20', 'text-primary');
        } else {
          btn.classList.remove('bg-primary/20', 'text-primary');
        }
      }

      function formatMoney(val) {
        if (privacyMode) return "R$ ••••••";
        return val.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      window.onload = loadFromLocal;

      function showLoading(show, msg) {
        const el = document.getElementById("loading");
        const txt = document.getElementById("loadingText");
        if (show) {
          el.classList.remove("hidden");
          el.classList.add("flex");
          txt.innerText = msg || "Processando...";
        } else {
          el.classList.add("hidden");
          el.classList.remove("flex");
        }
      }

      // Função auxiliar para converter string PT-BR para float
      function parseBrlFloat(str) {
        if (!str || str.trim() === "") return 0;
        let clean = str.replace(/\s/g, "");
        if ((clean.match(/\./g) || []).length > 1 && !clean.includes(",")) {
          const parts = clean.split(".");
          const decimal = parts.pop();
          const integer = parts.join("");
          return parseFloat(integer + "." + decimal);
        }
        if (clean.includes(".") && !clean.includes(",")) {
          if (/\.\d{2}$/.test(clean)) return parseFloat(clean);
        }
        clean = clean.replace(/\./g, "").replace(",", ".");
        if (clean.startsWith(".")) clean = "0" + clean;
        const val = parseFloat(clean);
        return isNaN(val) ? 0 : val;
      }

      async function handleFile(file) {
        if (!file) return;
        initDados();
        showLoading(true, "Lendo PDF...");
        const reader = new FileReader();
        reader.onload = async function () {
          try {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            showLoading(true, `Processando ${pdf.numPages} páginas...`);
            const cpfsProcessados = new Set();
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const textContent = await page.getTextContent();
              const lines = groupTextByLines(textContent.items);
              processPageLines(lines, cpfsProcessados);
            }
            totalFuncionarios = cpfsProcessados.size;
            renderResults();
            showLoading(false);
          } catch (error) {
            console.error(error);
            alert("Erro ao processar PDF: " + error.message);
            showLoading(false);
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function groupTextByLines(items) {
        const lines = [];
        const tolerance = 4;
        items.sort((a, b) => {
          if (Math.abs(a.transform[5] - b.transform[5]) > tolerance) return b.transform[5] - a.transform[5];
          return a.transform[4] - b.transform[4];
        });
        let currentLine = [];
        let currentY = null;
        items.forEach((item) => {
          if (currentY === null || Math.abs(item.transform[5] - currentY) > tolerance) {
            if (currentLine.length > 0) lines.push(currentLine);
            currentLine = [];
            currentY = item.transform[5];
          }
          currentLine.push(item.str);
        });
        if (currentLine.length > 0) lines.push(currentLine);
        return lines;
      }

      function processPageLines(lines, cpfSet) {
        let isMainTable = false;
        let currentCpf = null;
        let currentNome = null;

        for (let i = 0; i < lines.length; i++) {
          const lineStr = lines[i].join(" ").trim();

          // Extração do Nome da Empresa (Declarante)
          if (!nomeEmpresa && (lineStr.includes("Nome empresarial") || lineStr.includes("NOME EMPRESARIAL") || lineStr.includes("Nome da fonte pagadora") || lineStr.startsWith("Empresa:"))) {
            let potentialName = "";
            if (lineStr.includes(":")) {
               potentialName = lineStr.split(":")[1].trim();
            } else {
               const keywords = ["Nome empresarial", "NOME EMPRESARIAL", "Nome da fonte pagadora", "Empresa"];
               for (let key of keywords) {
                 if (lineStr.includes(key)) {
                    potentialName = lineStr.substring(lineStr.indexOf(key) + key.length).trim();
                    break;
                 }
               }
            }
            if (potentialName && potentialName.length > 3) nomeEmpresa = potentialName;
            else if (i + 1 < lines.length) nomeEmpresa = lines[i+1].join(" ").trim();
          }

          // Busca CPF e Nome do Beneficiário
          if (lineStr.includes("CPF:")) {
            const cpfMatch = lineStr.match(/CPF:\s*([\d\.-]+)/);
            const nomeMatch = lineStr.match(/Nome:\s*(.+)$/);
            
            if (cpfMatch) {
              currentCpf = cpfMatch[1].trim();
              cpfSet.add(currentCpf);
              if (!detalhesPorFuncionario[currentCpf]) {
                detalhesPorFuncionario[currentCpf] = {
                  nome: nomeMatch ? nomeMatch[1].trim() : "Não Identificado",
                  totais: Array(8).fill(0)
                };
              }
            }
          }

          if (lineStr.includes("Rend. Tributável") && lineStr.includes("Imposto Retido")) {
            isMainTable = true; continue;
          }
          if (isMainTable && (lineStr.includes("RENDIMENTOS ISENTOS") || lineStr.includes("INFORMAÇÕES"))) {
            isMainTable = false;
          }
          if (isMainTable) {
            const mesMatch = MESES.find(m => lineStr.startsWith(m) || lineStr.startsWith(m.replace("°", "º")));
            if (mesMatch && currentCpf) {
              const rawValues = lines[i].slice(1);
              const numericValues = rawValues.filter(v => /[\d\.,]+/.test(v) && v.trim().length > 0);
              if (numericValues.length >= 8) {
                for (let col = 0; col < 8; col++) {
                  const val = parseBrlFloat(numericValues[col]);
                  let mesKey = mesMatch.includes("13") ? "13° Salário" : mesMatch;
                  dadosConsolidados[mesKey][col] += val;
                  detalhesPorFuncionario[currentCpf].totais[col] += val;
                }
              }
            }
          }
        }
      }

      function switchTab(tab) {
        currentTab = tab;
        const tabs = ['consolidado', 'individual'];
        tabs.forEach(t => {
          const btn = document.getElementById(`tab-${t}`);
          const container = t === 'consolidado' ? document.getElementById('resultContainer') : document.getElementById('individualContainer');
          
          if (t === tab) {
            btn.classList.add('bg-white', 'dark:bg-surface-dark', 'shadow-sm', 'text-primary');
            btn.classList.remove('text-slate-500');
            container.classList.remove('hidden');
          } else {
            btn.classList.remove('bg-white', 'dark:bg-surface-dark', 'shadow-sm', 'text-primary');
            btn.classList.add('text-slate-500');
            container.classList.add('hidden');
          }
        });
      }

      function handleSearch(query) {
        query = query.toLowerCase();
        renderIndividualBody(query);
        if (query && currentTab !== 'individual') {
          switchTab('individual');
        }
      }

      function renderIndividualBody(filter = "") {
        const tbody = document.getElementById("individualBody");
        tbody.innerHTML = "";
        
        Object.keys(detalhesPorFuncionario).forEach(cpf => {
          const func = detalhesPorFuncionario[cpf];
          if (cpf.includes(filter) || func.nome.toLowerCase().includes(filter)) {
            const tr = document.createElement("tr");
            tr.className = "hover:bg-slate-50 dark:hover:bg-background-dark/50 transition-colors";
            
            let cellsHtml = `
              <td class="px-6 py-4 font-mono text-xs text-slate-500 sticky left-0 bg-white dark:bg-surface-dark z-10">${cpf}</td>
              <td class="px-6 py-4 font-bold text-slate-700 dark:text-slate-200 sticky left-[120px] bg-white dark:bg-surface-dark z-10">${func.nome}</td>
            `;

            func.totais.forEach((v, idx) => {
              let colorClass = "text-slate-600 dark:text-slate-300";
              if (idx === 0) colorClass = "text-emerald-600 font-bold";
              if (idx === 7) colorClass = "text-rose-600 font-bold";
              cellsHtml += `<td class="px-6 py-4 text-right font-medium ${colorClass}">${formatMoney(v)}</td>`;
            });

            tr.innerHTML = cellsHtml;
            tbody.appendChild(tr);
          }
        });
      }

      function renderResults() {
        document.getElementById("uploadSection").classList.add("hidden");
        document.getElementById("tabsContainer").classList.remove("hidden");
        switchTab(currentTab);
        
        if (nomeEmpresa) {
          document.getElementById("nomeEmpresaDisplay").innerText = nomeEmpresa;
        }

        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";
        let grandTotal = Array(8).fill(0);
        document.getElementById("totalFuncionarios").innerText = totalFuncionarios;
        
        MESES.forEach((mes) => {
          const vals = dadosConsolidados[mes];
          const tr = document.createElement("tr");
          tr.className = "hover:bg-slate-50 dark:hover:bg-background-dark/50 transition-colors";
          let html = `<td class="px-6 py-4 font-bold sticky left-0 bg-white dark:bg-surface-dark border-r border-slate-100 dark:border-border-dark z-10">${mes}</td>`;
          vals.forEach((v, idx) => {
            html += `<td class="px-6 py-4 text-right font-medium text-slate-600 dark:text-slate-300">${formatMoney(v)}</td>`;
            grandTotal[idx] += v;
          });
          tr.innerHTML = html;
          tbody.appendChild(tr);
        });
        
        const trTotal = document.createElement("tr");
        trTotal.className = "bg-primary/5 dark:bg-primary/10 border-t-2 border-primary/20";
        let tdTotalLabel = `<td class="px-6 py-5 font-black text-primary sticky left-0 bg-slate-50 dark:bg-slate-900 z-10">TOTAL ANUAL</td>`;
        let tdTotalVals = "";
        grandTotal.forEach((v) => {
          tdTotalVals += `<td class="px-6 py-5 text-right font-black text-slate-900 dark:text-white">${formatMoney(v)}</td>`;
        });
        trTotal.innerHTML = tdTotalLabel + tdTotalVals;
        tbody.appendChild(trTotal);
        
        document.getElementById("totalRendimentos").innerText = formatMoney(grandTotal[0]);
        document.getElementById("totalImposto").innerText = formatMoney(grandTotal[7]);
        document.getElementById("totalPrev").innerText = formatMoney(grandTotal[2]);
        
        renderIndividualBody();
        saveToLocal();
      }

      function exportExcel() {
        if (totalFuncionarios === 0) { alert("Processe um arquivo primeiro."); return; }
        const wb = XLSX.utils.book_new();
        const ws_data = [["Mês", "Rend. Tributável", "Dedução Simpl.", "Prev. Oficial", "Prev. Complem.", "Prev. FAPI", "Dependentes", "Pensão Alim.", "Imposto Retido"]];
        MESES.forEach((mes) => { ws_data.push([mes, ...dadosConsolidados[mes]]); });
        let totalRow = ["TOTAL ANUAL"];
        for (let i = 0; i < 8; i++) {
          let sum = 0;
          MESES.forEach((m) => (sum += dadosConsolidados[m][i]));
          totalRow.push(sum);
        }
        ws_data.push(totalRow);
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        XLSX.utils.book_append_sheet(wb, ws, "Consolidado DIRF");
        XLSX.writeFile(wb, "Consolidado_DIRF.xlsx");
      }
    </script>
  </body>
</html>
