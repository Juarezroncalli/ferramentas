<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Extrator NFSe Turbo | V3</title>
    <!-- Anti-Dev Scripts -->
    <script>
      document.addEventListener("contextmenu", (event) =>
        event.preventDefault(),
      );
      document.onkeydown = function (e) {
        if (e.keyCode == 123) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 73) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 74) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 67) return false;
        if (e.ctrlKey && e.keyCode == 85) return false;
        if (e.ctrlKey && e.keyCode == 83) return false;
      };
    </script>

    <!-- Libraries -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
      :root {
        /* --- NEXUS THEME (LIGHT MODE) --- */
        --bg-app: #f6f8fa;
        --bg-surface: #ffffff;
        --bg-panel: #ffffff;
        --bg-sidebar: #ffffff;
        --bg-input: #f0f2f5;
        --bg-hover: #fcfcfd;
        --bg-tooltip: #1e2130;

        --text-primary: #1e2130;
        --text-secondary: #5e6c84;
        --text-tertiary: #8f9bb3;
        --text-inverse: #ffffff;

        --border-subtle: #edf1f7;
        --border-focus: #887cfd;
        --border-dashed: #3f3f46;

        /* Neon Highlight */
        --highlight-color: #887cfd;
        --highlight-bg: rgba(136, 124, 253, 0.25);

        --accent-primary: #5347ce;
        --accent-glow: rgba(83, 71, 206, 0.2);
        --accent-surface-hover: rgba(83, 71, 206, 0.05);

        /* Cores de Dados */
        --data-purple: #5347ce;
        --data-green: #16c8c7;
        --data-blue: #4896fe;
        --data-orange: #ffab00;
        --data-red: #ff5630;

        /* Badges Backgrounds */
        --badge-green-bg: rgba(22, 200, 199, 0.12);
        --badge-purple-bg: rgba(83, 71, 206, 0.12);
        --badge-blue-bg: rgba(72, 150, 254, 0.12);
        --badge-red-bg: rgba(255, 86, 48, 0.12);
        --badge-orange-bg: rgba(255, 171, 0, 0.12);
        --badge-neutral-bg: #f7f9fc;
        --badge-mark-bg: #dbeafe;

        /* Design Tokens */
        --radius-sm: 8px;
        --radius-md: 16px;
        --radius-lg: 24px;

        --shadow-card: 0px 4px 20px rgba(0, 0, 0, 0.05);
        --shadow-float: 0px 8px 30px rgba(0, 0, 0, 0.12);
        --upload-pattern: radial-gradient(#e4e9f2 1px, transparent 1px);

        --font-ui:
          "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        --font-code: "JetBrains Mono", monospace;
      }

      /* --- DARK MODE --- */
      [data-theme="dark"] {
        --bg-app: #0f111a;
        --bg-surface: #1e2130;
        --bg-panel: #1e2130;
        --bg-sidebar: #151725;
        --bg-input: #151725;
        --bg-hover: #2a2e42;
        --bg-tooltip: #2a2e42;

        --text-primary: #ffffff;
        --text-secondary: #a0aec0;
        --text-tertiary: #718096;
        --text-inverse: #0f111a;

        --border-subtle: #2d3748;
        --border-focus: #887cfd;
        --border-dashed: #4a5568;

        --accent-primary: #887cfd;
        --accent-glow: rgba(136, 124, 253, 0.25);
        --accent-surface-hover: rgba(255, 255, 255, 0.05);

        --data-purple: #887cfd;
        --data-green: #2dd4bf;
        --data-blue: #60a5fa;
        --data-orange: #fbbf24;
        --data-red: #f87171;

        --badge-green-bg: rgba(45, 212, 191, 0.15);
        --badge-purple-bg: rgba(136, 124, 253, 0.15);
        --badge-blue-bg: rgba(96, 165, 250, 0.15);
        --badge-red-bg: rgba(248, 113, 113, 0.15);
        --badge-orange-bg: rgba(251, 191, 36, 0.15);
        --badge-neutral-bg: #2d3748;
        --badge-mark-bg: rgba(56, 189, 248, 0.15);

        --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        --shadow-float: 0 10px 25px -5px rgba(0, 0, 0, 0.6);
        --upload-pattern: radial-gradient(#2d3748 1px, transparent 1px);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        outline: none;
      }

      body {
        font-family: var(--font-ui);
        background-color: var(--bg-app);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden;
        display: flex;
        -webkit-font-smoothing: antialiased;
        font-size: 13px; /* Reverted */
        transition:
          background-color 0.3s ease,
          color 0.3s ease;
      }

      /* NEON HIGHLIGHT */
      .neon-highlight {
        color: #fff;
        background-color: var(--data-purple);
        text-shadow: 0 0 2px #fff;
        box-shadow:
          0 0 5px var(--accent-primary),
          0 0 10px var(--accent-primary);
        border-radius: 4px;
        padding: 0 4px;
        font-weight: bold;
      }

      /* SIDEBAR */
      .sidebar {
        width: 240px; /* Reverted */
        background: var(--bg-sidebar);
        padding: 2rem 1.2rem;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        color: var(--text-primary);
        z-index: 20;
        box-shadow: 1px 0 0 var(--border-subtle);
      }

      [data-theme="dark"] .sidebar {
        box-shadow: 1px 0 0 var(--border-subtle);
        border-right: none;
      }

      .logo {
        font-size: 16px; /* Reverted */
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 3rem;
        display: flex;
        align-items: center;
        gap: 12px;
        padding-left: 0.5rem;
      }

      .logo-subtitle {
        font-size: 10px;
        opacity: 0.6;
        text-transform: uppercase;
      }

      .logo i {
        font-size: 20px;
        padding: 8px;
      }

      .nav-item {
        background: transparent;
        color: var(--text-secondary);
        padding: 0.8rem 1rem;
        margin-bottom: 0.4rem;
        font-weight: 600;
        border-radius: var(--radius-sm);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s ease;
        font-size: 13px; /* Reverted */
      }

      .nav-item:hover {
        background-color: var(--bg-hover);
        color: var(--data-purple);
      }

      .nav-item.active {
        background-color: var(--badge-purple-bg);
        color: var(--data-purple);
      }

      /* MAIN CONTENT */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
        background: var(--bg-app);
        background-image: linear-gradient(
          to bottom,
          var(--bg-surface) 0%,
          var(--bg-app) 100%
        );
        background-size: 100% 400px;
        background-repeat: no-repeat;
      }

      [data-theme="dark"] .main-content {
        background-image: none;
      }

      .scroll-content {
        flex: 1;
        overflow-y: auto;
        padding: 2rem 3rem;
        padding-bottom: 100px;
      }

      /* HEADER */
      .neo-header {
        background: transparent;
        border: none;
        padding: 0;
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .neo-header h1 {
        font-weight: 600;
        font-size: 18px;
        color: var(--text-primary);
        letter-spacing: -0.01em;
      }

      .theme-toggle {
        background: transparent;
        border: 1px solid var(--data-purple);
        color: var(--data-purple);
        padding: 0 14px;
        height: 32px;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 11px;
      }

      /* DASHBOARD */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* Reverted to 4 cols */
        gap: 1rem;
        margin-bottom: 1.5rem;
      }
      .metric-card {
        background: var(--bg-surface);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        box-shadow: var(--shadow-card);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: auto;
      }

      .metric-title {
        font-weight: 600;
        font-size: 12px;
        color: var(--text-tertiary);
        margin-bottom: 0.5rem;
        text-transform: none;
      }
      .metric-value {
        font-family: var(--font-ui);
        font-size: 28px; /* Reverted */
        font-weight: 700;
        color: var(--text-primary);
        letter-spacing: -0.02em;
        line-height: 1.2;
      }
      .metric-card.green .metric-value {
        color: var(--data-green);
      }
      .metric-card.purple .metric-value {
        color: var(--data-purple);
      }

      /* UPLOAD */
      .upload-area {
        background: var(--bg-panel);
        border: 1px dashed var(--border-dashed);
        border-radius: var(--radius-md);
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1.5rem;
        cursor: pointer;
        position: relative;
        background-image: var(--upload-pattern);
      }
      .upload-area:hover {
        border-color: var(--data-blue);
        background-color: var(--bg-hover);
      }
      .upload-label {
        font-weight: 500;
        font-size: 12px;
        color: var(--text-primary);
      }
      .upload-label i {
        color: var(--text-tertiary);
        margin-bottom: 0.5rem;
        font-size: 20px;
        transition: color 0.2s;
      }
      .upload-area:hover .upload-label i {
        color: var(--data-blue);
      }
      #xmlInput {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
      }

      /* FILTERS */
      .filters-container {
        margin-bottom: 3rem;
      }
      .filters-grid {
        display: flex;
        gap: 20px;
        align-items: flex-end;
      }
      .form-group {
        flex: 2;
      }
      .form-group label {
        display: block;
        font-weight: 700;
        margin-bottom: 12px;
        font-size: 16px;
        color: var(--text-secondary);
      }
      .neo-input {
        width: 100%;
        padding: 10px 16px;
        border-radius: var(--radius-sm);
        background: var(--bg-input);
        font-family: var(--font-ui);
        font-size: 13px; /* Reverted */
        color: var(--text-primary);
        border: 1px solid transparent;
      }
      .neo-input:focus {
        background: var(--bg-surface);
        border-color: var(--border-focus);
      }
      .btn-filter {
        background: var(--data-purple);
        color: #ffffff;
        border: none;
        padding: 0 24px;
        font-family: var(--font-ui);
        font-weight: 600;
        border-radius: var(--radius-sm);
        font-size: 13px; /* Reverted */
        cursor: pointer;
        height: 40px; /* Reverted */
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(83, 71, 206, 0.2);
      }
      .btn-clear {
        background: var(--data-red) !important;
        box-shadow: 0 4px 12px rgba(255, 86, 48, 0.3) !important;
      }

      /* TABLE - BIGGER */
      .table-container {
        width: 100%;
        border-radius: var(--radius-md);
        background: var(--bg-surface);
        box-shadow: var(--shadow-card);
        margin-bottom: 3rem;
      }
      table {
        width: 100%;
        table-layout: fixed;
        border-collapse: separate;
        font-family: var(--font-ui);
        font-size: 18px; /* Bigger table font */
      }
      th {
        color: var(--text-secondary);
        padding: 24px 16px;
        text-align: left;
        font-weight: 700;
        font-size: 16px;
        text-transform: uppercase;
        border-bottom: 2px solid var(--border-subtle);
        background: var(--bg-surface);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      td {
        padding: 20px 16px;
        border-bottom: 1px solid var(--border-subtle);
        vertical-align: middle;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      tr:hover td {
        background: var(--bg-hover);
      }

      /* Discriminação (kept smaller) */
      td.full-text {
        white-space: pre-wrap;
        word-break: break-word;
        overflow: visible;
        font-size: 15px; /* Kept moderate */
        line-height: 1.6;
      }

      /* FOOTER */
      .footer-controls {
        background: rgba(255, 255, 255, 0.95);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 6px 24px;
        position: fixed;
        bottom: 0;
        left: 240px; /* Sidebar width */
        right: 0;
        z-index: 100;
        height: 36px;
        display: flex;
        align-items: center;
        backdrop-filter: blur(12px);
      }
      [data-theme="dark"] .footer-controls {
        background: rgba(9, 9, 11, 0.95);
        border-color: var(--border-subtle);
      }
      .status-bar {
        font-size: 10px;
        font-weight: normal;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-file-invoice"></i>
        <div class="logo-text">
          <span
            >EXTRATOR
            <span style="opacity: 0.5; font-weight: 400">NFSe</span></span
          >
          <span class="logo-subtitle">TURBO V3</span>
        </div>
      </div>
      <nav>
        <div class="nav-item active">
          <i class="fas fa-bolt"></i> <span>Extração</span>
        </div>
        <div
          class="nav-item"
          onclick="document.getElementById('xmlInput').click()"
        >
          <i class="fas fa-upload"></i> <span>Carregar Arquivos</span>
        </div>
      </nav>
      <div
        style="
          margin-top: auto;
          font-size: 12px;
          color: var(--text-tertiary);
          font-family: monospace;
        "
      >
        EXTRATOR V3.2
      </div>
    </aside>

    <main class="main-content">
      <div class="scroll-content">
        <header class="neo-header">
          <div>
            <h1>Extrator NFSe Turbo</h1>
          </div>
          <div class="header-actions">
            <button id="themeToggle" class="theme-toggle" title="Alternar Tema">
              <i class="fas fa-moon"></i> <span>Alterar Tema</span>
            </button>
          </div>
        </header>

        <div class="dashboard-grid">
          <div class="metric-card green">
            <div style="display: flex; justify-content: space-between">
              <div class="metric-title">Valor Total (R$)</div>
              <i
                class="fas fa-dollar-sign"
                style="font-size: 24px; color: var(--data-green); opacity: 0.5"
              ></i>
            </div>
            <div class="metric-value" id="totalDisplayValue">0,00</div>
          </div>

          <div class="metric-card purple">
            <div style="display: flex; justify-content: space-between">
              <div class="metric-title">Registros</div>
              <i
                class="fas fa-file-invoice"
                style="font-size: 24px; color: var(--data-purple); opacity: 0.5"
              ></i>
            </div>
            <div class="metric-value" id="countDisplay">0</div>
          </div>
        </div>

        <div class="upload-area">
          <input
            type="file"
            id="xmlInput"
            multiple
            accept=".xml, .zip"
            onchange="processFiles(this.files)"
          />
          <div class="upload-label">
            <i class="fas fa-cloud-upload"></i><br />
            <span>ARRASTE OU CLIQUE PARA SUBIR XMLS OU ZIPS</span>
          </div>
        </div>

        <div class="filters-container">
          <div class="filters-grid">
            <div class="form-group">
              <label>Busca Inteligente</label>
              <input
                type="text"
                id="searchInput"
                class="neo-input"
                placeholder="Filtrar por Nota, Nome, CNPJ ou Descrição..."
                onkeyup="filterData()"
              />
            </div>

            <button
              class="btn-filter"
              style="background: var(--data-green)"
              onclick="exportToExcel()"
            >
              <i class="fas fa-file-excel"></i> EXPORTAR XLS
            </button>
            <button class="btn-filter" onclick="downloadTXT()">
              <i class="fas fa-file-download"></i> EXPORTAR TXT
            </button>
            <button class="btn-filter btn-clear" onclick="clearData()">
              <i class="fas fa-eraser"></i> LIMPAR
            </button>
          </div>
        </div>

        <div class="table-container">
          <table id="resultTable">
            <thead>
              <tr>
                <th style="width: 15%">Nº NFSe</th>
                <th style="width: 25%">Tomador</th>
                <th style="width: 18%">Documento</th>
                <th style="width: 15%">Valor (R$)</th>
                <th>Descrição</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="footer-controls">
        <div class="status-bar" id="statusMsg">
          <span style="color: var(--text-tertiary)">●</span> Aguardando
          documentos...
        </div>
      </div>
    </main>

    <script>
      // Theme Logic
      const themeToggleBtn = document.getElementById("themeToggle");
      const themeIcon = themeToggleBtn.querySelector("i");

      function setTheme(theme) {
        if (theme === "dark") {
          document.body.setAttribute("data-theme", "dark");
          themeIcon.className = "fas fa-sun";
          localStorage.setItem("theme", "dark");
        } else {
          document.body.removeAttribute("data-theme");
          themeIcon.className = "fas fa-moon";
          localStorage.setItem("theme", "light");
        }
      }

      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "light") setTheme("light");
      else setTheme("dark");

      themeToggleBtn.addEventListener("click", () => {
        const currentTheme = document.body.getAttribute("data-theme");
        setTheme(currentTheme === "dark" ? "light" : "dark");
      });

      // --- EXTRACTION LOGIC ADAPTED FROM DMED ---
      let extractedData = [];
      let filteredData = [];

      async function processFiles(evt) {
        // Handle both FileList (from input) and array (if passed directly)
        const files = evt instanceof FileList ? Array.from(evt) : evt;
        if (!files || files.length === 0) return;

        const status = document.getElementById("statusMsg");
        status.innerHTML = `<span style="color: var(--data-blue)">●</span> Processando ${files.length} arquivos...`;

        let allXmlContents = [];

        // Helper to read file
        const readFileAsText = (file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(e);
            reader.readAsText(file);
          });
        };

        try {
          for (const file of files) {
            const lowerName = file.name.toLowerCase();
            if (lowerName.endsWith(".xml")) {
              const text = await readFileAsText(file);
              allXmlContents.push(text.replace(/<\?xml[^>]*\?>/g, ""));
            } else if (lowerName.endsWith(".zip")) {
              const zip = await JSZip.loadAsync(file);
              for (const filename of Object.keys(zip.files)) {
                if (
                  filename.toLowerCase().endsWith(".xml") &&
                  !zip.files[filename].dir
                ) {
                  const text = await zip.files[filename].async("text");
                  allXmlContents.push(text.replace(/<\?xml[^>]*\?>/g, ""));
                }
              }
            }
          }

          if (allXmlContents.length === 0) {
            alert("Nenhum arquivo XML válido encontrado.");
            status.innerHTML =
              '<span style="color: var(--text-tertiary)">●</span> Aguardando...';
            return;
          }

          // Aggregate strict wrapper
          const aggregatedContent =
            "<Root>" + allXmlContents.join("\n") + "</Root>";
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(aggregatedContent, "text/xml");

          processXMLDoc(xmlDoc);
        } catch (e) {
          console.error(e);
          alert("Erro no processamento.");
        }
      }

      function processXMLDoc(xml) {
        let notas = [];

        // 1. ABRASF / Ginfes
        xml.querySelectorAll("InfNfse").forEach((n) => notas.push(n));

        // 2. Fallbacks
        if (notas.length === 0)
          xml.querySelectorAll("CompNfse").forEach((n) => notas.push(n));
        if (notas.length === 0)
          xml.querySelectorAll("Nfse").forEach((n) => notas.push(n));

        // 3. National / SPED
        xml.querySelectorAll("infNFSe").forEach((n) => notas.push(n));

        // 4. Robust fallback
        if (notas.length === 0) {
          const nNFSeElements = xml.querySelectorAll("nNFSe");
          if (nNFSeElements.length > 0) {
            const parents = new Set();
            nNFSeElements.forEach((el) => parents.add(el.parentElement));
            notas = Array.from(parents);
          }
        }

        // Helper for multipath text extraction
        const getText = (parent, selectors) => {
          for (const sel of selectors) {
            const el = parent.querySelector(sel);
            if (el && el.textContent) return el.textContent.trim();
          }
          return "";
        };

        extractedData = []; // Reset global data

        notas.forEach((nota) => {
          // Number
          const nNFSe = getText(nota, ["Numero", "nNFSe", "NuNfse"]) || "S/N";

          // Tomador
          const xNome =
            getText(nota, [
              "TomadorServico RazaoSocial",
              "toma xNome",
              "Tomador RazaoSocial",
              "Tomador Servico RazaoSocial",
              "DPS infDPS toma xNome", // SPED
            ]) || "Não consta";

          // CNPJ / CPF
          const cpf = getText(nota, [
            "TomadorServico Cpf",
            "toma CPF",
            "DPS infDPS toma CPF",
            "Cpf",
          ]);
          const cnpjRaw = getText(nota, [
            "TomadorServico Cnpj",
            "toma CNPJ",
            "DPS infDPS toma CNPJ",
            "Cnpj",
          ]);
          const doc = cpf || cnpjRaw || "Não consta";

          // Valor
          const valorRaw =
            getText(nota, [
              "ValorServicos",
              "vServ",
              "ValorServico",
              "vLiq",
              "vtLiq",
              "valor",
            ]) || "0.00";
          const valor = parseFloat(valorRaw.replace(",", ".")) || 0;

          // Descrição
          const xDescServ =
            getText(nota, [
              "Discriminacao",
              "xDescServ", // SPED
              "DiscriminacaoServico",
              "DPS infDPS serv cServ xDescServ",
            ]) || "Sem descrição";

          extractedData.push({ nNFSe, xNome, cnpj: doc, valor, xDescServ });
        });

        // Sort by number
        extractedData.sort((a, b) => {
          const numA = parseInt(String(a.nNFSe).replace(/\D/g, "")) || 0;
          const numB = parseInt(String(b.nNFSe).replace(/\D/g, "")) || 0;
          return numA - numB;
        });

        filteredData = [...extractedData];
        renderTable(filteredData);
      }

      function renderTable(data, searchTerm = "") {
        const tbody = document.querySelector("#resultTable tbody");
        tbody.innerHTML = "";
        const status = document.getElementById("statusMsg");

        // Neon Highlight Helper
        const h = (text) => {
          if (!searchTerm || !text) return text;
          const str = String(text);
          // Escape regex special chars
          const escaped = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const regex = new RegExp(`(${escaped})`, "gi");
          return str.replace(regex, '<span class="neon-highlight">$1</span>');
        };

        data.forEach((item) => {
          const row = tbody.insertRow();
          row.innerHTML = `
              <td>${h(item.nNFSe)}</td>
              <td><strong>${h(item.xNome)}</strong></td>
              <td>${h(item.cnpj)}</td>
              <td style="font-weight: 800; color: var(--text-primary);">${item.valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}</td>
              <td class="full-text" style="color: var(--text-secondary);">${h(item.xDescServ)}</td>
            `;
        });

        const total = data.reduce((acc, item) => acc + item.valor, 0);

        // Update Dashboard
        document.getElementById("totalDisplayValue").innerText =
          total.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
        document.getElementById("countDisplay").innerText = data.length;

        status.innerHTML = `<span style="color: var(--data-green)">●</span> ${data.length} registros exibidos.`;
      }

      function filterData() {
        const term = document.getElementById("searchInput").value.toLowerCase();
        filteredData = extractedData.filter((item) => {
          return (
            String(item.nNFSe).toLowerCase().includes(term) ||
            String(item.xNome).toLowerCase().includes(term) ||
            String(item.cnpj).toLowerCase().includes(term) ||
            String(item.xDescServ).toLowerCase().includes(term)
          );
        });
        renderTable(filteredData, term);
      }

      function exportToExcel() {
        if (filteredData.length === 0) {
          alert("Sem dados para exportar.");
          return;
        }

        const data = [
          ["Nota", "Tomador", "Documento", "Valor (R$)", "Descrição"],
        ];

        filteredData.forEach((item) => {
          data.push([
            item.nNFSe,
            item.xNome,
            item.cnpj,
            item.valor, // Maintains number format for Excel calculation
            item.xDescServ,
          ]);
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);

        // Column widths
        ws["!cols"] = [
          { wch: 10 }, // Nota
          { wch: 40 }, // Tomador
          { wch: 20 }, // Documento
          { wch: 15 }, // Valor
          { wch: 60 }, // Descrição
        ];

        XLSX.utils.book_append_sheet(wb, ws, "Extração NFSe");
        XLSX.writeFile(wb, "extracao_nfse_turbo.xlsx");
      }

      function downloadTXT() {
        if (filteredData.length === 0) {
          alert("Sem dados para exportar.");
          return;
        }
        let c =
          "RELATÓRIO DE EXTRAÇÃO - NFSE\n===================================\n\n";
        filteredData.forEach((item) => {
          c += `NOTA:    ${item.nNFSe}\nTOMADOR: ${item.xNome}\nDOC:     ${item.cnpj}\nVALOR:   ${item.valor.toLocaleString("pt-BR", { style: "currency", currency: "BRL" })}\nDESC:    ${item.xDescServ}\n-----------------------------------\n`;
        });
        const blob = new Blob([c], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "relatorio_notas.txt";
        a.click();
      }

      function clearData() {
        extractedData = [];
        filteredData = [];
        renderTable([]);
        document.getElementById("xmlInput").value = "";
        document.getElementById("searchInput").value = "";
        document.getElementById("totalDisplayValue").innerText = "0,00";
        document.getElementById("countDisplay").innerText = "0";
        document.getElementById("statusMsg").innerHTML =
          '<span style="color: var(--text-tertiary)">●</span> Aguardando...';
      }
    </script>
  </body>
</html>
