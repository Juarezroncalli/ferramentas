<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador de Importação Neo</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-body: #ffde00;
        --card-bg: #ffffff;
        --border-black: #000000;
        --c-purple: #8b5cf6;
        --c-pink: #ff90e8;
        --c-blue: #06b6d4;
        --c-green: #22c55e;
        --border-width: 3px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Space Grotesk", sans-serif;
        background-color: var(--bg-body);
        background-image: radial-gradient(#000 1px, transparent 1px);
        background-size: 20px 20px;
        color: var(--border-black);
        padding: 2rem;
        min-height: 100vh;
      }

      .container {
        max-width: 1000px;
        margin: auto;
        background: var(--card-bg);
        padding: 2rem;
        border: var(--border-width) solid var(--border-black);
        box-shadow: 10px 10px 0 0 var(--border-black);
      }

      h1 {
        text-align: center;
        margin-bottom: 1.5rem;
        font-weight: 900;
        text-transform: uppercase;
        font-size: 2rem;
        text-shadow: 3px 3px 0 var(--c-pink);
        border-bottom: var(--border-width) solid var(--border-black);
        padding-bottom: 1rem;
      }

      /* Área de Configuração */
      .config-area {
        background: var(--c-purple);
        padding: 1.5rem;
        border: var(--border-width) solid var(--border-black);
        margin-bottom: 1.5rem;
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        flex-wrap: wrap;
        box-shadow: 5px 5px 0 0 var(--border-black);
      }

      .input-group {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-width: 200px;
      }

      .input-group label {
        font-weight: 800;
        font-family: "Space Mono", monospace;
        text-transform: uppercase;
        font-size: 0.8rem;
        color: #fff;
        margin-bottom: 0.5rem;
      }

      .neo-input {
        padding: 0.8rem;
        border: var(--border-width) solid var(--border-black);
        font-family: "Space Mono", monospace;
        font-size: 1rem;
        font-weight: bold;
        outline: none;
        background: #fff;
      }

      .neo-input:focus {
        box-shadow: 4px 4px 0 0 var(--c-blue);
      }

      /* Botões */
      .actions {
        text-align: center;
        margin: 2rem 0;
        display: flex;
        justify-content: center;
        gap: 1rem;
      }

      .btn {
        background: #fff;
        color: var(--border-black);
        border: var(--border-width) solid var(--border-black);
        padding: 0.8rem 1.5rem;
        font-family: "Space Grotesk", sans-serif;
        font-weight: 900;
        text-transform: uppercase;
        cursor: pointer;
        font-size: 0.9rem;
        box-shadow: 4px 4px 0 0 var(--border-black);
        transition: 0.1s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 0 var(--border-black);
      }

      .btn-upload { background: var(--c-pink); }
      .btn-generate { background: var(--c-green); }

      .btn:active {
        transform: translate(2px, 2px);
        box-shadow: 2px 2px 0 0 var(--border-black);
      }

      /* Upload Area */
      .upload-area {
        background: #fff;
        border: var(--border-width) dashed var(--border-black);
        padding: 2rem;
        text-align: center;
        margin: 1.5rem 0;
        cursor: pointer;
        font-weight: 800;
        text-transform: uppercase;
        transition: 0.2s;
      }

      .upload-area.dragover {
        background: var(--c-blue);
        transform: scale(1.02);
      }

      /* Tabela */
      .table-container {
        overflow-x: auto;
        border: var(--border-width) solid var(--border-black);
        margin-top: 2rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-family: "Space Mono", monospace;
        background: #fff;
      }

      th, td {
        border: 1px solid var(--border-black);
        padding: 1rem;
        text-align: center;
      }

      th {
        background: var(--border-black);
        color: #fff;
        text-transform: uppercase;
        font-weight: 900;
      }

      tr:nth-child(even) { background: #f0f0f0; }

      #statusMsg {
        text-align: center;
        margin: 1rem 0;
        font-family: "Space Mono", monospace;
        font-weight: 900;
        background: var(--c-blue);
        padding: 0.5rem;
        border: 2px solid #000;
        display: none;
      }

      /* Result Box */
      #resultBox {
        margin-top: 2rem;
        padding: 1rem;
        border: var(--border-width) solid var(--border-black);
        background: #222;
        color: var(--c-green);
        white-space: pre-wrap;
        font-family: "Space Mono", monospace;
        max-height: 300px;
        overflow-y: auto;
        box-shadow: 5px 5px 0 0 var(--border-black);
      }

      @media (max-width: 768px) {
        body { padding: 1rem; }
        .actions { flex-direction: column; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <i class="fa-solid fa-file-invoice-dollar"></i> Importador Financeiro
      </h1>

      <div class="config-area">
        <div class="input-group">
          <label for="contaCartao">Alugueis a Receber (Débito)</label>
          <input type="text" id="contaCartao" class="neo-input" placeholder="Ex: 1001" />
        </div>
        <div class="input-group">
          <label for="contaClientes">Receita c/ alugueis (Crédito)</label>
          <input type="text" id="contaClientes" class="neo-input" placeholder="Ex: 2001" />
        </div>
      </div>

      <div class="actions">
        <input type="file" id="uploadExcel" accept=".xlsx, .xls, .csv" style="display: none" />
        <button id="uploadBtn" class="btn btn-upload">
          <i class="fa-solid fa-upload"></i> Importar CSV / Excel
        </button>
        <button id="generateTxt" class="btn btn-generate">
          <i class="fa-solid fa-file-export"></i> Gerar TXT
        </button>
      </div>

      <div class="upload-area" id="uploadArea">
        <i class="fa-solid fa-cloud-arrow-up"></i><br>
        Arraste o arquivo aqui ou use o botão acima
      </div>
      
      <div id="statusMsg"></div>

      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>ID (Fatura)</th>
              <th>Data Pagamento</th>
              <th>Valor</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="resultBox">O conteúdo do TXT aparecerá aqui após a geração...</div>
    </div>

    <script>
      const uploadExcelInput = document.getElementById("uploadExcel");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadArea = document.getElementById("uploadArea");
      const dataTableBody = document.querySelector("#dataTable tbody");
      const generateTxtBtn = document.getElementById("generateTxt");
      const resultBox = document.getElementById("resultBox");
      const statusMsg = document.getElementById("statusMsg");
      const inputContaCartao = document.getElementById("contaCartao");
      const inputContaClientes = document.getElementById("contaClientes");

      let importedData = [];

      function showStatus(msg) {
        statusMsg.style.display = "block";
        statusMsg.textContent = msg;
      }

      function formatDate(value) {
        if (!value) return "";
        if (!isNaN(value) && Number(value) > 20000) {
          const date = XLSX.SSF.parse_date_code(Number(value));
          return `${String(date.d).padStart(2, "0")}/${String(date.m).padStart(2, "0")}/${date.y}`;
        }
        if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
            const parts = value.split(" ")[0].split("-");
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return value;
      }

      function formatValue(value) {
        if (!value) return "0,00";
        let strVal = String(value).replace("R$", "").trim();
        if (strVal.includes(",") && strVal.includes(".")) {
             strVal = strVal.replace(/\./g, "").replace(",", ".");
        } else if (strVal.includes(",")) {
             strVal = strVal.replace(",", ".");
        }
        let num = parseFloat(strVal);
        if (isNaN(num)) return "0,00";
        return num.toFixed(2).replace(".", ",");
      }

      uploadBtn.addEventListener("click", () => uploadExcelInput.click());

      ["dragenter", "dragover"].forEach((evt) =>
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        })
      );
      ["dragleave", "drop"].forEach((evt) =>
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
        })
      );
      uploadArea.addEventListener("drop", (e) => handleFile(e.dataTransfer.files[0]));
      uploadExcelInput.addEventListener("change", (e) => handleFile(e.target.files[0]));

      function handleFile(file) {
        if (!file) return;
        showStatus("Lendo arquivo...");
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: "array" }); 
            const sheet = wb.Sheets[wb.SheetNames[0]];
            const rawData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            let headerRowIndex = -1;
            for (let i = 0; i < rawData.length; i++) {
                const rowStr = JSON.stringify(rawData[i]);
                if (rowStr.includes("Cobrança.Id")) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) {
                showStatus("Erro: Coluna 'Cobrança.Id' não encontrada.");
                return;
            }

            importedData = XLSX.utils.sheet_to_json(sheet, { range: headerRowIndex, defval: "" });
            showStatus(`Sucesso! ${importedData.length} registros carregados.`);
            renderTable();

          } catch (err) {
            showStatus("Erro no processamento.");
          }
        };
        reader.readAsArrayBuffer(file);
      }

      function renderTable() {
        dataTableBody.innerHTML = "";
        importedData.slice(0, 50).forEach((row) => {
          const id = row["Cobrança.Id"];
          const data = row["Cobrança.DataDePagamento"];
          const valor = row["Cobrança.Valor"];
          if (!id && !valor) return;

          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${id || ""}</td><td>${formatDate(data)}</td><td>${formatValue(valor)}</td>`;
          dataTableBody.appendChild(tr);
        });
      }

      generateTxtBtn.addEventListener("click", () => {
        if (importedData.length === 0) return alert("Importe o arquivo primeiro.");
        const contaCartao = inputContaCartao.value.trim();
        const contaClientes = inputContaClientes.value.trim();
        if (!contaCartao || !contaClientes) return alert("Preencha as contas contábeis.");

        let txtContent = "";
        importedData.forEach((row) => {
          const id = row["Cobrança.Id"];
          if (!id) return;
          const dataPagamento = formatDate(row["Cobrança.DataDePagamento"]);
          const valor = formatValue(row["Cobrança.Valor"]);
          txtContent += `${dataPagamento};${contaCartao};${contaClientes};${valor};;RECEITA DE LOCACAO, CONF. FATURA ${id};;;;\n`;
        });

        resultBox.textContent = txtContent;
        const blob = new Blob([txtContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "layout_importacao.txt";
        link.click();
      });
    </script>
  </body>
</html>