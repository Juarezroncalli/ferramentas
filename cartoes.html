<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador Cont치bil Neo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
      :root {
        /* Paleta Neo-Brutalismo baseada na imagem */
        --bg-color: #FFFDF5; /* Creme suave */
        --card-bg: #FFFFFF;
        
        --primary-green: #2DDD98; /* Verde menta vibrante */
        --primary-yellow: #FFF59D; /* Amarelo pastel */
        --primary-purple: #D6BCFA; /* Lil치s */
        --primary-pink: #FF9EB5;
        
        --text-main: #000000;
        --border-black: #000000;
        
        --shadow-hard: 4px 4px 0px 0px #000000;
        --shadow-hover: 2px 2px 0px 0px #000000;
        
        --border-width: 3px;
        --radius: 12px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        height: 100vh;
        overflow-x: hidden;
        display: flex;
      }

      /* --- Layout Sidebar + Content --- */
      .sidebar {
        width: 250px;
        background: var(--card-bg);
        border-right: var(--border-width) solid var(--border-black);
        display: flex;
        flex-direction: column;
        padding: 2rem 1.5rem;
        flex-shrink: 0;
      }

      .logo {
        font-weight: 800;
        font-size: 1.4rem;
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 3rem;
      }

      .logo i {
        background: var(--primary-yellow);
        padding: 8px;
        border: var(--border-width) solid var(--border-black);
        border-radius: 50%;
        box-shadow: 2px 2px 0 0 black;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        font-weight: 600;
        color: #555;
        cursor: pointer;
        transition: 0.2s;
        border-radius: var(--radius);
        border: 2px solid transparent;
      }

      .nav-item.active {
        background-color: var(--primary-green);
        color: black;
        border: var(--border-width) solid var(--border-black);
        box-shadow: var(--shadow-hard);
      }

      .nav-item:hover:not(.active) {
        background-color: #f0f0f0;
      }

      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
      }

      /* --- Componentes Neo-Brutalist --- */
      .neo-card {
        background: var(--card-bg);
        border: var(--border-width) solid var(--border-black);
        border-radius: var(--radius);
        box-shadow: var(--shadow-hard);
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .neo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        background: var(--card-bg);
        border: var(--border-width) solid var(--border-black);
        border-radius: 50px; /* Pill shape */
        padding: 1rem 2rem;
        box-shadow: var(--shadow-hard);
      }

      .header-title h1 {
        font-weight: 800;
        font-size: 2rem;
      }
      .header-title span {
        font-size: 1rem;
        font-weight: 600;
        color: #666;
      }

      /* Inputs Grid */
      .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .config-item {
        background: var(--card-bg);
        border: var(--border-width) solid var(--border-black);
        border-radius: var(--radius);
        padding: 1rem;
        box-shadow: var(--shadow-hard);
        position: relative;
        transition: transform 0.2s;
      }
      
      .config-item:hover {
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 0 black;
      }

      /* Cores espec칤ficas para os cards de input */
      .config-item:nth-child(1) { background-color: #fdf2f8; /* Pink tint */ }
      .config-item:nth-child(1) .icon-box { background: var(--primary-pink); }
      
      .config-item:nth-child(2) { background-color: #f0fdf4; /* Green tint */ }
      .config-item:nth-child(2) .icon-box { background: var(--primary-green); }

      .config-item:nth-child(3) { background-color: #fffbeb; /* Yellow tint */ }
      .config-item:nth-child(3) .icon-box { background: var(--primary-yellow); }
      
      .config-item:nth-child(4) { background-color: #f3e8ff; /* Purple tint */ }
      .config-item:nth-child(4) .icon-box { background: var(--primary-purple); }

      .config-item label {
        font-weight: 700;
        font-size: 0.9rem;
        display: block;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .icon-box {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid black;
        border-radius: 6px;
        font-size: 0.8rem;
      }

      .neo-input {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid var(--border-black);
        border-radius: 8px;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        outline: none;
      }
      .neo-input:focus {
        background-color: #fff;
        box-shadow: 2px 2px 0 0 black;
      }

      /* Upload Area */
      .upload-container {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
      }

      .upload-section {
        flex: 2;
        min-width: 300px;
      }

      .actions-section {
        flex: 1;
        min-width: 250px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .upload-area {
        background: #fff;
        border: 3px dashed var(--border-black);
        border-radius: var(--radius);
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: 0.3s;
        position: relative;
        overflow: hidden;
      }

      .upload-area:hover {
        background-color: #f9f9f9;
        border-style: solid;
        transform: translate(-2px, -2px);
        box-shadow: var(--shadow-hard);
      }

      .upload-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--text-main);
      }

      /* Buttons */
      .neo-btn {
        padding: 1rem 1.5rem;
        font-weight: 800;
        font-size: 1rem;
        border: var(--border-width) solid var(--border-black);
        border-radius: var(--radius);
        cursor: pointer;
        box-shadow: var(--shadow-hard);
        transition: all 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .neo-btn:active {
        box-shadow: 0 0 0 0 black;
        transform: translate(4px, 4px);
      }
      
      .neo-btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: translate(4px, 4px);
      }

      .btn-primary { background-color: var(--primary-green); color: black; }
      .btn-secondary { background-color: var(--primary-purple); color: black; }
      .btn-warning { background-color: var(--primary-yellow); color: black; }
      .btn-black { background-color: black; color: white; }

      /* File Info */
      .file-info {
        margin-top: 1rem;
        background: #eee;
        border: 2px solid black;
        padding: 1rem;
        border-radius: 8px;
        display: none;
      }
      .file-info.show { display: block; }
      
      /* Tabela e Resultados */
      .results-area {
        margin-top: 2rem;
      }

      .summary-cards {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .summary-card {
        flex: 1;
        background: black;
        color: white;
        padding: 1.5rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow-hard);
      }
      .summary-card.negative {
        background: #FF5252;
        border: var(--border-width) solid black;
        color: black;
      }
      
      .summary-label { font-size: 0.8rem; text-transform: uppercase; opacity: 0.8; }
      .summary-value { font-size: 1.8rem; font-weight: 800; margin-top: 5px; }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border: var(--border-width) solid black;
        border-radius: var(--radius);
        overflow: hidden;
        background: white;
      }

      th {
        background: var(--primary-yellow);
        border-bottom: var(--border-width) solid black;
        padding: 1rem;
        text-align: left;
        font-weight: 800;
      }
      
      td {
        padding: 1rem;
        border-bottom: 1px solid #ddd;
        font-weight: 500;
      }
      
      tr:last-child td { border-bottom: none; }
      tr:hover td { background-color: #fafafa; }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        backdrop-filter: blur(4px);
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0; pointer-events: none;
        transition: 0.3s;
      }
      .modal-overlay.show { opacity: 1; pointer-events: all; }
      
      .modal-content {
        background: white;
        width: 600px;
        max-width: 90%;
        border: var(--border-width) solid black;
        box-shadow: 8px 8px 0 0 black;
        border-radius: var(--radius);
        padding: 2rem;
        position: relative;
      }

      .modal-close {
        position: absolute;
        top: 1rem; right: 1rem;
        background: #FF5252;
        border: 2px solid black;
        width: 30px; height: 30px;
        border-radius: 50%;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold;
      }

      .hidden { display: none !important; }
      
      .loading-spinner {
        border: 4px solid rgba(0,0,0,0.1);
        border-left: 4px solid black;
        border-radius: 50%;
        width: 40px; height: 40px;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* Responsividade */
      @media (max-width: 768px) {
        body { flex-direction: column; }
        .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 3px solid black; flex-direction: row; align-items: center; overflow-x: auto; padding: 1rem; }
        .logo { margin-bottom: 0; margin-right: 2rem; }
        .nav-item { margin-bottom: 0; white-space: nowrap; }
        .neo-header { flex-direction: column; gap: 1rem; text-align: center; border-radius: var(--radius); }
        .config-grid { grid-template-columns: 1fr; }
        .upload-container { flex-direction: column; }
      }
    </style>
  </head>
  <body>
    
    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-wallet"></i>
        <span>ContabilApp</span>
      </div>
      <nav>
        <div class="nav-item active">
          <i class="fas fa-file-invoice-dollar"></i> Gerador
        </div>
        <div class="nav-item" onclick="document.getElementById('info-modal').classList.add('show')">
          <i class="fas fa-question-circle"></i> Ajuda
        </div>
      </nav>
    </aside>

    <main class="main-content">
      
      <div class="neo-header">
        <div class="header-title">
          <h1>Ol치, Contador! 游녦</h1>
          <span>Vamos consolidar os lan칞amentos de hoje?</span>
        </div>
        <button class="neo-btn btn-black" id="info-btn">
          <i class="fas fa-info"></i> Instru칞칫es
        </button>
      </div>

      <div class="config-grid">
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-users"></i></div>
            CONTA CLIENTES
          </label>
          <input type="text" class="neo-input" id="conta-clientes" placeholder="Ex: 27" />
        </div>
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-credit-card"></i></div>
            CONTA CART츾O
          </label>
          <input type="text" class="neo-input" id="conta-cartao" placeholder="Ex: 31" />
        </div>
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-tags"></i></div>
            CONTA TARIFAS
          </label>
          <input type="text" class="neo-input" id="conta-tarifas" placeholder="Ex: 957" />
        </div>
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-flag"></i></div>
            BANDEIRA (Opcional)
          </label>
          <input type="text" class="neo-input" id="bandeira-cartao" placeholder="Ex: VISA" />
        </div>
      </div>

      <section id="upload-section" class="upload-container">
        
        <div class="upload-section">
          <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt fa-bounce"></i>
            </div>
            <h3>Arraste sua planilha aqui</h3>
            <p style="color: #666; margin-top: 0.5rem;">ou clique para buscar arquivos .xlsx</p>
            <input type="file" id="file-input" accept=".xlsx, .xls" multiple style="display: none;" />
          </div>
          
          <div class="file-info" id="file-info">
            <strong><i class="fas fa-check-circle"></i> Arquivos prontos:</strong>
            <ul id="file-list" style="margin-top: 0.5rem; padding-left: 1.2rem;"></ul>
          </div>
        </div>

        <div class="actions-section">
          <button class="neo-btn btn-secondary" id="generate-model-btn">
            <i class="fas fa-file-excel"></i> Baixar Modelo
          </button>
          
          <button class="neo-btn btn-primary" id="process-btn" disabled style="height: 100%;">
            <i class="fas fa-cogs"></i> PROCESSAR DADOS
          </button>
        </div>

      </section>

      <section id="loading-section" class="hidden" style="text-align: center; padding: 3rem;">
        <div class="loading-spinner"></div>
        <h3>Processando n칰meros...</h3>
      </section>

      <section id="preview-section" class="hidden results-area">
        <h2 style="margin-bottom: 1rem; border-bottom: 4px solid var(--primary-green); display: inline-block;">
          Resultados Consolidados
        </h2>
        
        <div class="summary-cards">
            <div class="summary-card" style="background: black;">
                <span class="summary-label">Total Bruto</span>
                <div class="summary-value" id="total-vendas-valor" style="color: var(--primary-green);">R$ 0,00</div>
            </div>
            <div class="summary-card negative">
                <span class="summary-label" style="color: black;">Total Tarifas</span>
                <div class="summary-value" id="total-tarifas-valor">R$ 0,00</div>
            </div>
            <div class="summary-card" style="background: white; color: black; border: 3px solid black;">
                <span class="summary-label">L칤quido Estimado</span>
                <div class="summary-value" id="total-liquido-calc">R$ 0,00</div>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table id="preview-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Valor Bruto</th>
                  <th>Valor L칤quido</th>
                  <th>Valor Taxa</th>
                  <th>% Taxa</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>

        <button id="generate-btn" class="neo-btn btn-primary" style="width: 100%; margin-top: 2rem;">
            <i class="fas fa-download"></i> BAIXAR ARQUIVO .TXT FINAL
        </button>
      </section>

    </main>

    <div class="modal-overlay" id="info-modal">
      <div class="modal-content">
        <button class="modal-close" id="close-modal-btn">&times;</button>
        <h2 style="margin-bottom: 1rem;">Como usar o Gerador</h2>
        
        <div style="background: var(--primary-yellow); padding: 1rem; border: 2px solid black; border-radius: 8px; margin-bottom: 1rem;">
            <strong>Passo 1:</strong> Preencha as contas cont치beis no topo.
        </div>
        <div style="background: var(--primary-pink); padding: 1rem; border: 2px solid black; border-radius: 8px; margin-bottom: 1rem;">
            <strong>Passo 2:</strong> Use o bot칚o "Baixar Modelo" se n칚o souber o formato da planilha. As colunas DATA e VALOR BRUTO s칚o obrigat칩rias.
        </div>
        <div style="background: var(--primary-green); padding: 1rem; border: 2px solid black; border-radius: 8px;">
            <strong>Passo 3:</strong> Arraste o arquivo, clique em Processar e depois baixe o TXT.
        </div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("file-input");
      const processBtn = document.getElementById("process-btn");
      const uploadArea = document.querySelector(".upload-area");
      const fileInfo = document.getElementById("file-info");
      const fileList = document.getElementById("file-list");
      const contaCartaoInput = document.getElementById("conta-cartao");
      const contaClientesInput = document.getElementById("conta-clientes");
      const contaTarifasInput = document.getElementById("conta-tarifas");
      const bandeiraCartaoInput = document.getElementById("bandeira-cartao");
      const uploadSection = document.getElementById("upload-section");
      const loadingSection = document.getElementById("loading-section");
      const previewSection = document.getElementById("preview-section");
      const previewTableBody = document.querySelector("#preview-table tbody");
      const generateBtn = document.getElementById("generate-btn");
      const generateModelBtn = document.getElementById("generate-model-btn");
      const infoBtn = document.getElementById("info-btn");
      const infoModal = document.getElementById("info-modal");
      const closeModalBtn = document.getElementById("close-modal-btn");

      let processedData = [];
      let selectedFiles = [];

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(
          eventName,
          (e) => {
            e.preventDefault();
            e.stopPropagation();
          },
          false
        );
      });
      uploadArea.addEventListener("drop", (e) =>
        handleFileSelect(e.dataTransfer.files)
      );
      fileInput.addEventListener("change", (e) =>
        handleFileSelect(e.target.files)
      );
      processBtn.addEventListener("click", processFiles);
      generateBtn.addEventListener("click", generateAndDownload);
      generateModelBtn.addEventListener("click", generateModelSheet);
      infoBtn.addEventListener("click", () => infoModal.classList.add("show"));
      closeModalBtn.addEventListener("click", () =>
        infoModal.classList.remove("show")
      );
      infoModal.addEventListener("click", (e) => {
        if (e.target === infoModal) {
          infoModal.classList.remove("show");
        }
      });

      function handleFileSelect(files) {
        if (!files || files.length === 0) return;
        selectedFiles = Array.from(files);
        fileList.innerHTML = "";
        selectedFiles.forEach((file) => {
          const listItem = document.createElement("li");
          listItem.innerHTML = `${file.name}`;
          fileList.appendChild(listItem);
        });
        fileInfo.classList.add("show");
        processBtn.disabled = false;
        showSection("upload");
      }

      function generateModelSheet() {
        const wb = XLSX.utils.book_new();
        const ws_data = [
          ["DATA", "VALOR BRUTO", "VALOR LIQUIDO", "TAXA"],
          ["01/07/2025", "150,00", "145,50", ""],
          ["01/07/2025", "200,00", "", "10,00"],
          ["02/07/2025", "500,00", "", ""],
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws["!cols"] = [{ wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, ws, "Lancamentos");
        XLSX.writeFile(wb, "Modelo_Lancamentos.xlsx");
      }

      async function processFiles() {
        const requiredInputs = [
          contaCartaoInput,
          contaClientesInput,
          contaTarifasInput,
        ];
        if (requiredInputs.some((input) => !input.value.trim())) {
          alert(
            "丘멆잺 Por favor, preencha os campos de contas (Clientes, Cart칚o e Tarifas)."
          );
          return;
        }
        if (selectedFiles.length === 0) {
          alert("丘멆잺 Selecione pelo menos um arquivo Excel.");
          return;
        }
        showSection("loading");
        try {
          const allRows = await readFiles(selectedFiles);
          const consolidatedData = consolidateData(allRows);
          processedData = consolidatedData;
          displayPreview();
          showSection("preview");
        } catch (error) {
          alert(`Ocorreu um erro: ${error.message}`);
          showSection("upload");
        }
      }

      function generateAndDownload() {
        if (processedData.length === 0) {
          alert("N칚o h치 dados para gerar o arquivo.");
          return;
        }
        const contaCartao = contaCartaoInput.value.trim();
        const contaClientes = contaClientesInput.value.trim();
        const contaTarifas = contaTarifasInput.value.trim();
        const bandeira = bandeiraCartaoInput.value.trim().toUpperCase();

        let historicoVenda =
          "VALOR DE VENDAS C/ CARTAO DE CREDITO/DEBITO, CONF. EXTRATO";
        let historicoTaxa =
          "TAXA OPERADORA DE CARTOES CREDITO/DEBITO, CONF. EXTRATO";

        if (bandeira) {
          historicoVenda += ` ${bandeira}`;
          historicoTaxa += ` ${bandeira}`;
        }

        let txtContent = [];
        processedData.forEach((data) => {
          const valorBrutoStr = data.valorBruto.toFixed(2).replace(".", ",");
          const valorTaxaStr = data.valorTaxa.toFixed(2).replace(".", ",");
          txtContent.push(
            `${data.data};${contaCartao};${contaClientes};${valorBrutoStr};;${historicoVenda};;;;`
          );
          if (Math.abs(data.valorTaxa) > 0.005) {
            txtContent.push(
              `${data.data};${contaTarifas};${contaCartao};${valorTaxaStr};;${historicoTaxa};;;;`
            );
          }
        });

        const blob = new Blob([txtContent.join("\r\n")], {
          type: "text/plain;charset=utf-8",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(
          today.getMonth() + 1
        ).padStart(2, "0")}${String(today.getDate()).padStart(2, "0")}`;
        const fileNameBandeira = bandeira
          ? bandeira.replace(/\s+/g, "_")
          : "GERAL";
        link.download = `LANCAMENTOS_${fileNameBandeira}_${dateStr}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      async function readFiles(files) {
        const filePromises = files.map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  raw: true,
                });
                if (jsonData.length === 0) return resolve([]);
                const firstRow = jsonData[0];
                const colMap = {
                  data: findKeyForColumn(firstRow, "DATA"),
                  bruto: findKeyForColumn(firstRow, "VALOR BRUTO"),
                  liquido: findKeyForColumn(firstRow, "VALOR LIQUIDO"),
                  taxa: findKeyForColumn(firstRow, "TAXA"),
                };
                if (!colMap.data || !colMap.bruto) {
                  return reject(
                    new Error(
                      `No arquivo "${file.name}", colunas "DATA" e "VALOR BRUTO" n칚o encontradas.`
                    )
                  );
                }
                const fileData = [];
                jsonData.forEach((row) => {
                  const dataVenda = row[colMap.data];
                  const valorBruto = parseCurrency(row[colMap.bruto]);
                  if (!dataVenda || isNaN(valorBruto) || valorBruto === 0)
                    return;

                  let valorLiquido = valorBruto;
                  let valorTaxa = 0;

                  const rawLiquido = parseCurrency(row[colMap.liquido]);
                  const rawTaxa = parseCurrency(row[colMap.taxa]);

                  if (colMap.liquido && !isNaN(rawLiquido) && rawLiquido > 0) {
                    valorTaxa = valorBruto - rawLiquido;
                    valorLiquido = rawLiquido;
                  } else if (colMap.taxa && !isNaN(rawTaxa)) {
                    valorTaxa = rawTaxa;
                    valorLiquido = valorBruto - rawTaxa;
                  }

                  const formattedDate = formatDate(dataVenda);
                  if (!formattedDate) return;

                  fileData.push({
                    data: formattedDate,
                    valorBruto: valorBruto,
                    valorLiquido: valorLiquido,
                    valorTaxa: valorTaxa,
                  });
                });
                resolve(fileData);
              } catch (error) {
                reject(
                  new Error(
                    `Erro ao ler "${file.name}": ${error.message}`
                  )
                );
              }
            };
            reader.onerror = () =>
              reject(new Error(`Erro leitura arquivo ${file.name}.`));
            reader.readAsArrayBuffer(file);
          });
        });
        const results = await Promise.all(filePromises);
        return [].concat(...results);
      }

      function consolidateData(rows) {
        const dailyTotals = new Map();
        rows.forEach((row) => {
          if (!row.data) return;
          const existing = dailyTotals.get(row.data);
          if (existing) {
            existing.valorBruto += row.valorBruto;
            existing.valorLiquido += row.valorLiquido;
            existing.valorTaxa += row.valorTaxa;
          } else {
            dailyTotals.set(row.data, {
              data: row.data,
              valorBruto: row.valorBruto,
              valorLiquido: row.valorLiquido,
              valorTaxa: row.valorTaxa,
            });
          }
        });
        return Array.from(dailyTotals.values()).sort((a, b) =>
          a.data
            .split("/")
            .reverse()
            .join("-")
            .localeCompare(b.data.split("/").reverse().join("-"))
        );
      }

      function displayPreview() {
        previewTableBody.innerHTML = "";
        const totalVendasEl = document.getElementById("total-vendas-valor");
        const totalTarifasEl = document.getElementById("total-tarifas-valor");
        const totalLiquidoEl = document.getElementById("total-liquido-calc");

        if (processedData.length === 0) {
          previewTableBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Nenhum dado v치lido encontrado.</td></tr>';
          totalVendasEl.textContent = formatBRL(0);
          totalTarifasEl.textContent = formatBRL(0);
          if(totalLiquidoEl) totalLiquidoEl.textContent = formatBRL(0);
          generateBtn.disabled = true;
          return;
        }

        const totalVendas = processedData.reduce(
          (sum, item) => sum + item.valorBruto,
          0
        );
        const totalTarifas = processedData.reduce(
          (sum, item) => sum + item.valorTaxa,
          0
        );
        const totalLiquido = totalVendas - totalTarifas;

        processedData.forEach((data) => {
          const row = document.createElement("tr");
          const taxaPercentual =
            data.valorBruto > 0 ? data.valorTaxa / data.valorBruto : 0;
          const taxaPercentualStr = taxaPercentual.toLocaleString("pt-BR", {
            style: "percent",
            minimumFractionDigits: 2,
          });

          const estiloTaxaPercentual =
            taxaPercentual > 0.05
              ? 'style="color: red; font-weight: 800;"'
              : "";

          row.innerHTML = `
                <td>${data.data}</td>
                <td>${formatBRL(data.valorBruto)}</td>
                <td>${formatBRL(data.valorLiquido)}</td>
                <td style="color: #FF5252; font-weight:bold;">${formatBRL(
                  data.valorTaxa
                )}</td>
                <td ${estiloTaxaPercentual}>${taxaPercentualStr}</td>
            `;
          previewTableBody.appendChild(row);
        });

        totalVendasEl.textContent = formatBRL(totalVendas);
        totalTarifasEl.textContent = formatBRL(totalTarifas);
        if(totalLiquidoEl) totalLiquidoEl.textContent = formatBRL(totalLiquido);
        
        generateBtn.disabled = false;
      }

      function findKeyForColumn(row, targetColumnName) {
        const lowerCaseTarget = targetColumnName.toLowerCase().trim();
        for (const key of Object.keys(row)) {
          if (key.toLowerCase().trim() === lowerCaseTarget) return key;
        }
        return null;
      }

      function parseCurrency(value) {
        if (value === null || value === undefined) return NaN;
        if (typeof value === "number") return value;
        let s = String(value).replace(/[^0-9,.]/g, "");
        if (s === "") return NaN;
        const lastComma = s.lastIndexOf(",");
        const lastDot = s.lastIndexOf(".");
        if (lastComma > lastDot) {
          s = s.replace(/\./g, "").replace(",", ".");
        } else {
          s = s.replace(/,/g, "");
        }
        return parseFloat(s) || 0;
      }

      function formatDate(excelDate) {
        if (excelDate === null || excelDate === undefined) return null;
        if (typeof excelDate === "number") {
          const jsDate = XLSX.SSF.parse_date_code(excelDate);
          if (jsDate) {
            const day = String(jsDate.d).padStart(2, "0");
            const month = String(jsDate.m).padStart(2, "0");
            const year = jsDate.y;
            return `${day}/${month}/${year}`;
          }
        }
        if (typeof excelDate === "string") {
          const parts = excelDate.split(/[/.-]/);
          if (parts.length === 3) {
            let day, month, year;
            if (parts[2].length === 4) {
              day = parts[0];
              month = parts[1];
              year = parts[2];
            } else if (parts[0].length === 4) {
              day = parts[2];
              month = parts[1];
              year = parts[0];
            }
            if (day && month && year) {
              return `${String(day).padStart(2, "0")}/${String(month).padStart(
                2,
                "0"
              )}/${year}`;
            }
          }
        }
        return null;
      }

      function formatBRL(value) {
        return value.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      function showSection(sectionName) {
        ["upload", "loading", "preview"].forEach((sec) => {
            const el = document.getElementById(`${sec}-section`);
            if(el) el.classList.add("hidden");
        });
        const target = document.getElementById(`${sectionName}-section`);
        if (target) target.classList.remove("hidden");
      }
    </script>
  </body>
</html>