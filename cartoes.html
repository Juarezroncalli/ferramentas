<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador Contábil [BRUTALISM]</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
      :root {
        /* --- PALETA VIBRANTE (Mesma do Dashboard) --- */
        --bg-body: #06B6D4; /* Ciano (Fundo Azul) */
        --card-bg: #FFFFFF;
        --border-black: #000000;
        
        --color-primary: #8B5CF6;   /* Roxo */
        --color-secondary: #F472B6; /* Rosa */
        --color-accent: #FACC15;    /* Amarelo */
        --color-success: #22C55E;   /* Verde */
        --color-danger: #EF4444;    /* Vermelho */
        
        --shadow-dist: 6px;
        --border-width: 3px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Space Grotesk', sans-serif;
        /* FUNDO AZUL QUADRICULADO */
        background-color: var(--bg-body);
        background-image: 
            linear-gradient(#fff 2px, transparent 2px),
            linear-gradient(90deg, #fff 2px, transparent 2px);
        background-size: 40px 40px;
        background-position: -2px -2px;
        
        color: var(--border-black);
        height: 100vh;
        overflow: hidden; /* Sidebar fixa */
        display: flex;
      }

      /* --- Layout Sidebar + Content --- */
      .sidebar {
        width: 280px;
        background: var(--color-accent); /* Amarelo */
        border-right: var(--border-width) solid var(--border-black);
        display: flex;
        flex-direction: column;
        padding: 2rem 1.5rem;
        flex-shrink: 0;
        overflow-y: auto;
        box-shadow: 4px 0 0 rgba(0,0,0,0.1);
      }

      .logo {
        font-weight: 900;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 3rem;
        text-transform: uppercase;
        letter-spacing: -1px;
      }

      .logo i {
        background: var(--color-primary);
        color: #fff;
        padding: 10px;
        border: var(--border-width) solid var(--border-black);
        box-shadow: 4px 4px 0 0 black;
        font-size: 1.2rem;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px;
        margin-bottom: 1rem;
        font-weight: 800;
        color: #000;
        cursor: pointer;
        transition: 0.1s;
        border: var(--border-width) solid var(--border-black);
        background: #fff;
        box-shadow: 4px 4px 0 0 black;
        text-transform: uppercase;
        font-size: 0.9rem;
      }

      .nav-item.active {
        background-color: var(--color-primary);
        color: #fff;
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 0 black;
      }

      .nav-item:hover:not(.active) {
        transform: translate(-2px, -2px);
        box-shadow: 6px 6px 0 0 black;
      }

      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
      }

      /* --- Componentes Neo-Brutalist --- */
      .neo-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2.5rem;
        background: #fff;
        border: var(--border-width) solid var(--border-black);
        padding: 2rem;
        box-shadow: var(--shadow-dist) var(--shadow-dist) 0 #000;
      }

      .header-title h1 {
        font-weight: 900;
        font-size: 2.5rem;
        text-transform: uppercase;
        margin-bottom: 0.5rem;
        text-shadow: 2px 2px 0 #ddd;
      }
      .header-title span {
        font-family: 'Space Mono', monospace;
        font-size: 0.9rem;
        font-weight: 700;
        background: var(--color-secondary);
        color: #fff;
        padding: 5px 10px;
        border: 2px solid #000;
      }

      /* Inputs Grid */
      .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .config-item {
        background: #fff;
        border: var(--border-width) solid var(--border-black);
        padding: 1.5rem;
        box-shadow: var(--shadow-dist) var(--shadow-dist) 0 #000;
        position: relative;
        transition: transform 0.2s;
      }
      
      .config-item:hover {
        transform: translate(-3px, -3px);
        box-shadow: 8px 8px 0 0 black;
        z-index: 2;
      }

      /* Ícones coloridos nos inputs */
      .config-item:nth-child(1) .icon-box { background: var(--color-secondary); color: #fff; } /* Rosa */
      .config-item:nth-child(2) .icon-box { background: var(--color-success); color: #000; }   /* Verde */
      .config-item:nth-child(3) .icon-box { background: var(--color-accent); color: #000; }    /* Amarelo */
      .config-item:nth-child(4) .icon-box { background: var(--color-primary); color: #fff; }   /* Roxo */

      .config-item label {
        font-weight: 800;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Space Mono', monospace;
        text-transform: uppercase;
      }

      .icon-box {
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid black;
        font-size: 1rem;
        box-shadow: 2px 2px 0 0 black;
      }

      .neo-input {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--border-black);
        font-family: 'Space Mono', monospace;
        font-size: 1rem;
        background: #F3F4F6;
        outline: none;
        transition: all 0.2s;
      }
      .neo-input:focus {
        background-color: #fff;
        box-shadow: 4px 4px 0 0 black;
        transform: translate(-2px, -2px);
      }

      /* Upload Area */
      .upload-container {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin-bottom: 3rem;
      }

      .upload-section {
        flex: 2;
        min-width: 300px;
      }

      .actions-section {
        flex: 1;
        min-width: 250px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .upload-area {
        background: #FEF9C3; /* Amarelo pálido */
        border: 3px dashed var(--border-black);
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: 0.2s;
        position: relative;
        overflow: hidden;
      }

      .upload-area:hover {
        background-color: var(--color-accent);
        border-style: solid;
        transform: translate(-4px, -4px);
        box-shadow: 8px 8px 0 0 black;
      }

      .upload-icon {
        font-size: 3.5rem;
        margin-bottom: 1rem;
        color: var(--border-black);
      }

      /* Buttons */
      .neo-btn {
        padding: 15px;
        font-weight: 800;
        font-size: 1rem;
        font-family: 'Space Grotesk', sans-serif;
        border: var(--border-width) solid var(--border-black);
        cursor: pointer;
        box-shadow: 4px 4px 0 0 black;
        transition: all 0.1s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        text-transform: uppercase;
      }

      .neo-btn:active {
        box-shadow: 0 0 0 0 black;
        transform: translate(4px, 4px);
      }
      
      .neo-btn:disabled {
        background-color: #e5e5e5;
        color: #888;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn-primary { background-color: var(--color-success); color: black; }
      .btn-secondary { background-color: #fff; color: black; }
      .btn-black { background-color: black; color: white; }
      
      .btn-secondary:hover { background-color: var(--color-secondary); color: #fff; }

      /* File Info */
      .file-info {
        margin-top: 1rem;
        background: #fff;
        border: 2px solid black;
        padding: 1rem;
        box-shadow: 4px 4px 0 0 var(--color-primary);
        display: none;
      }
      .file-info.show { display: block; }
      
      /* Tabela e Resultados */
      .results-area {
        margin-top: 2rem;
        background: #fff;
        border: var(--border-width) solid black;
        padding: 2rem;
        box-shadow: var(--shadow-dist) var(--shadow-dist) 0 #000;
      }

      .summary-cards {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }
      
      .summary-card {
        flex: 1;
        min-width: 200px;
        background: black;
        color: white;
        padding: 1.5rem;
        border: var(--border-width) solid black;
        box-shadow: 6px 6px 0 0 rgba(0,0,0,0.3);
      }
      
      .summary-card.negative {
        background: var(--color-danger);
        color: #fff;
      }
      
      .summary-card.liquid {
        background: #fff;
        color: black;
        box-shadow: 6px 6px 0 0 var(--color-success);
      }
      
      .summary-label { 
        font-family: 'Space Mono', monospace; 
        font-size: 0.8rem; 
        text-transform: uppercase; 
        display: block;
        margin-bottom: 5px;
      }
      .summary-value { font-size: 1.8rem; font-weight: 800; }

      table {
        width: 100%;
        border-collapse: collapse;
        border: var(--border-width) solid black;
        background: white;
        margin-top: 1rem;
      }

      th {
        background: black;
        color: #fff;
        border: 1px solid black;
        padding: 1rem;
        text-align: left;
        font-family: 'Space Mono', monospace;
        text-transform: uppercase;
      }
      
      td {
        padding: 1rem;
        border: 1px solid black;
        font-family: 'Space Mono', monospace;
      }
      
      tr:nth-child(even) td { background-color: #F3F4F6; }

      /* Modal */
      .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(139, 92, 246, 0.8); /* Roxo translúcido */
        backdrop-filter: blur(5px);
        z-index: 999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0; pointer-events: none;
        transition: 0.3s;
      }
      .modal-overlay.show { opacity: 1; pointer-events: all; }
      
      .modal-content {
        background: white;
        width: 600px;
        max-width: 90%;
        border: 4px solid black;
        box-shadow: 12px 12px 0 0 black;
        padding: 2.5rem;
        position: relative;
      }

      .modal-close {
        position: absolute;
        top: 1rem; right: 1rem;
        background: var(--color-danger);
        color: #fff;
        border: 2px solid black;
        width: 35px; height: 35px;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold;
        box-shadow: 2px 2px 0 0 black;
      }
      .modal-close:hover { transform: translate(-1px, -1px); box-shadow: 3px 3px 0 0 black; }

      .hidden { display: none !important; }
      
      .loading-spinner {
        border: 5px solid rgba(0,0,0,0.1);
        border-left: 5px solid var(--color-primary);
        border-radius: 50%;
        width: 50px; height: 50px;
        animation: spin 1s linear infinite;
        margin: 2rem auto;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* Responsividade */
      @media (max-width: 768px) {
        body { flex-direction: column; overflow: auto; }
        .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 3px solid black; flex-direction: row; align-items: center; overflow-x: auto; padding: 1rem; }
        .logo { margin-bottom: 0; margin-right: 2rem; }
        .nav-item { margin-bottom: 0; white-space: nowrap; }
        .neo-header { flex-direction: column; gap: 1rem; text-align: center; }
        .config-grid { grid-template-columns: 1fr; }
        .upload-container { flex-direction: column; }
      }
    </style>
  </head>
  <body>
    
    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-wallet"></i>
        <span>ContabilApp</span>
      </div>
      <nav>
        <div class="nav-item active">
          <i class="fas fa-file-invoice-dollar"></i> Gerador
        </div>
        <div class="nav-item" onclick="document.getElementById('info-modal').classList.add('show')">
          <i class="fas fa-question-circle"></i> Ajuda
        </div>
      </nav>
    </aside>

    <main class="main-content">
      
      <div class="neo-header">
        <div class="header-title">
          <h1>Conciliação de Cartões</h1>
          <span>Consolidação diária de lançamentos</span>
        </div>
        <button class="neo-btn btn-black" id="info-btn">
          <i class="fas fa-info"></i> COMO USAR
        </button>
      </div>

      <div class="config-grid">
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-users"></i></div>
            CONTA CLIENTES
          </label>
          <input type="text" class="neo-input" id="conta-clientes" placeholder="Ex: 27" />
        </div>
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-credit-card"></i></div>
            CONTA CARTÃO
          </label>
          <input type="text" class="neo-input" id="conta-cartao" placeholder="Ex: 31" />
        </div>
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-tags"></i></div>
            CONTA TARIFAS
          </label>
          <input type="text" class="neo-input" id="conta-tarifas" placeholder="Ex: 957" />
        </div>
        <div class="config-item">
          <label>
            <div class="icon-box"><i class="fa-solid fa-flag"></i></div>
            BANDEIRA (Opcional)
          </label>
          <input type="text" class="neo-input" id="bandeira-cartao" placeholder="Ex: VISA" />
        </div>
      </div>

      <section id="upload-section" class="upload-container">
        
        <div class="upload-section">
          <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h3 style="font-weight: 800; text-transform: uppercase;">Arraste sua planilha aqui</h3>
            <p style="color: #000; font-family: 'Space Mono'; margin-top: 0.5rem;">ou clique para buscar arquivos .xlsx</p>
            <input type="file" id="file-input" accept=".xlsx, .xls" multiple style="display: none;" />
          </div>
          
          <div class="file-info" id="file-info">
            <strong><i class="fas fa-check-circle"></i> ARQUIVOS PRONTOS:</strong>
            <ul id="file-list" style="margin-top: 0.5rem; padding-left: 1.2rem; font-family: 'Space Mono';"></ul>
          </div>
        </div>

        <div class="actions-section">
          <button class="neo-btn btn-secondary" id="generate-model-btn">
            <i class="fas fa-file-excel"></i> BAIXAR MODELO
          </button>
          
          <button class="neo-btn btn-primary" id="process-btn" disabled style="height: 100%;">
            <i class="fas fa-cogs"></i> PROCESSAR DADOS
          </button>
        </div>

      </section>

      <section id="loading-section" class="hidden" style="text-align: center; padding: 3rem; background: #fff; border: 3px solid #000; box-shadow: 6px 6px 0 #000;">
        <div class="loading-spinner"></div>
        <h3 style="text-transform: uppercase;">Processando números...</h3>
      </section>

      <section id="preview-section" class="hidden results-area">
        <h2 style="margin-bottom: 1.5rem; background: #000; color: var(--color-success); display: inline-block; padding: 10px 20px; text-transform: uppercase; font-size: 1.2rem;">
          Resultados Consolidados
        </h2>
        
        <div class="summary-cards">
            <div class="summary-card">
                <span class="summary-label">Total Bruto</span>
                <div class="summary-value" id="total-vendas-valor" style="color: var(--color-success);">R$ 0,00</div>
            </div>
            <div class="summary-card negative">
                <span class="summary-label" style="color: #fff;">Total Tarifas</span>
                <div class="summary-value" id="total-tarifas-valor">R$ 0,00</div>
            </div>
            <div class="summary-card liquid">
                <span class="summary-label" style="color: #000;">Líquido Estimado</span>
                <div class="summary-value" id="total-liquido-calc">R$ 0,00</div>
            </div>
        </div>

        <div style="overflow-x: auto;">
            <table id="preview-table">
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Valor Bruto</th>
                  <th>Valor Líquido</th>
                  <th>Valor Taxa</th>
                  <th>% Taxa</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
        </div>

        <button id="generate-btn" class="neo-btn btn-primary" style="width: 100%; margin-top: 2rem;">
            <i class="fas fa-download"></i> BAIXAR ARQUIVO .TXT FINAL
        </button>
      </section>

    </main>

    <div class="modal-overlay" id="info-modal">
      <div class="modal-content">
        <button class="modal-close" id="close-modal-btn">&times;</button>
        <h2 style="margin-bottom: 1.5rem; text-transform: uppercase; font-weight: 900;">Como usar o Gerador</h2>
        
        <div style="background: var(--color-accent); padding: 1rem; border: 2px solid black; margin-bottom: 1rem; box-shadow: 4px 4px 0 #000;">
            <strong>PASSO 1:</strong> Preencha as contas contábeis no topo.
        </div>
        <div style="background: var(--color-secondary); color: #fff; padding: 1rem; border: 2px solid black; margin-bottom: 1rem; box-shadow: 4px 4px 0 #000;">
            <strong>PASSO 2:</strong> Use o botão "Baixar Modelo" se não souber o formato da planilha. As colunas DATA e VALOR BRUTO são obrigatórias.
        </div>
        <div style="background: var(--color-success); padding: 1rem; border: 2px solid black; box-shadow: 4px 4px 0 #000;">
            <strong>PASSO 3:</strong> Arraste o arquivo, clique em Processar e depois baixe o TXT.
        </div>
      </div>
    </div>

    <script>
      const fileInput = document.getElementById("file-input");
      const processBtn = document.getElementById("process-btn");
      const uploadArea = document.querySelector(".upload-area");
      const fileInfo = document.getElementById("file-info");
      const fileList = document.getElementById("file-list");
      const contaCartaoInput = document.getElementById("conta-cartao");
      const contaClientesInput = document.getElementById("conta-clientes");
      const contaTarifasInput = document.getElementById("conta-tarifas");
      const bandeiraCartaoInput = document.getElementById("bandeira-cartao");
      const uploadSection = document.getElementById("upload-section");
      const loadingSection = document.getElementById("loading-section");
      const previewSection = document.getElementById("preview-section");
      const previewTableBody = document.querySelector("#preview-table tbody");
      const generateBtn = document.getElementById("generate-btn");
      const generateModelBtn = document.getElementById("generate-model-btn");
      const infoBtn = document.getElementById("info-btn");
      const infoModal = document.getElementById("info-modal");
      const closeModalBtn = document.getElementById("close-modal-btn");

      let processedData = [];
      let selectedFiles = [];

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        uploadArea.addEventListener(
          eventName,
          (e) => {
            e.preventDefault();
            e.stopPropagation();
          },
          false
        );
      });
      uploadArea.addEventListener("drop", (e) =>
        handleFileSelect(e.dataTransfer.files)
      );
      fileInput.addEventListener("change", (e) =>
        handleFileSelect(e.target.files)
      );
      processBtn.addEventListener("click", processFiles);
      generateBtn.addEventListener("click", generateAndDownload);
      generateModelBtn.addEventListener("click", generateModelSheet);
      infoBtn.addEventListener("click", () => infoModal.classList.add("show"));
      closeModalBtn.addEventListener("click", () =>
        infoModal.classList.remove("show")
      );
      infoModal.addEventListener("click", (e) => {
        if (e.target === infoModal) {
          infoModal.classList.remove("show");
        }
      });

      function handleFileSelect(files) {
        if (!files || files.length === 0) return;
        selectedFiles = Array.from(files);
        fileList.innerHTML = "";
        selectedFiles.forEach((file) => {
          const listItem = document.createElement("li");
          listItem.innerHTML = `${file.name}`;
          fileList.appendChild(listItem);
        });
        fileInfo.classList.add("show");
        processBtn.disabled = false;
        showSection("upload");
      }

      function generateModelSheet() {
        const wb = XLSX.utils.book_new();
        const ws_data = [
          ["DATA", "VALOR BRUTO", "VALOR LIQUIDO", "TAXA"],
          ["01/07/2025", "150,00", "145,50", ""],
          ["01/07/2025", "200,00", "", "10,00"],
          ["02/07/2025", "500,00", "", ""],
        ];
        const ws = XLSX.utils.aoa_to_sheet(ws_data);
        ws["!cols"] = [{ wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
        XLSX.utils.book_append_sheet(wb, ws, "Lancamentos");
        XLSX.writeFile(wb, "Modelo_Lancamentos.xlsx");
      }

      async function processFiles() {
        const requiredInputs = [
          contaCartaoInput,
          contaClientesInput,
          contaTarifasInput,
        ];
        if (requiredInputs.some((input) => !input.value.trim())) {
          alert(
            "⚠️ Por favor, preencha os campos de contas (Clientes, Cartão e Tarifas)."
          );
          return;
        }
        if (selectedFiles.length === 0) {
          alert("⚠️ Selecione pelo menos um arquivo Excel.");
          return;
        }
        showSection("loading");
        try {
          const allRows = await readFiles(selectedFiles);
          const consolidatedData = consolidateData(allRows);
          processedData = consolidatedData;
          displayPreview();
          showSection("preview");
        } catch (error) {
          alert(`Ocorreu um erro: ${error.message}`);
          showSection("upload");
        }
      }

      function generateAndDownload() {
        if (processedData.length === 0) {
          alert("Não há dados para gerar o arquivo.");
          return;
        }
        const contaCartao = contaCartaoInput.value.trim();
        const contaClientes = contaClientesInput.value.trim();
        const contaTarifas = contaTarifasInput.value.trim();
        const bandeira = bandeiraCartaoInput.value.trim().toUpperCase();

        let historicoVenda =
          "VALOR DE VENDAS C/ CARTAO DE CREDITO/DEBITO, CONF. EXTRATO";
        let historicoTaxa =
          "TAXA OPERADORA DE CARTOES CREDITO/DEBITO, CONF. EXTRATO";

        if (bandeira) {
          historicoVenda += ` ${bandeira}`;
          historicoTaxa += ` ${bandeira}`;
        }

        let txtContent = [];
        processedData.forEach((data) => {
          const valorBrutoStr = data.valorBruto.toFixed(2).replace(".", ",");
          const valorTaxaStr = data.valorTaxa.toFixed(2).replace(".", ",");
          txtContent.push(
            `${data.data};${contaCartao};${contaClientes};${valorBrutoStr};;${historicoVenda};;;;`
          );
          if (Math.abs(data.valorTaxa) > 0.005) {
            txtContent.push(
              `${data.data};${contaTarifas};${contaCartao};${valorTaxaStr};;${historicoTaxa};;;;`
            );
          }
        });

        const blob = new Blob([txtContent.join("\r\n")], {
          type: "text/plain;charset=utf-8",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(
          today.getMonth() + 1
        ).padStart(2, "0")}${String(today.getDate()).padStart(2, "0")}`;
        const fileNameBandeira = bandeira
          ? bandeira.replace(/\s+/g, "_")
          : "GERAL";
        link.download = `LANCAMENTOS_${fileNameBandeira}_${dateStr}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      async function readFiles(files) {
        const filePromises = files.map((file) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                  raw: true,
                });
                if (jsonData.length === 0) return resolve([]);
                const firstRow = jsonData[0];
                const colMap = {
                  data: findKeyForColumn(firstRow, "DATA"),
                  bruto: findKeyForColumn(firstRow, "VALOR BRUTO"),
                  liquido: findKeyForColumn(firstRow, "VALOR LIQUIDO"),
                  taxa: findKeyForColumn(firstRow, "TAXA"),
                };
                if (!colMap.data || !colMap.bruto) {
                  return reject(
                    new Error(
                      `No arquivo "${file.name}", colunas "DATA" e "VALOR BRUTO" não encontradas.`
                    )
                  );
                }
                const fileData = [];
                jsonData.forEach((row) => {
                  const dataVenda = row[colMap.data];
                  const valorBruto = parseCurrency(row[colMap.bruto]);
                  if (!dataVenda || isNaN(valorBruto) || valorBruto === 0)
                    return;

                  let valorLiquido = valorBruto;
                  let valorTaxa = 0;

                  const rawLiquido = parseCurrency(row[colMap.liquido]);
                  const rawTaxa = parseCurrency(row[colMap.taxa]);

                  if (colMap.liquido && !isNaN(rawLiquido) && rawLiquido > 0) {
                    valorTaxa = valorBruto - rawLiquido;
                    valorLiquido = rawLiquido;
                  } else if (colMap.taxa && !isNaN(rawTaxa)) {
                    valorTaxa = rawTaxa;
                    valorLiquido = valorBruto - rawTaxa;
                  }

                  const formattedDate = formatDate(dataVenda);
                  if (!formattedDate) return;

                  fileData.push({
                    data: formattedDate,
                    valorBruto: valorBruto,
                    valorLiquido: valorLiquido,
                    valorTaxa: valorTaxa,
                  });
                });
                resolve(fileData);
              } catch (error) {
                reject(
                  new Error(
                    `Erro ao ler "${file.name}": ${error.message}`
                  )
                );
              }
            };
            reader.onerror = () =>
              reject(new Error(`Erro leitura arquivo ${file.name}.`));
            reader.readAsArrayBuffer(file);
          });
        });
        const results = await Promise.all(filePromises);
        return [].concat(...results);
      }

      function consolidateData(rows) {
        const dailyTotals = new Map();
        rows.forEach((row) => {
          if (!row.data) return;
          const existing = dailyTotals.get(row.data);
          if (existing) {
            existing.valorBruto += row.valorBruto;
            existing.valorLiquido += row.valorLiquido;
            existing.valorTaxa += row.valorTaxa;
          } else {
            dailyTotals.set(row.data, {
              data: row.data,
              valorBruto: row.valorBruto,
              valorLiquido: row.valorLiquido,
              valorTaxa: row.valorTaxa,
            });
          }
        });
        return Array.from(dailyTotals.values()).sort((a, b) =>
          a.data
            .split("/")
            .reverse()
            .join("-")
            .localeCompare(b.data.split("/").reverse().join("-"))
        );
      }

      function displayPreview() {
        previewTableBody.innerHTML = "";
        const totalVendasEl = document.getElementById("total-vendas-valor");
        const totalTarifasEl = document.getElementById("total-tarifas-valor");
        const totalLiquidoEl = document.getElementById("total-liquido-calc");

        if (processedData.length === 0) {
          previewTableBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; padding: 2rem;">Nenhum dado válido encontrado.</td></tr>';
          totalVendasEl.textContent = formatBRL(0);
          totalTarifasEl.textContent = formatBRL(0);
          if(totalLiquidoEl) totalLiquidoEl.textContent = formatBRL(0);
          generateBtn.disabled = true;
          return;
        }

        const totalVendas = processedData.reduce(
          (sum, item) => sum + item.valorBruto,
          0
        );
        const totalTarifas = processedData.reduce(
          (sum, item) => sum + item.valorTaxa,
          0
        );
        const totalLiquido = totalVendas - totalTarifas;

        processedData.forEach((data) => {
          const row = document.createElement("tr");
          const taxaPercentual =
            data.valorBruto > 0 ? data.valorTaxa / data.valorBruto : 0;
          const taxaPercentualStr = taxaPercentual.toLocaleString("pt-BR", {
            style: "percent",
            minimumFractionDigits: 2,
          });

          const estiloTaxaPercentual =
            taxaPercentual > 0.05
              ? 'style="color: red; font-weight: 800;"'
              : "";

          row.innerHTML = `
                <td>${data.data}</td>
                <td>${formatBRL(data.valorBruto)}</td>
                <td>${formatBRL(data.valorLiquido)}</td>
                <td style="color: #FF5252; font-weight:bold;">${formatBRL(
                  data.valorTaxa
                )}</td>
                <td ${estiloTaxaPercentual}>${taxaPercentualStr}</td>
            `;
          previewTableBody.appendChild(row);
        });

        totalVendasEl.textContent = formatBRL(totalVendas);
        totalTarifasEl.textContent = formatBRL(totalTarifas);
        if(totalLiquidoEl) totalLiquidoEl.textContent = formatBRL(totalLiquido);
        
        generateBtn.disabled = false;
      }

      function findKeyForColumn(row, targetColumnName) {
        const lowerCaseTarget = targetColumnName.toLowerCase().trim();
        for (const key of Object.keys(row)) {
          if (key.toLowerCase().trim() === lowerCaseTarget) return key;
        }
        return null;
      }

      function parseCurrency(value) {
        if (value === null || value === undefined) return NaN;
        if (typeof value === "number") return value;
        let s = String(value).replace(/[^0-9,.]/g, "");
        if (s === "") return NaN;
        const lastComma = s.lastIndexOf(",");
        const lastDot = s.lastIndexOf(".");
        if (lastComma > lastDot) {
          s = s.replace(/\./g, "").replace(",", ".");
        } else {
          s = s.replace(/,/g, "");
        }
        return parseFloat(s) || 0;
      }

      function formatDate(excelDate) {
        if (excelDate === null || excelDate === undefined) return null;
        if (typeof excelDate === "number") {
          const jsDate = XLSX.SSF.parse_date_code(excelDate);
          if (jsDate) {
            const day = String(jsDate.d).padStart(2, "0");
            const month = String(jsDate.m).padStart(2, "0");
            const year = jsDate.y;
            return `${day}/${month}/${year}`;
          }
        }
        if (typeof excelDate === "string") {
          const parts = excelDate.split(/[/.-]/);
          if (parts.length === 3) {
            let day, month, year;
            if (parts[2].length === 4) {
              day = parts[0];
              month = parts[1];
              year = parts[2];
            } else if (parts[0].length === 4) {
              day = parts[2];
              month = parts[1];
              year = parts[0];
            }
            if (day && month && year) {
              return `${String(day).padStart(2, "0")}/${String(month).padStart(
                2,
                "0"
              )}/${year}`;
            }
          }
        }
        return null;
      }

      function formatBRL(value) {
        return value.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      function showSection(sectionName) {
        ["upload", "loading", "preview"].forEach((sec) => {
            const el = document.getElementById(`${sec}-section`);
            if(el) el.classList.add("hidden");
        });
        const target = document.getElementById(`${sectionName}-section`);
        if (target) target.classList.remove("hidden");
      }
    </script>
  </body>
</html>