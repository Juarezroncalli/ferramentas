<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Distribui√ß√£o de Lucros [BRUTALISM]</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-body: #06b6d4;
        --card-bg: #ffffff;
        --border-black: #000000;
        --color-primary: #8b5cf6;
        --color-secondary: #f472b6;
        --color-accent: #facc15;
        --color-success: #22c55e;
        --color-danger: #ef4444;
        --color-info: #3b82f6;
        --shadow-dist: 6px;
        --border-width: 3px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Space Grotesk", sans-serif;
        background-color: var(--bg-body);
        background-image: linear-gradient(#fff 2px, transparent 2px),
          linear-gradient(90deg, #fff 2px, transparent 2px);
        background-size: 40px 40px;
        background-position: -2px -2px;
        color: var(--border-black);
        height: 100vh;
        overflow: hidden;
        display: flex;
      }

      .sidebar {
        width: 280px;
        background: var(--color-accent);
        border-right: var(--border-width) solid var(--border-black);
        display: flex;
        flex-direction: column;
        padding: 2rem 1.5rem;
        flex-shrink: 0;
        overflow-y: auto;
      }

      .logo {
        font-weight: 900;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 3rem;
        text-transform: uppercase;
      }

      .logo i {
        background: var(--color-primary);
        color: #fff;
        padding: 10px;
        border: var(--border-width) solid var(--border-black);
        box-shadow: 4px 4px 0 0 black;
      }

      .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px;
        margin-bottom: 1rem;
        font-weight: 800;
        background: #fff;
        border: var(--border-width) solid var(--border-black);
        box-shadow: 4px 4px 0 0 black;
        text-transform: uppercase;
        cursor: pointer;
      }

      .nav-item.active {
        background-color: var(--color-primary);
        color: #fff;
      }

      .main-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
      }

      .neo-header {
        background: #fff;
        border: var(--border-width) solid var(--border-black);
        padding: 2rem;
        box-shadow: var(--shadow-dist) var(--shadow-dist) 0 #000;
        margin-bottom: 2.5rem;
      }

      .neo-card {
        background: #fff;
        border: var(--border-width) solid var(--border-black);
        padding: 2rem;
        box-shadow: var(--shadow-dist) var(--shadow-dist) 0 #000;
        margin-bottom: 2rem;
      }

      .card-title {
        font-weight: 900;
        font-size: 1.2rem;
        margin-bottom: 1.5rem;
        text-transform: uppercase;
        border-bottom: 3px solid #000;
        padding-bottom: 10px;
      }

      .neo-input {
        width: 100%;
        padding: 15px;
        font-family: "Space Mono", monospace;
        font-weight: bold;
        border: var(--border-width) solid var(--border-black);
        background: #f3f4f6;
        margin-bottom: 10px;
      }

      .neo-btn {
        padding: 15px 25px;
        font-weight: 800;
        border: var(--border-width) solid var(--border-black);
        cursor: pointer;
        box-shadow: 5px 5px 0 0 black;
        text-transform: uppercase;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .neo-btn:active {
        transform: translate(4px, 4px);
        box-shadow: 0 0 0 0 black;
      }

      .btn-success {
        background-color: var(--color-success);
      }
      .btn-primary {
        background-color: var(--color-primary);
        color: white;
      }
      .btn-danger {
        background-color: var(--color-danger);
        color: white;
      }
      .btn-warning {
        background-color: var(--color-accent);
      }

      .upload-area {
        border: 3px dashed var(--border-black);
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        background: #fef9c3;
      }

      .socio-item {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }
      .socio-nome {
        flex: 2;
      }
      .socio-percentual {
        flex: 1;
      }

      #preview {
        background-color: #000;
        color: #33ff00;
        padding: 20px;
        font-family: "Space Mono", monospace;
        white-space: pre-wrap;
        overflow-y: auto;
        max-height: 400px;
      }

      .alert {
        padding: 15px;
        border: var(--border-width) solid var(--border-black);
        font-weight: 700;
        margin: 15px 0;
      }
      .alert-error {
        background: var(--color-danger);
        color: white;
      }
      .hidden {
        display: none !important;
      }

      @media (max-width: 900px) {
        body {
          flex-direction: column;
          overflow: auto;
        }
        .sidebar {
          width: 100%;
          flex-direction: row;
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-users"></i><span>Distr. Lucros</span>
      </div>
      <nav>
        <div class="nav-item active">
          <i class="fas fa-file-invoice-dollar"></i> Gerador
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <div class="neo-header">
        <h1>Distribui√ß√£o de Lucros üí∏</h1>
        <p>Gere o arquivo de importa√ß√£o cont√°bil</p>
      </div>

      <div class="neo-card">
        <div class="card-title">1. Arquivo e Configura√ß√£o</div>
        <div
          class="upload-area"
          onclick="document.getElementById('excel-file').click()"
        >
          <div class="upload-text">CLIQUE PARA CARREGAR A PLANILHA (.xlsx)</div>
          <input
            type="file"
            id="excel-file"
            accept=".xlsx, .xls"
            style="display: none"
          />
        </div>
        <div class="form-group" style="margin-top: 20px">
          <label>CONTA D√âBITO (CONT√ÅBIL)</label>
          <input type="text" id="conta-debito" class="neo-input" value="961" />
        </div>
      </div>

      <div class="neo-card">
        <div class="card-title">2. S√≥cios e Percentuais</div>
        <div id="socios-container">
          <div class="socio-item">
            <input
              type="text"
              placeholder="NOME DO S√ìCIO"
              class="neo-input socio-nome"
            />
            <input
              type="number"
              placeholder="%"
              class="neo-input socio-percentual"
            />
            <button type="button" class="neo-btn btn-danger remover-socio">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <button type="button" id="adicionar-socio" class="neo-btn btn-success">
          <i class="fas fa-plus"></i> S√≥cio
        </button>
        <div id="percentual-alert" class="alert alert-error hidden">
          ‚ö† A SOMA DEVE SER 100%.
        </div>
        <button
          type="button"
          id="processar"
          class="neo-btn btn-primary"
          style="width: 100%; margin-top: 20px"
        >
          PROCESSAR ‚ö°
        </button>
      </div>

      <div id="resultado-container" class="neo-card hidden">
        <div class="card-title">3. Output Gerado</div>
        <div id="preview"></div>
        <button
          type="button"
          id="download"
          class="neo-btn btn-warning"
          style="width: 100%; margin-top: 20px"
        >
          BAIXAR .TXT üíæ
        </button>
      </div>
    </main>

    <script>
      const excelFileInput = document.getElementById("excel-file");
      const contaDebitoInput = document.getElementById("conta-debito");
      const sociosContainer = document.getElementById("socios-container");
      const adicionarSocioBtn = document.getElementById("adicionar-socio");
      const processarBtn = document.getElementById("processar");
      const downloadBtn = document.getElementById("download");
      const previewElement = document.getElementById("preview");
      const resultadoContainer = document.getElementById("resultado-container");
      const percentualAlert = document.getElementById("percentual-alert");

      let dadosPlanilha = null;

      adicionarSocioBtn.addEventListener("click", () => {
        const div = document.createElement("div");
        div.className = "socio-item";
        div.innerHTML = `<input type="text" placeholder="NOME DO S√ìCIO" class="neo-input socio-nome"><input type="number" placeholder="%" class="neo-input socio-percentual"><button type="button" class="neo-btn btn-danger remover-socio"><i class="fas fa-times"></i></button>`;
        sociosContainer.appendChild(div);
      });

      document.addEventListener("click", (e) => {
        if (
          e.target.closest(".remover-socio") &&
          document.querySelectorAll(".socio-item").length > 1
        ) {
          e.target.closest(".socio-item").remove();
        }
      });

      excelFileInput.addEventListener("change", (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const workbook = XLSX.read(new Uint8Array(ev.target.result), {
            type: "array",
          });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          const headers = json[0];
          dadosPlanilha = json.slice(1).map((row) => ({
            Data: row[headers.indexOf("Data")],
            Credito: row[headers.indexOf("Cta. Cr√©dito")],
            Valor: row[headers.indexOf("Valor")],
          }));
          document.querySelector(".upload-text").textContent =
            "ARQUIVO CARREGADO!";
        };
        reader.readAsArrayBuffer(e.target.files[0]);
      });

      processarBtn.addEventListener("click", () => {
        const socios = Array.from(document.querySelectorAll(".socio-item")).map(
          (i) => ({
            nome: i.querySelector(".socio-nome").value,
            pct: parseFloat(i.querySelector(".socio-percentual").value) || 0,
          })
        );

        const totalPct = socios.reduce((s, v) => s + v.pct, 0);
        if (Math.abs(totalPct - 100) > 0.01) {
          percentualAlert.classList.remove("hidden");
          return;
        }
        percentualAlert.classList.add("hidden");

        const linhas = [];
        dadosPlanilha.forEach((d) => {
          let dataFormatada = "";

          // --- CORRE√á√ÉO DA DATA (M√âTODO UTC) ---
          if (typeof d.Data === "number") {
            const dataUnix = Math.round((d.Data - 25569) * 86400 * 1000);
            const dateObj = new Date(dataUnix);
            const dia = String(dateObj.getUTCDate()).padStart(2, "0");
            const mes = String(dateObj.getUTCMonth() + 1).padStart(2, "0");
            const ano = dateObj.getUTCFullYear();
            dataFormatada = `${dia}/${mes}/${ano}`;
          } else {
            dataFormatada = String(d.Data);
          }

          const valorTotal = parseFloat(String(d.Valor).replace(",", "."));

          socios.forEach((s) => {
            const valorSocio = ((valorTotal * s.pct) / 100)
              .toFixed(2)
              .replace(".", ",");
            linhas.push(
              `${dataFormatada};${contaDebitoInput.value};${d.Credito};${valorSocio};;VALOR PAGO AO SOCIO ${s.nome}, REF. LUCROS DISTRIBUIDOS;;;;`
            );
          });
        });

        previewElement.textContent = linhas.join("\n");
        resultadoContainer.classList.remove("hidden");
      });

      downloadBtn.addEventListener("click", () => {
        const blob = new Blob([previewElement.textContent], {
          type: "text/plain",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "distribuicao_lucros.txt";
        a.click();
      });
    </script>
  </body>
</html>
