<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Processador e Comparador de Planilhas</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* Estilos importados e adaptados do ECF.html */
      :root {
        --primary-color: #4f0072;
        --accent-color: #fb0a5e;
        --background-color: #ffffff;
        --form-bg-color: #f9f9f9;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --text-color-light: #ffffff;
        --sombra: 0 4px 12px rgba(79, 0, 114, 0.15);
        --transicao: all 0.3s ease;
        --primary-dark: #3d005a;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --text-muted: #64748b;
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1),
          0 4px 6px -4px rgb(0 0 0 / 0.1);
        --radius: 0.5rem;
        --radius-lg: 0.75rem;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background: linear-gradient(135deg, #4f0072 0%, #fb0a5e 100%);
        min-height: 100vh;
        color: var(--text-color);
        line-height: 1.6;
        padding: 2rem 1rem;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .header h1 {
        color: white;
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .main-content {
        background: var(--background-color);
        border-radius: var(--radius-lg);
        padding: 2rem;
        box-shadow: var(--sombra);
        transition: var(--transicao);
      }

      .section {
        margin-bottom: 2.5rem;
      }
      .section:last-child {
        margin-bottom: 0;
      }

      .section-title {
        color: var(--primary-color);
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--accent-color);
      }

      .upload-area {
        border: 2px dashed var(--border-color);
        border-radius: var(--radius);
        padding: 2rem 1.5rem;
        text-align: center;
        transition: var(--transicao);
        cursor: pointer;
        position: relative;
        overflow: hidden;
        background-color: var(--form-bg-color);
      }

      .upload-area:hover,
      .upload-area.drag-over {
        border-color: var(--primary-color);
        background: rgba(79, 0, 114, 0.05);
      }

      .upload-icon {
        font-size: 2.5rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
        transition: all 0.3s ease;
      }
      .upload-area:hover .upload-icon {
        color: var(--primary-color);
      }

      .file-input {
        display: none;
      }

      .btn {
        background: var(--primary-color);
        color: var(--text-color-light);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: var(--radius);
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transicao);
        box-shadow: var(--sombra);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
      }

      .btn:disabled {
        background: var(--text-muted);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-download {
        background-color: var(--success);
        display: none; /* Controlado por JS */
      }
      .btn-download:hover {
        background-color: #0f9a6b;
      }

      .btn-compare {
        background-color: var(--accent-color);
        width: 100%;
      }
      .btn-compare:hover {
        background-color: #d90850;
      }

      .file-info {
        background: var(--form-bg-color);
        border-radius: var(--radius);
        padding: 1rem;
        margin-top: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border: 1px solid var(--border-color);
      }
      .file-icon {
        color: var(--primary-color);
        font-size: 1.5rem;
      }
      .file-name-display {
        font-weight: 600;
        color: var(--text-color);
      }

      .status {
        margin-top: 1rem;
        text-align: center;
        font-weight: bold;
        min-height: 20px;
        padding: 0.5rem;
        border-radius: var(--radius);
      }
      .status-success {
        color: var(--success);
        background-color: rgba(16, 185, 129, 0.1);
      }
      .status-error {
        color: var(--error);
        background-color: rgba(239, 68, 68, 0.1);
      }
      .status-info {
        color: var(--primary-dark);
        background-color: rgba(79, 0, 114, 0.1);
      }

      .cfop-input-section {
        margin: 1.5rem 0;
        text-align: center;
      }
      .cfop-input-section label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
      }
      .cfop-input-section input[type="text"] {
        padding: 0.75rem;
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        width: 100%;
        max-width: 400px;
        font-size: 1rem;
      }
      .cfop-input-section input[type="text"]:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(79, 0, 114, 0.2);
      }

      .comparison-alerts-container {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background-color: #fffaf0;
        border-radius: var(--radius);
        border-left: 4px solid var(--warning);
        display: none;
      }
      .comparison-alerts-container h3 {
        margin-bottom: 1rem;
        color: var(--warning);
        font-size: 1.25rem;
        font-weight: 700;
      }

      #alertTable {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.9em;
      }
      #alertTable th,
      #alertTable td {
        border: 1px solid var(--border-color);
        padding: 0.75rem;
        text-align: left;
      }
      #alertTable th {
        background-color: var(--form-bg-color);
        color: var(--primary-color);
        font-weight: 600;
      }
      #alertTable tbody tr:nth-child(odd) {
        background-color: #fff;
      }
      #alertTable tbody tr:nth-child(even) {
        background-color: var(--form-bg-color);
      }

      .error-info {
        margin-top: 1.5rem;
        padding: 1.5rem;
        background-color: rgba(239, 68, 68, 0.1);
        border-radius: var(--radius);
        border-left: 4px solid var(--error);
        display: none;
      }
      .error-info h3 {
        margin-bottom: 1rem;
        color: var(--error);
      }
      .error-info pre {
        background-color: #fff;
        padding: 1rem;
        border-radius: var(--radius);
        overflow-x: auto;
        font-family: monospace;
        font-size: 14px;
        white-space: pre-wrap;
        border: 1px solid var(--border-color);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-sync-alt"></i> Processador e Comparador de Planilhas
        </h1>
      </div>

      <div class="main-content">
        <div class="section">
          <h2 class="section-title">
            <i class="fas fa-file-invoice-dollar"></i> 1. Planilha "Contas a
            Pagar"
          </h2>
          <div class="upload-area" id="dropAreaContasAPagar">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <p>
              Arraste e solte a planilha aqui ou
              <strong style="color: var(--primary-color)"
                >clique no botão abaixo</strong
              >.
            </p>
            <input
              type="file"
              id="fileInputContasAPagar"
              class="file-input"
              accept=".xlsx, .xls"
            />
          </div>
          <button class="btn" id="uploadBtnContasAPagar">
            <i class="fas fa-folder-open"></i> Selecionar Arquivo
          </button>

          <div
            class="file-info"
            id="fileInfoContasAPagar"
            style="display: none"
          >
            <div class="file-icon"><i class="fas fa-file-excel"></i></div>
            <div class="file-name-display" id="fileNameContasAPagar"></div>
          </div>
          <div class="status" id="statusContasAPagar"></div>
          <button class="btn btn-download" id="downloadBtnContasAPagar">
            <i class="fas fa-download"></i> Baixar "Contas a Pagar" Processada
          </button>
        </div>

        <div class="section">
          <h2 class="section-title">
            <i class="fas fa-cubes"></i> 2. Planilha de Entradas (Agregação)
          </h2>
          <div class="upload-area" id="dropAreaAgregada">
            <div class="upload-icon">
              <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <p>
              Arraste e solte a planilha aqui ou
              <strong style="color: var(--primary-color)"
                >clique no botão abaixo</strong
              >.
            </p>
            <input
              type="file"
              id="fileInputAgregada"
              class="file-input"
              accept=".xlsx, .xls"
            />
          </div>
          <button class="btn" id="uploadBtnAgregada">
            <i class="fas fa-folder-open"></i> Selecionar Arquivo
          </button>

          <div class="file-info" id="fileInfoAgregada" style="display: none">
            <div class="file-icon"><i class="fas fa-file-excel"></i></div>
            <div class="file-name-display" id="fileNameAgregada"></div>
          </div>
          <div class="status" id="statusAgregada"></div>
          <button class="btn btn-download" id="downloadBtnAgregada">
            <i class="fas fa-download"></i> Baixar Planilha Agregada
          </button>
        </div>

        <div class="section">
          <h2 class="section-title">
            <i class="fas fa-balance-scale"></i> 3. Comparação e Alertas
          </h2>
          <p
            style="text-align: center; font-style: italic; margin-bottom: 1rem"
          >
            Informe os CFOPs para verificar a criação de duplicatas.
          </p>
          <div class="cfop-input-section">
            <label for="cfopInput"
              >CFOP(s) para Verificação (separados por vírgula):</label
            >
            <input type="text" id="cfopInput" placeholder="Ex: 1910, 1949" />
          </div>
          <button class="btn btn-compare" id="compareBtn" disabled>
            <i class="fas fa-search"></i> Comparar Planilhas (Nota, Código,
            Valor)
          </button>
          <div class="status" id="statusComparison"></div>
          <div
            class="comparison-alerts-container"
            id="comparisonAlertsContainer"
          >
            <h3>
              <i class="fas fa-exclamation-triangle"></i> Alertas da Comparação:
            </h3>
            <div style="overflow-x: auto">
              <table id="alertTable">
                <thead>
                  <tr>
                    <th>Nota/Doc (CAP)</th>
                    <th>Código (CAP)</th>
                    <th>CFOPs (Agregada)</th>
                    <th>CFOP Verificado</th>
                    <th>Fornecedor (Agregada)</th>
                    <th>Valor Contábil</th>
                  </tr>
                </thead>
                <tbody id="alertTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="error-info" id="generalErrorInfo">
          <h3><i class="fas fa-bug"></i> Erro Geral / Detalhes</h3>
          <div id="generalErrorDetails"></div>
        </div>
      </div>
    </div>

    <script>
      // O SCRIPT JAVASCRIPT ORIGINAL FOI MANTIDO AQUI, COM PEQUENAS ADIÇÕES PARA CONTROLAR O NOVO LAYOUT
      document.addEventListener("DOMContentLoaded", function () {
        // --- Elementos DOM ---
        const fileInputContasAPagar = document.getElementById(
          "fileInputContasAPagar"
        );
        const uploadBtnContasAPagar = document.getElementById(
          "uploadBtnContasAPagar"
        );
        const dropAreaContasAPagar = document.getElementById(
          "dropAreaContasAPagar"
        );
        const statusContasAPagar =
          document.getElementById("statusContasAPagar");
        const fileNameContasAPagar = document.getElementById(
          "fileNameContasAPagar"
        );
        const downloadBtnContasAPagar = document.getElementById(
          "downloadBtnContasAPagar"
        );
        const fileInfoContasAPagar = document.getElementById(
          "fileInfoContasAPagar"
        ); // Novo

        const fileInputAgregada = document.getElementById("fileInputAgregada");
        const uploadBtnAgregada = document.getElementById("uploadBtnAgregada");
        const dropAreaAgregada = document.getElementById("dropAreaAgregada");
        const statusAgregada = document.getElementById("statusAgregada");
        const fileNameAgregada = document.getElementById("fileNameAgregada");
        const downloadBtnAgregada = document.getElementById(
          "downloadBtnAgregada"
        );
        const fileInfoAgregada = document.getElementById("fileInfoAgregada"); // Novo

        const cfopInput = document.getElementById("cfopInput");
        const compareBtn = document.getElementById("compareBtn");
        const statusComparison = document.getElementById("statusComparison");
        const comparisonAlertsContainer = document.getElementById(
          "comparisonAlertsContainer"
        );
        const alertTableBody = document.getElementById("alertTableBody");

        const generalErrorInfo = document.getElementById("generalErrorInfo");
        const generalErrorDetails = document.getElementById(
          "generalErrorDetails"
        );

        // --- Estado da Aplicação ---
        let processedDataContasAPagar = null;
        let processedDataAgregada = null;
        let originalFileNameContasAPagar = "Contas_a_Pagar";
        let originalFileNameAgregada = "Planilha_Agregada";

        // --- Funções Utilitárias ---
        function setStatus(element, message, type = "info") {
          element.textContent = message;
          element.className = `status status-${type}`;
          if (!message) {
            element.style.display = "none";
          } else {
            element.style.display = "block";
          }
        }

        function showError(title, details) {
          generalErrorDetails.innerHTML = `<p>${title}</p>`;
          if (details) {
            generalErrorDetails.innerHTML += `<pre>${escapeHtml(
              details
            )}</pre>`;
          }
          generalErrorInfo.style.display = "block";
        }

        function escapeHtml(unsafe) {
          if (typeof unsafe !== "string") return unsafe;
          return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        function clearGeneralError() {
          generalErrorDetails.innerHTML = "";
          generalErrorInfo.style.display = "none";
          comparisonAlertsContainer.style.display = "none";
          alertTableBody.innerHTML = "";
        }

        function updateCompareButtonState() {
          if (
            processedDataContasAPagar &&
            processedDataContasAPagar.length > 0 &&
            processedDataAgregada &&
            processedDataAgregada.length > 0 &&
            cfopInput.value.trim() !== ""
          ) {
            compareBtn.disabled = false;
          } else {
            compareBtn.disabled = true;
          }
        }

        function normalizeValor(value) {
          if (value === null || value === undefined) return NaN;
          if (typeof value === "number" && !isNaN(value)) return value;

          let strValue = String(value).trim();
          if (strValue === "") return NaN;

          const hasComma = strValue.includes(",");
          const hasDot = strValue.includes(".");

          if (hasComma && hasDot) {
            if (strValue.lastIndexOf(",") > strValue.lastIndexOf(".")) {
              strValue = strValue.replace(/\./g, "").replace(",", ".");
            } else {
              strValue = strValue.replace(/,/g, "");
            }
          } else if (hasComma) {
            strValue = strValue.replace(",", ".");
          }

          const num = parseFloat(strValue);
          return isNaN(num) ? NaN : num;
        }

        // --- Lógica Drag and Drop Genérica ---
        function setupDragAndDrop(
          dropAreaElement,
          fileInputElement,
          fileHandler
        ) {
          ["dragenter", "dragover", "dragleave", "drop"].forEach(
            (eventName) => {
              dropAreaElement.addEventListener(
                eventName,
                (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                },
                false
              );
            }
          );
          ["dragenter", "dragover"].forEach((eventName) => {
            dropAreaElement.addEventListener(
              eventName,
              () => dropAreaElement.classList.add("drag-over"),
              false
            );
          });
          ["dragleave", "drop"].forEach((eventName) => {
            dropAreaElement.addEventListener(
              eventName,
              () => dropAreaElement.classList.remove("drag-over"),
              false
            );
          });
          dropAreaElement.addEventListener(
            "drop",
            (e) => {
              if (e.dataTransfer.files.length) {
                fileInputElement.files = e.dataTransfer.files;
                fileHandler({ target: fileInputElement });
              }
            },
            false
          );
        }

        // --- Processamento Planilha "Contas a Pagar" ---
        uploadBtnContasAPagar.addEventListener("click", () =>
          fileInputContasAPagar.click()
        );
        fileInputContasAPagar.addEventListener("change", (e) =>
          handleFileContasAPagar(e.target.files[0])
        );
        setupDragAndDrop(dropAreaContasAPagar, fileInputContasAPagar, (e) =>
          handleFileContasAPagar(e.target.files[0])
        );

        function handleFileContasAPagar(file) {
          if (!file) {
            fileInfoContasAPagar.style.display = "none";
            setStatus(statusContasAPagar, "");
            downloadBtnContasAPagar.style.display = "none";
            processedDataContasAPagar = null;
            updateCompareButtonState();
            return;
          }
          originalFileNameContasAPagar = file.name.replace(
            /\.(xlsx|xls)$/i,
            ""
          );
          fileNameContasAPagar.textContent = file.name;
          fileInfoContasAPagar.style.display = "flex"; // Novo
          setStatus(
            statusContasAPagar,
            'Processando "Contas a Pagar"...',
            "info"
          );
          clearGeneralError();
          downloadBtnContasAPagar.style.display = "none";

          const reader = new FileReader();
          reader.onload = function (e_reader) {
            try {
              const data = new Uint8Array(e_reader.target.result);
              let workbook = XLSX.read(data, { type: "array" });

              if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                throw new Error(
                  'A planilha "Contas a Pagar" não contém nenhuma folha de trabalho.'
                );
              }

              const firstSheetName = workbook.SheetNames[0];
              let worksheet = workbook.Sheets[firstSheetName];

              if (!worksheet) {
                throw new Error(
                  `Não foi possível acessar a folha de trabalho "${firstSheetName}".`
                );
              }

              worksheet = unmergeCellsCAP(worksheet).worksheet;
              let jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
                defval: "",
                rawNumbers: false,
              });

              if (!jsonData || jsonData.length === 0) {
                throw new Error(
                  'A planilha "Contas a Pagar" não contém dados.'
                );
              }

              const columnIndices = findColumnIndicesCAP(jsonData);
              processedDataContasAPagar = processDataCAP(
                jsonData,
                columnIndices
              );

              if (processedDataContasAPagar.length === 0) {
                setStatus(
                  statusContasAPagar,
                  'Nenhum dado encontrado na "Contas a Pagar". Verifique a formatação.',
                  "error"
                );
              } else {
                downloadBtnContasAPagar.style.display = "inline-flex";
                setStatus(
                  statusContasAPagar,
                  '"Contas a Pagar" processada com sucesso!',
                  "success"
                );
              }
            } catch (error) {
              console.error('Erro ao processar "Contas a Pagar":', error);
              showError(
                'Erro ao processar "Contas a Pagar"',
                error.stack || error.message
              );
              setStatus(
                statusContasAPagar,
                'Erro ao processar "Contas a Pagar".',
                "error"
              );
              processedDataContasAPagar = null;
            } finally {
              updateCompareButtonState();
            }
          };
          reader.onerror = function (e_reader) {
            showError(
              'Erro ao ler o arquivo "Contas a Pagar"',
              e_reader.target.error.message
            );
            setStatus(
              statusContasAPagar,
              'Erro ao ler o arquivo "Contas a Pagar".',
              "error"
            );
            processedDataContasAPagar = null;
            updateCompareButtonState();
          };
          reader.readAsArrayBuffer(file);
        }

        function unmergeCellsCAP(worksheet) {
          if (!worksheet) throw new Error("Planilha inválida para unmergeCAP");
          if (worksheet["!merges"] && Array.isArray(worksheet["!merges"])) {
            worksheet["!merges"].forEach((merge) => {
              const topLeftCell = XLSX.utils.encode_cell({
                r: merge.s.r,
                c: merge.s.c,
              });
              const value = worksheet[topLeftCell]
                ? worksheet[topLeftCell].v
                : "";
              for (let r = merge.s.r; r <= merge.e.r; r++) {
                for (let c = merge.s.c; c <= merge.e.c; c++) {
                  const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
                  if (!worksheet[cellAddress])
                    worksheet[cellAddress] = { t: "s", v: value };
                  else if (cellAddress !== topLeftCell)
                    worksheet[cellAddress].v = value;
                }
              }
            });
          }
          return { worksheet };
        }

        function findColumnIndicesCAP(data) {
          const indices = {
            fornecedor: -1,
            documento: -1,
            entrada: -1,
            vParcela: -1,
          };
          for (let i = 0; i < Math.min(10, data.length); i++) {
            const row = data[i];
            if (!row) continue;
            for (let j = 0; j < row.length; j++) {
              const cell = row[j] ? String(row[j]).trim() : "";
              if (cell === "Fornecedor" && indices.fornecedor === -1)
                indices.fornecedor = j;
              else if (
                (cell === "Documento" || cell === "Nota") &&
                indices.documento === -1
              )
                indices.documento = j;
              else if (cell === "Entrada" && indices.entrada === -1)
                indices.entrada = j;
              else if (
                (cell === "V. Parcela" ||
                  cell === "V.Parcela" ||
                  cell === "Valor Contábil") &&
                indices.vParcela === -1
              )
                indices.vParcela = j;
            }
            if (
              indices.fornecedor !== -1 &&
              indices.documento !== -1 &&
              indices.entrada !== -1 &&
              indices.vParcela !== -1
            )
              break;
          }
          if (indices.fornecedor === -1) indices.fornecedor = 0;
          if (indices.documento === -1)
            indices.documento = indices.fornecedor + 1;
          if (indices.entrada === -1) indices.entrada = indices.documento + 1;
          if (indices.vParcela === -1) indices.vParcela = indices.entrada + 1;
          return indices;
        }

        function processDataCAP(data, columnIndices) {
          const result = [];
          if (!data || data.length < 6) return result;

          for (let i = 5; i < data.length; i++) {
            const row = data[i];
            if (
              row &&
              row.length > columnIndices.fornecedor &&
              row[columnIndices.fornecedor]
            ) {
              const fornecedorValue = String(
                row[columnIndices.fornecedor]
              ).trim();
              if (
                fornecedorValue !== "" &&
                !fornecedorValue.includes("Entrada:") &&
                !fornecedorValue.includes("Fornecedor") &&
                !fornecedorValue.includes("Emissão")
              ) {
                const documentoValue =
                  row.length > columnIndices.documento
                    ? row[columnIndices.documento]
                      ? String(row[columnIndices.documento])
                      : ""
                    : "";
                const entradaRaw =
                  row.length > columnIndices.entrada
                    ? row[columnIndices.entrada]
                      ? row[columnIndices.entrada]
                      : ""
                    : "";
                const vParcelaRaw =
                  row.length > columnIndices.vParcela
                    ? row[columnIndices.vParcela]
                      ? row[columnIndices.vParcela]
                      : ""
                    : "";

                let codigo = "";
                let nomeFornecedor = fornecedorValue;
                if (fornecedorValue.includes("-")) {
                  const parts = fornecedorValue.split("-");
                  codigo = parts[0].trim();
                  nomeFornecedor = parts.slice(1).join("-").trim();
                }

                result.push({
                  Código: codigo,
                  Fornecedor: nomeFornecedor,
                  Documento: documentoValue,
                  Entrada: formatDateToStandardCAP(entradaRaw),
                  "Valor Contábil": normalizeValor(vParcelaRaw),
                });
              }
            }
          }
          return result;
        }

        function formatDateToStandardCAP(value) {
          if (!value) return "";
          if (typeof value === "number" && value > 1 && value < 2958466) {
            try {
              const date = XLSX.SSF.parse_date_code(value);
              if (date && date.y && date.m && date.d) {
                return `${String(date.d).padStart(2, "0")}/${String(
                  date.m
                ).padStart(2, "0")}/${date.y}`;
              }
            } catch (e) {
              /* ignore parsing error */
            }
          }
          if (typeof value === "string") {
            const dateObj = new Date(value);
            if (!isNaN(dateObj.getTime()) && dateObj.getFullYear() > 1800) {
              return `${dateObj.getDate().toString().padStart(2, "0")}/${(
                dateObj.getMonth() + 1
              )
                .toString()
                .padStart(2, "0")}/${dateObj.getFullYear()}`;
            }
          }
          return String(value);
        }

        downloadBtnContasAPagar.addEventListener("click", () => {
          if (
            !processedDataContasAPagar ||
            processedDataContasAPagar.length === 0
          ) {
            setStatus(statusContasAPagar, "Nenhum dado para baixar.", "error");
            return;
          }
          try {
            const ws = XLSX.utils.json_to_sheet(processedDataContasAPagar, {
              header: [
                "Código",
                "Fornecedor",
                "Documento",
                "Entrada",
                "Valor Contábil",
              ],
            });

            const valueColumnLetter = "E";

            Object.keys(ws).forEach((cellRef) => {
              if (cellRef[0] === "!") return;
              const colLetter = cellRef.replace(/[0-9]/g, "");
              const rowNumber = parseInt(cellRef.replace(/[A-Z]/g, ""));
              if (rowNumber > 1 && colLetter === valueColumnLetter) {
                if (
                  ws[cellRef] &&
                  ws[cellRef].v !== undefined &&
                  typeof ws[cellRef].v === "number"
                ) {
                  ws[cellRef].t = "n";
                  ws[cellRef].z = "R$ #,##0.00";
                }
              }
            });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Contas Pagar Processado");
            XLSX.writeFile(
              wb,
              `${originalFileNameContasAPagar}_Processado.xlsx`
            );
          } catch (error) {
            showError(
              'Erro ao gerar "Contas a Pagar" para download',
              error.message
            );
          }
        });

        // --- Processamento Planilha Agregada ---
        uploadBtnAgregada.addEventListener("click", () =>
          fileInputAgregada.click()
        );
        fileInputAgregada.addEventListener("change", (e) =>
          handleFileAgregada(e.target.files[0])
        );
        setupDragAndDrop(dropAreaAgregada, fileInputAgregada, (e) =>
          handleFileAgregada(e.target.files[0])
        );

        function handleFileAgregada(file) {
          if (!file) {
            fileInfoAgregada.style.display = "none";
            setStatus(statusAgregada, "");
            downloadBtnAgregada.style.display = "none";
            processedDataAgregada = null;
            updateCompareButtonState();
            return;
          }
          originalFileNameAgregada = file.name.replace(/\.(xlsx|xls)$/i, "");
          fileNameAgregada.textContent = file.name;
          fileInfoAgregada.style.display = "flex";
          setStatus(
            statusAgregada,
            "Processando planilha para agregação...",
            "info"
          );
          clearGeneralError();
          downloadBtnAgregada.style.display = "none";
          processedDataAgregada = null;

          const reader = new FileReader();
          reader.onload = function (e_reader) {
            try {
              const data = new Uint8Array(e_reader.target.result);
              const workbook = XLSX.read(data, {
                type: "array",
                cellDates: true,
              });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];

              const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                header: 1,
                range: 5,
                defval: "",
              });

              if (jsonData.length < 1) {
                throw new Error(
                  "Planilha agregada: sem cabeçalhos na linha 6 ou dados abaixo."
                );
              }

              const headers = jsonData[0].map((h) =>
                h && typeof h === "string" ? h.trim() : h ? String(h) : ""
              );
              const dataRows = jsonData.slice(1);

              const K_INDEX = 10;
              const colIndices = {
                data: headers.indexOf("Data"),
                nota: headers.indexOf("Nota"),
                fornecedor: headers.indexOf("Fornecedor"),
                cfop: headers.indexOf("CFOP"),
                valorContabil: headers.indexOf("Valor Contábil"),
                codigo: K_INDEX, // Assumindo que o código está sempre na coluna K
              };

              let missingHeadersMessages = [];
              if (colIndices.data === -1) missingHeadersMessages.push("'Data'");
              if (colIndices.nota === -1) missingHeadersMessages.push("'Nota'");
              if (colIndices.fornecedor === -1)
                missingHeadersMessages.push("'Fornecedor'");
              if (colIndices.cfop === -1) missingHeadersMessages.push("'CFOP'");
              if (colIndices.valorContabil === -1)
                missingHeadersMessages.push("'Valor Contábil'");
              if (headers.length <= K_INDEX)
                missingHeadersMessages.push("Coluna K ('Código') não existe.");

              if (missingHeadersMessages.length > 0) {
                throw new Error(
                  `Cabeçalho(s) não encontrado(s) na planilha agregada: ${missingHeadersMessages.join(
                    ", "
                  )}.`
                );
              }

              const aggregatedData = {};
              dataRows.forEach((row, rowIndex) => {
                if (
                  row.every(
                    (cell) => cell === null || cell === "" || cell === undefined
                  )
                )
                  return;

                const dataVal = formatDateAgregada(row[colIndices.data]);
                const notaVal = String(row[colIndices.nota] || "").trim();
                const codigoVal = String(row[colIndices.codigo] || "").trim();

                if (!dataVal || !notaVal || !codigoVal) return;
                const aggregationKey = `${dataVal}_${notaVal}_${codigoVal}`;

                let valorContabilNum = normalizeValor(
                  row[colIndices.valorContabil]
                );
                if (isNaN(valorContabilNum)) valorContabilNum = 0;

                const cfopAtual = String(row[colIndices.cfop] || "").trim();

                if (!aggregatedData[aggregationKey]) {
                  aggregatedData[aggregationKey] = {
                    Data: dataVal,
                    Nota: notaVal,
                    Código: codigoVal,
                    Fornecedor: String(row[colIndices.fornecedor] || "").trim(),
                    CFOPs: new Set(),
                    "Valor Contábil": 0,
                  };
                }
                if (cfopAtual)
                  aggregatedData[aggregationKey]["CFOPs"].add(cfopAtual);
                aggregatedData[aggregationKey]["Valor Contábil"] +=
                  valorContabilNum;
              });

              processedDataAgregada = Object.values(aggregatedData).map(
                (item) => ({
                  Data: item["Data"],
                  Nota: item["Nota"],
                  Código: item["Código"],
                  Fornecedor: item["Fornecedor"],
                  CFOP: Array.from(item["CFOPs"]).join(", "),
                  "Valor Contábil": parseFloat(
                    item["Valor Contábil"].toFixed(2)
                  ),
                })
              );

              if (processedDataAgregada.length === 0) {
                setStatus(
                  statusAgregada,
                  "Nenhum dado válido encontrado na planilha agregada.",
                  "info"
                );
              } else {
                setStatus(
                  statusAgregada,
                  "Planilha agregada processada com sucesso!",
                  "success"
                );
                downloadBtnAgregada.style.display = "inline-flex";
              }
            } catch (error) {
              console.error("Erro ao processar planilha agregada:", error);
              showError(
                "Erro ao processar planilha agregada",
                error.stack || error.message
              );
              setStatus(
                statusAgregada,
                "Erro ao processar planilha agregada.",
                "error"
              );
              processedDataAgregada = null;
            } finally {
              updateCompareButtonState();
            }
          };
          reader.onerror = function (e_reader) {
            showError(
              "Erro ao ler arquivo para agregação",
              e_reader.target.error.message
            );
            setStatus(
              statusAgregada,
              "Erro ao ler arquivo para agregação.",
              "error"
            );
            processedDataAgregada = null;
            updateCompareButtonState();
          };
          reader.readAsArrayBuffer(file);
        }

        function formatDateAgregada(excelDate) {
          if (excelDate instanceof Date && !isNaN(excelDate)) {
            return `${excelDate.getDate().toString().padStart(2, "0")}/${(
              excelDate.getMonth() + 1
            )
              .toString()
              .padStart(2, "0")}/${excelDate.getFullYear()}`;
          }
          if (typeof excelDate === "number") {
            try {
              const jsDate = XLSX.SSF.parse_date_code(excelDate);
              if (jsDate && jsDate.y && jsDate.m && jsDate.d) {
                return `${jsDate.d.toString().padStart(2, "0")}/${jsDate.m
                  .toString()
                  .padStart(2, "0")}/${jsDate.y}`;
              }
            } catch (e) {
              /* ignora erro de parsing */
            }
          }
          return excelDate ? String(excelDate) : "";
        }

        downloadBtnAgregada.addEventListener("click", () => {
          if (!processedDataAgregada || processedDataAgregada.length === 0) {
            setStatus(statusAgregada, "Nenhum dado para baixar.", "error");
            return;
          }
          try {
            const newWorksheet = XLSX.utils.json_to_sheet(
              processedDataAgregada,
              {
                header: [
                  "Data",
                  "Nota",
                  "Código",
                  "Fornecedor",
                  "CFOP",
                  "Valor Contábil",
                ],
              }
            );
            Object.keys(newWorksheet).forEach((cellRef) => {
              if (cellRef[0] === "!") return;
              const cell = newWorksheet[cellRef];
              const colLetter = cellRef.replace(/[0-9]/g, "");
              const rowNumber = parseInt(cellRef.replace(/[A-Z]/g, ""));
              if (rowNumber === 1) return;
              if (colLetter === "F") {
                cell.t = "n";
                cell.z = "R$ #,##0.00";
              } else if (colLetter === "B" || colLetter === "C") {
                cell.t = "s";
              }
            });
            const newWorkbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(
              newWorkbook,
              newWorksheet,
              "Dados Agregados"
            );
            XLSX.writeFile(
              newWorkbook,
              `${originalFileNameAgregada}_Processado.xlsx`
            );
          } catch (error) {
            showError(
              "Erro ao gerar Planilha Agregada para download",
              error.message
            );
          }
        });

        // --- Lógica de Comparação ---
        cfopInput.addEventListener("input", updateCompareButtonState);

        compareBtn.addEventListener("click", () => {
          clearGeneralError();
          setStatus(statusComparison, "Comparando...", "info");
          alertTableBody.innerHTML = "";
          comparisonAlertsContainer.style.display = "none";

          if (
            !processedDataContasAPagar ||
            processedDataContasAPagar.length === 0
          ) {
            setStatus(
              statusComparison,
              'Dados da "Contas a Pagar" não estão carregados.',
              "error"
            );
            return;
          }
          if (!processedDataAgregada || processedDataAgregada.length === 0) {
            setStatus(
              statusComparison,
              'Dados da "Planilha Agregada" não estão carregados.',
              "error"
            );
            return;
          }
          const cfopsTargetRaw = cfopInput.value.trim();
          if (!cfopsTargetRaw) {
            setStatus(
              statusComparison,
              "Por favor, informe o(s) CFOP(s) para verificação.",
              "error"
            );
            return;
          }
          const cfopsTargetList = cfopsTargetRaw
            .split(",")
            .map((cf) => cf.trim())
            .filter((cf) => cf !== "");

          if (cfopsTargetList.length === 0) {
            setStatus(
              statusComparison,
              "Nenhum CFOP válido informado para verificação.",
              "error"
            );
            return;
          }

          let alertsFound = 0;
          const mapAgregada = new Map();
          processedDataAgregada.forEach((rowAg) => {
            const notaAg = String(rowAg["Nota"]).trim();
            const codigoAg = String(rowAg["Código"]).trim();
            const keyAg = `${notaAg}_${codigoAg}`;

            if (!mapAgregada.has(keyAg)) {
              mapAgregada.set(keyAg, []);
            }
            mapAgregada.get(keyAg).push(rowAg);
          });

          processedDataContasAPagar.forEach((rowCAP, indexCAP) => {
            const notaCAP = String(rowCAP["Documento"]).trim();
            const codigoCAP = String(rowCAP["Código"]).trim();
            const valorCAP = rowCAP["Valor Contábil"];

            if (isNaN(valorCAP)) {
              return;
            }

            const keyCAP = `${notaCAP}_${codigoCAP}`;
            const potentialMatchesAgregada = mapAgregada.get(keyCAP);

            if (
              potentialMatchesAgregada &&
              potentialMatchesAgregada.length > 0
            ) {
              potentialMatchesAgregada.forEach((rowAgregadaMatch) => {
                const valorAgregado = rowAgregadaMatch["Valor Contábil"];

                if (Math.abs(valorCAP - valorAgregado) < 0.01) {
                  const cfopsPlanilhaAgregadaString = String(
                    rowAgregadaMatch["CFOP"] || ""
                  );
                  const cfopsPlanilhaAgregadaList = cfopsPlanilhaAgregadaString
                    .split(",")
                    .map((cf) => cf.trim())
                    .filter((cf) => cf !== "");

                  const cfopMatched = cfopsTargetList.find((targetCfop) =>
                    cfopsPlanilhaAgregadaList.includes(targetCfop)
                  );

                  if (cfopMatched) {
                    alertsFound++;
                    const newRow = alertTableBody.insertRow();
                    newRow.insertCell().textContent = notaCAP;
                    newRow.insertCell().textContent = codigoCAP;
                    newRow.insertCell().textContent =
                      cfopsPlanilhaAgregadaString;
                    newRow.insertCell().textContent = cfopMatched;
                    newRow.insertCell().textContent =
                      rowAgregadaMatch["Fornecedor"];
                    newRow.insertCell().textContent = valorCAP.toLocaleString(
                      "pt-BR",
                      { style: "currency", currency: "BRL" }
                    );
                  }
                }
              });
            }
          });

          if (alertsFound > 0) {
            comparisonAlertsContainer.style.display = "block";
            setStatus(
              statusComparison,
              `${alertsFound} alerta(s) encontrado(s). Veja detalhes abaixo.`,
              "info"
            );
          } else {
            setStatus(
              statusComparison,
              "Nenhum alerta gerado pela comparação com os CFOPs informados.",
              "success"
            );
          }
        });
      });
    </script>
  </body>
</html>
