<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Corretor Tipo Item 07 - SPED Fiscal</title>
    <link rel="icon" href="icone.ico" type="image/x-icon" />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
      :root {
        --bg-body: #ffde00;
        --card-bg: #ffffff;
        --border-black: #000000;
        --c-purple: #8b5cf6;
        --c-pink: #ff90e8;
        --c-blue: #06b6d4;
        --c-green: #22c55e;
        --border-width: 3px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Space Grotesk", sans-serif;
        background-color: var(--bg-body);
        background-image: radial-gradient(#000 1px, transparent 1px);
        background-size: 20px 20px;
        color: var(--border-black);
        height: 100vh;
        overflow: hidden;
        display: flex;
      }

      /* SIDEBAR */
      .sidebar {
        width: 240px;
        background: var(--c-purple);
        border-right: var(--border-width) solid var(--border-black);
        padding: 1.5rem 1rem;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        color: #fff;
      }

      .logo {
        font-size: 1.4rem;
        font-weight: 900;
        text-transform: uppercase;
        margin-bottom: 2rem;
        text-shadow: 2px 2px 0 #000;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .nav-item {
        background: #fff;
        color: #000;
        padding: 0.6rem 0.8rem;
        margin-bottom: 0.8rem;
        font-weight: 800;
        text-transform: uppercase;
        border: var(--border-width) solid #000;
        box-shadow: 3px 3px 0 0 #000;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: 0.1s;
        font-size: 0.85rem;
      }

      .nav-item:hover {
        transform: translate(-1px, -1px);
        box-shadow: 4px 4px 0 0 #000;
        background: var(--c-blue);
      }

      /* MAIN CONTENT */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      .scroll-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
      }

      .neo-header {
        background: #fff;
        border: var(--border-width) solid #000;
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 5px 5px 0 0 #000;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .neo-header h1 {
        font-weight: 900;
        font-size: 1.6rem;
        text-transform: uppercase;
      }

      /* INFO CARD */
      .info-card {
        background: #fff;
        border: var(--border-width) solid #000;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 4px 4px 0 0 #000;
      }

      /* UPLOAD AREA */
      .upload-area {
        background: var(--c-pink);
        border: 3px dashed #000;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        cursor: pointer;
        position: relative;
        transition: 0.2s;
      }

      .upload-area:hover {
        background: #ffbdf2;
      }

      .upload-label {
        font-weight: 800;
        font-size: 1rem;
        text-transform: uppercase;
      }

      #txtInput {
        position: absolute;
        inset: 0;
        opacity: 0;
        cursor: pointer;
      }

      /* TABELA */
      .table-container {
        overflow-x: auto;
        border: var(--border-width) solid #000;
        box-shadow: 4px 4px 0 0 #000;
        background: #fff;
        margin-bottom: 1rem;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-family: "Space Mono";
        font-size: 0.75rem;
      }

      th {
        background: #000;
        color: #fff;
        padding: 10px;
        text-align: left;
        text-transform: uppercase;
      }

      td {
        padding: 8px 10px;
        border-bottom: 1px solid #000;
        border-right: 1px solid #eee;
      }

      .btn-neo {
        background: #fff;
        border: 2px solid #000;
        padding: 6px 12px;
        font-family: "Space Grotesk";
        font-weight: 800;
        text-transform: uppercase;
        font-size: 0.75rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        box-shadow: 2px 2px 0 0 #000;
        transition: 0.1s;
      }

      .btn-neo:hover {
        transform: translate(-1px, -1px);
        box-shadow: 3px 3px 0 0 #000;
        background: var(--c-green);
      }

      .btn-neo.purple {
        background: var(--c-purple);
        color: #fff;
        border-color: #000;
      }

      .status-badge {
        padding: 2px 6px;
        border: 1px solid #000;
        font-weight: bold;
        font-size: 0.65rem;
        text-transform: uppercase;
        background: var(--c-green);
      }

      .footer-controls {
        background: #fff;
        border-top: var(--border-width) solid #000;
        padding: 10px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
      }

      .info-text {
        font-family: "Space Mono";
        font-weight: bold;
        font-size: 0.8rem;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="logo">
        <i class="fas fa-tag"></i>
        <span>Tipo Item 07</span>
      </div>
      <nav>
        <div class="nav-item" onclick="location.reload()">
          <i class="fas fa-rotate"></i> Resetar
        </div>
        <div
          class="nav-item"
          onclick="document.getElementById('btnDownload').click()"
        >
          <i class="fas fa-file-download"></i> Baixar Arquivo
        </div>
      </nav>
      <div
        style="
          margin-top: auto;
          font-size: 0.65rem;
          font-family: &quot;Space Mono&quot;;
          color: #eee;
          opacity: 0.8;
        "
      >
        Processamento 100% Local
      </div>
    </aside>

    <main class="main-content">
      <div class="scroll-content">
        <header class="neo-header">
          <div>
            <h1>Corretor de Tipo de Item para '07'</h1>
          </div>
          <div id="stats" class="info-text">Aguardando arquivo...</div>
        </header>

        <div class="info-card">
          <p
            style="
              font-weight: 800;
              text-transform: uppercase;
              margin-bottom: 10px;
            "
          >
            Como funciona:
          </p>
          <p style="font-size: 0.9rem; line-height: 1.5">
            Esta ferramenta analisa o registro <strong>C170</strong>. Se o CFOP
            for de Uso e Consumo (<strong>1556, 1407, 2556, 2407</strong>), ela
            identifica o código do produto e altera automaticamente o registro
            <strong>0200</strong> correspondente (Campo 7 - Tipo do Item) para
            <strong>07</strong> (Material de Uso e Consumo).
          </p>
        </div>

        <div class="upload-area">
          <input
            type="file"
            id="txtInput"
            accept=".txt"
            onchange="processSped(this.files[0])"
          />
          <div class="upload-label">
            <i class="fas fa-file-alt fa-2x" style="margin-bottom: 10px"></i
            ><br />
            Arraste ou clique para carregar o arquivo .TXT do SPED
          </div>
        </div>

        <div class="table-container">
          <table id="logTable">
            <thead>
              <tr>
                <th>Código Item</th>
                <th>Registro</th>
                <th>Ação</th>
                <th>Detalhes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="footer-controls">
        <div class="info-text" id="statusMsg">Pronto para iniciar</div>
        <button id="btnDownload" class="btn-neo purple" style="display: none">
          <i class="fas fa-download"></i> Baixar Arquivo Modificado
        </button>
      </div>
    </main>

    <script>
      async function processSped(file) {
        if (!file) return;

        const tbody = document.querySelector("#logTable tbody");
        const statusMsg = document.getElementById("statusMsg");
        const statsDisplay = document.getElementById("stats");

        tbody.innerHTML = "";
        statusMsg.innerText = "Lendo arquivo...";

        // Mantem o nome original com sufixo
        const originalFileName = file.name.replace(".txt", "_TIPO07.txt");

        try {
          // Leitura ISO-8859-1 para preservar acentos
          const buffer = await file.arrayBuffer();
          const decoder = new TextDecoder("iso-8859-1");
          const text = decoder.decode(buffer);

          const lines = text.split(/\r?\n/);

          let processedLines = [];

          // Codes to change to type 07
          let usageCodes = new Set();
          const targetCFOPs = ["1556", "1407", "2556", "2407"];

          // ETAPA 1: Identificar itens usados em CFOPs de Uso e Consumo
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            if (!line.trim()) continue;

            const fields = line.split("|");

            // |C170|...
            if (fields[1] === "C170") {
              const cfop = fields[11];
              if (targetCFOPs.includes(cfop)) {
                // fields[3] = Código do Item
                usageCodes.add(fields[3]);
              }
            }
          }

          // ETAPA 2: Alterar Registro 0200
          let changedCount = 0;

          for (let i = 0; i < lines.length; i++) {
            let line = lines[i];
            if (!line.trim()) {
              processedLines.push(line);
              continue;
            }

            let fields = line.split("|");

            // |0200|COD|DESCR|COD_BARRA|COD_ANT|UNID|TIPO|...
            // indices: 1=REG, 2=COD, 3=DESCR, 4=BARRA, 5=ANT, 6=UNID, 7=TIPO
            if (fields[1] === "0200") {
              const code = fields[2];
              const currentType = fields[7];

              // Se este item foi usado em um CFOP alvo E o tipo não é 07 ainda
              if (usageCodes.has(code) && currentType !== "07") {
                fields[7] = "07"; // Altera Tipo do Item para 07
                line = fields.join("|");
                changedCount++;

                if (changedCount <= 50) {
                  addLog(
                    code,
                    "0200",
                    `Tipo alterado de ${currentType} para 07`,
                    "Atualizado",
                  );
                }
              }
            }

            processedLines.push(line);
          }

          const modifiedContent = processedLines.join("\r\n");

          const msg = `Itens alterados para Tipo 07: ${changedCount}`;
          statsDisplay.innerText = msg;
          statusMsg.innerText = "Processamento concluído!";

          const btn = document.getElementById("btnDownload");
          btn.style.display = "flex";
          btn.onclick = function () {
            const blob = new Blob([modifiedContent], {
              type: "text/plain;charset=iso-8859-1",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = originalFileName;
            a.click();
          };

          if (changedCount > 50) {
            addLog(
              "...",
              "...",
              `Mais ${changedCount - 50} itens ocultos...`,
              "Info",
            );
          }
        } catch (e) {
          console.error(e);
          statusMsg.innerText = "Erro ao processar.";
          alert("Erro: " + e.message);
        }
      }

      function addLog(code, reg, details, action) {
        const tbody = document.querySelector("#logTable tbody");
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td font-family="Space Mono" style="font-weight:bold">${code}</td>
          <td>${reg}</td>
          <td><span class="status-badge">${action}</span></td>
          <td font-family="Space Mono">${details}</td>
        `;
        tbody.appendChild(tr);
      }
    </script>
  </body>
</html>
