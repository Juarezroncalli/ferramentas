<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisador de Estouro de Caixa IRPF (.DEC)</title>
    <style>
      :root {
        --primary-color: #4f0072;
        --accent-color: #fb0a5e;
        --background-color: #ffffff;
        --form-bg-color: #f9f9f9;
        --text-color: #333333;
        --border-color: #e0e0e0;
        --text-color-light: #ffffff;
        --sombra: 0 4px 12px rgba(79, 0, 114, 0.15);
        --transicao: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 30px;
        min-height: 100vh;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        background: var(--background-color);
        border-radius: 20px;
        box-shadow: var(--sombra);
        overflow: hidden;
        animation: slideUp 0.6s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        color: var(--text-color-light);
        padding: 40px;
        text-align: center;
        position: relative;
        overflow: hidden;
      }

      .header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        animation: rotate 20s linear infinite;
      }

      @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
        max-width: 800px;
        margin: 0 auto;
      }

      .content {
        padding: 40px;
      }

      .upload-section {
        background: var(--form-bg-color);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        border: 2px dashed var(--border-color);
        transition: var(--transicao);
        text-align: center;
      }

      .upload-section:hover {
        border-color: var(--primary-color);
        background: #f5f5f5;
        transform: translateY(-2px);
        box-shadow: var(--sombra);
      }

      .upload-section.dragover {
        border-color: var(--accent-color);
        background: #fef7f7;
        transform: scale(1.02);
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin-bottom: 20px;
      }

      .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-input-label {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        color: var(--text-color-light);
        padding: 15px 30px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transicao);
        box-shadow: var(--sombra);
      }

      .file-input-label:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(79, 0, 114, 0.25);
      }

      .file-input-label::before {
        content: 'üìÅ';
        font-size: 1.2rem;
      }

      .analyze-btn {
        background: linear-gradient(135deg, var(--accent-color) 0%, #e6095a 100%);
        color: var(--text-color-light);
        border: none;
        padding: 15px 40px;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transicao);
        box-shadow: 0 4px 12px rgba(251, 10, 94, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .analyze-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(251, 10, 94, 0.4);
      }

      .analyze-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .analyze-btn::before {
        content: 'üîç';
        font-size: 1.2rem;
      }

      .results {
        background: var(--background-color);
        border-radius: 16px;
        padding: 30px;
        box-shadow: var(--sombra);
        border: 1px solid var(--border-color);
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .results h2 {
        color: var(--primary-color);
        font-size: 1.8rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid var(--primary-color);
        position: relative;
      }

      .results h2::after {
        content: '';
        position: absolute;
        bottom: -3px;
        left: 0;
        width: 50px;
        height: 3px;
        background: var(--accent-color);
      }

      .info-block {
        background: var(--form-bg-color);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid var(--primary-color);
      }

      .info-block p {
        margin: 8px 0;
        font-size: 1rem;
      }

      .info-block strong {
        color: var(--primary-color);
        font-weight: 600;
      }

      .status-card {
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        font-weight: 600;
        text-align: center;
        font-size: 1.1rem;
        box-shadow: var(--sombra);
      }

      .warning {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        color: #dc2626;
        border: 2px solid #fecaca;
      }

      .success {
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        color: #16a34a;
        border: 2px solid #bbf7d0;
      }

      .table-container {
        overflow-x: auto;
        margin: 20px 0;
        border-radius: 12px;
        box-shadow: var(--sombra);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        background: var(--background-color);
        border-radius: 12px;
        overflow: hidden;
      }

      th {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
        color: var(--text-color-light);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95rem;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.95rem;
      }

      tr:hover {
        background: var(--form-bg-color);
      }

      tr:last-child td {
        border-bottom: none;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 40px;
        color: var(--text-color);
        font-size: 1.1rem;
      }

      .loading::before {
        content: '';
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top: 2px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .note {
        background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        border: 1px solid #fbbf24;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        font-size: 0.9rem;
        color: #92400e;
        box-shadow: var(--sombra);
      }

      .note strong {
        color: #78350f;
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
          padding-top: 20px;
        }

        .header {
          padding: 30px 20px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .content {
          padding: 20px;
        }

        .upload-section {
          padding: 20px;
        }

        .file-input-label,
        .analyze-btn {
          padding: 12px 20px;
          font-size: 1rem;
        }

        table {
          font-size: 0.85rem;
        }

        th, td {
          padding: 10px 8px;
        }
      }

      .file-selected {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border: 2px solid #10b981;
        color: #065f46;
        padding: 15px;
        border-radius: 12px;
        margin: 10px 0;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        box-shadow: var(--sombra);
      }

      .file-selected::before {
        content: '‚úÖ';
      }

      .upload-section h3 {
        margin-bottom: 15px;
        color: var(--primary-color);
        font-size: 1.3rem;
      }

      .upload-section p {
        margin-bottom: 20px;
        color: var(--text-color);
        opacity: 0.8;
      }

      .waiting-state {
        text-align: center;
        padding: 40px;
        color: var(--text-color);
      }

      .waiting-state h3 {
        margin-bottom: 10px;
        color: var(--primary-color);
      }

      .waiting-state .icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--accent-color);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Analisador de Estouro de Caixa IRPF</h1>
        <p>
          Ferramenta moderna para an√°lise de arquivos .DEC da Declara√ß√£o de
          Imposto de Renda Pessoa F√≠sica. Verifique se o aumento patrimonial √©
          compat√≠vel com as receitas declaradas de forma r√°pida e intuitiva.
        </p>
      </div>

      <div class="content">
        <div class="upload-section" id="uploadSection">
          <h3>üìä Selecione seu arquivo .DEC</h3>
          <p>
            Arraste e solte seu arquivo aqui ou clique no bot√£o abaixo
          </p>
          
          <div class="file-input-wrapper">
            <input type="file" id="decFile" accept=".DEC" class="file-input" />
            <label for="decFile" class="file-input-label">
              Escolher Arquivo .DEC
            </label>
          </div>
          
          <div id="fileSelected" style="display: none;"></div>
          
          <button class="analyze-btn" onclick="analyzeFile()" id="analyzeBtn" disabled>
            Analisar Arquivo
          </button>
        </div>

        <div class="results" id="results">
          <div class="waiting-state">
            <div class="icon">üìã</div>
            <h3>Aguardando arquivo para an√°lise</h3>
            <p>Selecione um arquivo .DEC para come√ßar a an√°lise</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // File input handling
      const fileInput = document.getElementById('decFile');
      const uploadSection = document.getElementById('uploadSection');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const fileSelectedDiv = document.getElementById('fileSelected');

      fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
          const fileName = e.target.files[0].name;
          fileSelectedDiv.innerHTML = `Arquivo selecionado: ${fileName}`;
          fileSelectedDiv.style.display = 'block';
          fileSelectedDiv.className = 'file-selected';
          analyzeBtn.disabled = false;
        } else {
          fileSelectedDiv.style.display = 'none';
          analyzeBtn.disabled = true;
        }
      });

      // Drag and drop functionality
      uploadSection.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadSection.classList.add('dragover');
      });

      uploadSection.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
      });

      uploadSection.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.toLowerCase().endsWith('.dec')) {
          fileInput.files = files;
          const event = new Event('change', { bubbles: true });
          fileInput.dispatchEvent(event);
        }
      });

      // Helper function to parse fixed-width fields
      function parseField(line, start, end, isNumeric = false, decimalPlaces = 0) {
        if (start > line.length) return isNumeric ? 0 : "";
        const value = line
          .substring(start - 1, Math.min(end, line.length))
          .trim();
        if (isNumeric) {
          const num = parseFloat(value.replace(",", ".")) || 0;
          return num / Math.pow(10, decimalPlaces);
        }
        return value;
      }

      async function analyzeFile() {
        const fileInput = document.getElementById("decFile");
        const resultsDiv = document.getElementById("results");
        
        resultsDiv.innerHTML = '<div class="loading">Analisando arquivo...</div>';

        if (fileInput.files.length === 0) {
          resultsDiv.innerHTML = `
            <div class="status-card warning">
              ‚ö†Ô∏è Por favor, selecione um arquivo .DEC para an√°lise.
            </div>
          `;
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (event) {
          const fileContent = event.target.result;
          const lines = fileContent.split(/\r?\n/);

          let taxpayerName = "N√£o encontrado";
          let taxpayerCPF = "N√£o encontrado";
          let isCompleteDeclaration = false;

          let totalTaxableIncome = 0;
          let totalExemptIncome = 0;
          let totalExclusiveTaxIncome = 0;

          let assetsPreviousYear = 0;
          let assetsCurrentYear = 0;
          let debtsPreviousYear = 0;
          let debtsCurrentYear = 0;

          let foundHeader = false;
          let foundSummaryReg = false;

          for (const line of lines) {
            if (line.length < 2) continue;
            const regType = line.substring(0, 2);

            if (regType === "IR") {
              foundHeader = true;
              taxpayerName = parseField(line, 40, 99);
              taxpayerCPF = parseField(line, 22, 32);
              const inCompleta = parseField(line, 121, 121);
              isCompleteDeclaration = inCompleta === "S";

              totalTaxableIncome = parseField(line, 696, 708, true, 2);
              totalExemptIncome = parseField(line, 737, 749, true, 2);
              totalExclusiveTaxIncome = parseField(line, 750, 762, true, 2);
            } else if (regType === "16") {
              if (taxpayerName === "N√£o encontrado")
                taxpayerName = parseField(line, 14, 73);
              if (taxpayerCPF === "N√£o encontrado")
                taxpayerCPF = parseField(line, 3, 13);
            } else if (regType === "18" && !isCompleteDeclaration) {
              foundSummaryReg = true;
              assetsPreviousYear = parseField(line, 275, 287, true, 2);
              assetsCurrentYear = parseField(line, 288, 300, true, 2);
              debtsPreviousYear = parseField(line, 366, 378, true, 2);
              debtsCurrentYear = parseField(line, 379, 391, true, 2);
            } else if (regType === "20" && isCompleteDeclaration) {
              foundSummaryReg = true;
              assetsPreviousYear = parseField(line, 405, 417, true, 2);
              assetsCurrentYear = parseField(line, 418, 430, true, 2);
              debtsPreviousYear = parseField(line, 431, 443, true, 2);
              debtsCurrentYear = parseField(line, 444, 456, true, 2);
            }
          }

          if (!foundHeader) {
            resultsDiv.innerHTML = `
              <div class="status-card warning">
                ‚ùå Arquivo .DEC inv√°lido ou n√£o cont√©m registro Header (IR).
              </div>
            `;
            return;
          }

          const netPatrimonyPreviousYear = assetsPreviousYear - debtsPreviousYear;
          const netPatrimonyCurrentYear = assetsCurrentYear - debtsCurrentYear;
          const patrimonialVariation = netPatrimonyCurrentYear - netPatrimonyPreviousYear;
          const totalDeclaredRevenue = totalTaxableIncome + totalExemptIncome + totalExclusiveTaxIncome;
          const difference = totalDeclaredRevenue - patrimonialVariation;

          let resultHTML = `<h2>üìä Resultado da An√°lise</h2>`;
          
          resultHTML += `<div class="info-block">
            <p><strong>üë§ Contribuinte:</strong> ${taxpayerName}</p>
            <p><strong>üÜî CPF:</strong> ${taxpayerCPF}</p>
            <p><strong>üìã Tipo de Declara√ß√£o:</strong> ${isCompleteDeclaration ? "Completa" : "Simplificada (Desconto Simplificado)"}</p>
          </div>`;

          resultHTML += `<h2>üè† Situa√ß√£o Patrimonial</h2>`;
          resultHTML += `<div class="table-container">
            <table>
              <tr><th>Descri√ß√£o</th><th>Ano Anterior (R$)</th><th>Ano Atual (R$)</th></tr>
              <tr><td>Total de Bens e Direitos</td><td>${assetsPreviousYear.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>${assetsCurrentYear.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>
              <tr><td>Total de D√≠vidas e √înus Reais</td><td>${debtsPreviousYear.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>${debtsCurrentYear.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>
              <tr style="background: var(--form-bg-color); font-weight: 600;"><td><strong>Patrim√¥nio L√≠quido</strong></td><td><strong>R$ ${netPatrimonyPreviousYear.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td><td><strong>R$ ${netPatrimonyCurrentYear.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td></tr>
            </table>
          </div>`;
          
          resultHTML += `<div class="info-block">
            <p><strong>üìà Varia√ß√£o Patrimonial no Per√≠odo:</strong> R$ ${patrimonialVariation.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
          </div>`;

          resultHTML += `<h2>üí∞ Receitas Declaradas (Resumo)</h2>`;
          resultHTML += `<div class="table-container">
            <table>
              <tr><th>Tipo de Receita</th><th>Valor (R$)</th></tr>
              <tr><td>Total de Rendimentos Tribut√°veis (Titular e Dependentes)</td><td>R$ ${totalTaxableIncome.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>
              <tr><td>Total de Rendimentos Isentos e N√£o Tribut√°veis</td><td>R$ ${totalExemptIncome.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>
              <tr><td>Total de Rendimentos Sujeitos √† Tributa√ß√£o Exclusiva/Definitiva</td><td>R$ ${totalExclusiveTaxIncome.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td></tr>
              <tr style="background: var(--form-bg-color); font-weight: 600;"><td><strong>Total das Receitas Declaradas</strong></td><td><strong>R$ ${totalDeclaredRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong></td></tr>
            </table>
          </div>`;

          resultHTML += `<h2>üîç An√°lise de Caixa</h2>`;
          
          if (difference < 0) {
            resultHTML += `<div class="status-card warning">
              ‚ö†Ô∏è <strong>ESTOURO DE CAIXA DETECTADO!</strong><br><br>
              A varia√ß√£o patrimonial (R$ ${patrimonialVariation.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) √© MAIOR que o total de receitas declaradas (R$ ${totalDeclaredRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}).<br>
              <strong>Diferen√ßa: R$ ${Math.abs(difference).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
            </div>`;
            resultHTML += `<p>Isso sugere que o aumento de patrim√¥nio ou redu√ß√£o de d√≠vidas n√£o √© totalmente justificado pelas receitas declaradas neste resumo. Pode haver omiss√£o de rendimentos ou outras fontes n√£o consideradas nesta an√°lise simplificada.</p>`;
          } else {
            resultHTML += `<div class="status-card success">
              ‚úÖ <strong>Situa√ß√£o de Caixa Compat√≠vel</strong><br><br>
              O total de receitas declaradas (R$ ${totalDeclaredRevenue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) √© SUFICIENTE para cobrir a varia√ß√£o patrimonial (R$ ${patrimonialVariation.toLocaleString('pt-BR', {minimumFractionDigits: 2})}).<br>
              <strong>Saldo: R$ ${difference.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>
            </div>`;
          }

          if (!foundSummaryReg) {
            resultHTML += `<div class="status-card warning">
              ‚ö†Ô∏è N√£o foi poss√≠vel encontrar os registros de totais patrimoniais adequados para o tipo de declara√ß√£o. A an√°lise patrimonial pode estar incompleta.
            </div>`;
          }

          resultHTML += `<div class="note">
            <strong>üìù Observa√ß√£o Importante:</strong> Esta √© uma an√°lise simplificada que n√£o considera despesas de custeio pessoal (moradia, alimenta√ß√£o, sa√∫de n√£o dedut√≠vel, etc.) que impactariam o caixa dispon√≠vel. Um "estouro de caixa" real para a Receita Federal consideraria uma estimativa dessas despesas. Os dados s√£o baseados nos totais informados no Header da declara√ß√£o e nos registros patrimoniais.
          </div>`;

          resultsDiv.innerHTML = resultHTML;
        };

        reader.onerror = function () {
          resultsDiv.innerHTML = `
            <div class="status-card warning">
              ‚ùå Erro ao ler o arquivo. Verifique se o arquivo est√° correto e tente novamente.
            </div>
          `;
        };

        reader.readAsText(file, "ISO-8859-1");
      }
    </script>
  </body>
</html>