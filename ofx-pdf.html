<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizador de Extrato Bancário (OFX)</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #4f0072;
        --primary-hover: #370052;
        --bg-light: #f4f4f9;
        --accent-bg: #f0e6fa;
        --text-color: #333;
        --border-color: #ddd;
      }

      body {
        font-family: Arial, sans-serif;
        background: var(--bg-light);
        margin: 0;
        padding: 2rem;
        color: var(--text-color);
      }

      /* Container Principal - Simula A4 na tela */
      .container {
        max-width: 210mm; /* Largura A4 */
        min-height: 297mm; /* Altura A4 */
        margin: auto;
        background: #fff;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      /* Cabeçalho do Site (Upload) */
      .no-print-area {
        background: var(--accent-bg);
        padding: 1.5rem;
        border-radius: 8px;
        border: 1px solid var(--primary-color);
        margin-bottom: 2rem;
        text-align: center;
      }

      h1 {
        text-align: center;
        margin-bottom: 0.5rem;
        color: var(--text-color);
        font-size: 1.8rem;
      }

      .bank-header {
        display: none; /* Aparece só depois de importar */
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
        justify-content: space-between;
        align-items: center;
      }

      .bank-info h2 {
        margin: 0;
        color: var(--primary-color);
        font-size: 1.5rem;
      }

      .bank-info p {
        margin: 5px 0 0 0;
        font-size: 0.9rem;
        color: #666;
      }

      .periodo-info {
        text-align: right;
        font-size: 0.9rem;
        font-weight: bold;
      }

      /* Botões */
      .btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.7rem 1.5rem;
        margin: 0.3rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn:hover {
        background: var(--primary-hover);
      }

      .upload-area {
        border: 2px dashed #ccc;
        padding: 1.5rem;
        text-align: center;
        margin: 1rem 0;
        cursor: pointer;
        border-radius: 8px;
        background: #fff;
        transition: all 0.3s;
      }

      .upload-area.dragover {
        background: var(--accent-bg);
        border-color: var(--primary-color);
      }

      /* Tabela de Extrato */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
        font-size: 0.85rem; 
      }

      th, td {
        border-bottom: 1px solid var(--border-color);
        padding: 8px 10px;
        text-align: left;
      }

      th {
        background: var(--primary-color);
        color: white;
        text-transform: uppercase;
        font-size: 0.8rem;
      }

      /* Alinhamento de colunas */
      td.col-data { width: 100px; text-align: center; }
      td.col-desc { text-align: left; }
      td.col-doc { width: 120px; text-align: center; color: #666; }
      td.col-valor { width: 120px; text-align: right; font-weight: bold; }

      /* Cores de valores */
      .valor-positivo { color: #007200; }
      .valor-negativo { color: #cc0000; }
      .valor-neutro { color: #333; }

      /* Resumo do Extrato */
      .summary-box {
        display: none;
        margin-top: 2rem;
        padding: 1rem;
        background: var(--bg-light);
        border-top: 2px solid var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
      }
      
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        text-align: center;
      }

      .summary-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .summary-item span.label {
        font-size: 0.85rem;
        color: #666;
        text-transform: uppercase;
        font-weight: bold;
      }

      .summary-item span.value {
        font-size: 1.1rem;
        font-weight: bold;
      }

      /* Destaca o Saldo Final */
      .summary-item.final {
        background: #e8e8e8;
        padding: 5px;
        border-radius: 4px;
      }

      /* --- ESTILOS DE IMPRESSÃO (A4) --- */
      @media print {
        @page {
          size: A4;
          margin: 10mm;
        }
        
        body {
          background: #fff;
          padding: 0;
          margin: 0;
          -webkit-print-color-adjust: exact;
        }

        .container {
          box-shadow: none;
          margin: 0;
          width: 100%;
          max-width: 100%;
          border: none;
          padding: 0;
        }

        .no-print-area, .btn, .upload-area, h1.site-title {
          display: none !important;
        }

        .bank-header, .summary-box {
          display: block !important;
        }

        th {
          background-color: var(--primary-color) !important;
          color: white !important;
          -webkit-print-color-adjust: exact; 
        }

        tr {
          page-break-inside: avoid;
        }
        
        /* Ajuste do grid de resumo na impressão */
        .summary-box {
            background-color: #f4f4f9 !important;
            -webkit-print-color-adjust: exact;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="site-title">
        <i class="fa-solid fa-file-invoice-dollar"></i> Visualizador de Extrato OFX
      </h1>

      <div class="no-print-area">
        <p>Importe seu arquivo OFX para gerar um extrato pronto para impressão.</p>
        
        <input
          type="file"
          id="uploadOfx"
          accept=".ofx, .xml"
          style="display: none"
        />
        
        <div class="upload-area" id="uploadArea">
          <i class="fa-solid fa-cloud-arrow-up" style="font-size: 2rem; color: #4f0072;"></i><br>
          Clique aqui ou arraste o arquivo <strong>.OFX</strong>
        </div>

        <div id="statusMsg" style="margin-bottom: 10px; font-weight: bold; color: #4f0072;"></div>

        <button id="printBtn" class="btn" style="display: none;">
          <i class="fa-solid fa-print"></i> Imprimir Extrato
        </button>
        <button id="clearBtn" class="btn" style="display: none; background-color: #666;">
          <i class="fa-solid fa-trash"></i> Limpar
        </button>
      </div>

      <div id="bankHeader" class="bank-header">
        <div class="bank-info">
          <h2 id="bankName">Banco</h2>
          <p>Conta: <span id="accountVal">--</span></p>
        </div>
        <div class="periodo-info">
          <p>Gerado em: <span id="generationDate">--/--/----</span></p>
        </div>
      </div>

      <table id="dataTable">
        <thead>
          <tr>
            <th class="col-data">Data</th>
            <th class="col-desc">Histórico</th>
            <th class="col-doc">Documento</th>
            <th class="col-valor">Valor (R$)</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>

      <div id="summaryBox" class="summary-box">
        <div class="summary-grid">
            <div class="summary-item">
                <span class="label">Saldo Anterior (Calc.)</span>
                <span id="initialBalance" class="value valor-neutro">0,00</span>
            </div>
            <div class="summary-item">
                <span class="label">Total Créditos</span>
                <span id="totalCredits" class="value valor-positivo">0,00</span>
            </div>
            <div class="summary-item">
                <span class="label">Total Débitos</span>
                <span id="totalDebits" class="value valor-negativo">0,00</span>
            </div>
            <div class="summary-item final">
                <span class="label">Saldo Final (Arquivo)</span>
                <span id="finalBalance" class="value">0,00</span>
            </div>
        </div>
      </div>

    </div>

    <script>
      const uploadInput = document.getElementById("uploadOfx");
      const uploadArea = document.getElementById("uploadArea");
      const statusMsg = document.getElementById("statusMsg");
      const tableBody = document.querySelector("#dataTable tbody");
      const printBtn = document.getElementById("printBtn");
      const clearBtn = document.getElementById("clearBtn");
      const bankHeader = document.getElementById("bankHeader");
      const summaryBox = document.getElementById("summaryBox");

      // Upload Events
      uploadArea.addEventListener("click", () => uploadInput.click());
      
      ["dragenter", "dragover"].forEach(evt => {
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });
      });
      
      ["dragleave", "drop"].forEach(evt => {
        uploadArea.addEventListener(evt, (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
        });
      });

      uploadArea.addEventListener("drop", (e) => handleFile(e.dataTransfer.files[0]));
      uploadInput.addEventListener("change", (e) => handleFile(e.target.files[0]));
      
      printBtn.addEventListener("click", () => window.print());
      clearBtn.addEventListener("click", () => location.reload());

      function handleFile(file) {
        if (!file) return;
        
        statusMsg.textContent = "Lendo arquivo...";
        const reader = new FileReader();
        
        reader.onload = (e) => {
          const content = e.target.result;
          parseOFX(content);
        };
        
        reader.readAsText(file);
      }

      function parseOFX(ofxData) {
        try {
          // 1. Extrair Dados do Banco/Conta
          const bankNameMatch = ofxData.match(/<ORG>(.*?)(\r|\n|<)/);
          const accountMatch = ofxData.match(/<ACCTID>(.*?)(\r|\n|<)/);
          
          const bankName = bankNameMatch ? bankNameMatch[1].trim() : "Instituição Financeira";
          const accountId = accountMatch ? accountMatch[1].trim() : "Não informada";
          
          document.getElementById("bankName").textContent = bankName;
          document.getElementById("accountVal").textContent = accountId;
          document.getElementById("generationDate").textContent = new Date().toLocaleDateString('pt-BR');

          // 2. Extrair Saldo Final (Ledger Balance)
          // Procura por <LEDGERBAL>...<BALAMT>...
          const ledgerMatch = ofxData.match(/<LEDGERBAL>[\s\S]*?<BALAMT>(.*?)(\r|\n|<)/);
          let finalBalance = 0;
          let hasLedger = false;

          if (ledgerMatch && ledgerMatch[1]) {
             finalBalance = parseFloat(ledgerMatch[1].replace(',', '.'));
             hasLedger = true;
          }

          // 3. Extrair Transações
          const transactions = [];
          const regexBlock = /<STMTTRN>([\s\S]*?)<\/STMTTRN>/g; 
          let match;

          let totalCred = 0;
          let totalDeb = 0;

          while ((match = regexBlock.exec(ofxData)) !== null) {
            const block = match[1];
            
            const type = getTagValue(block, "TRNTYPE");
            const dateRaw = getTagValue(block, "DTPOSTED");
            const amountRaw = getTagValue(block, "TRNAMT");
            const fitid = getTagValue(block, "FITID");
            const checkNum = getTagValue(block, "CHECKNUM") || "";
            const memo = getTagValue(block, "MEMO");

            if (!amountRaw) continue;

            const amount = parseFloat(amountRaw.replace(',', '.'));
            const date = parseOfxDate(dateRaw);

            if (amount >= 0) totalCred += amount;
            else totalDeb += amount;

            transactions.push({
              date: date,
              desc: memo,
              doc: checkNum,
              val: amount,
              type: type
            });
          }

          if (transactions.length === 0) {
            statusMsg.textContent = "Nenhuma transação encontrada no arquivo.";
            return;
          }

          // 4. Calcular Saldo Inicial
          // Inicial = Final - Movimentação Total
          // Se o OFX não tiver LEDGERBAL, assumimos Saldo Inicial = 0 (ou alertamos)
          const totalMovement = totalCred + totalDeb;
          const initialBalance = hasLedger ? (finalBalance - totalMovement) : 0;

          renderTable(transactions);
          updateSummary(initialBalance, totalCred, totalDeb, finalBalance);
          
          statusMsg.textContent = `Sucesso! ${transactions.length} lançamentos carregados.`;
          bankHeader.style.display = "flex";
          summaryBox.style.display = "block";
          printBtn.style.display = "inline-flex";
          clearBtn.style.display = "inline-flex";
          uploadArea.style.display = "none";

        } catch (err) {
          console.error(err);
          statusMsg.textContent = "Erro ao processar o arquivo OFX.";
        }
      }

      function getTagValue(block, tagName) {
        const regex = new RegExp(`<${tagName}>(.*?)(<|\r|\n)`, "i");
        const match = block.match(regex);
        if (match) return match[1].trim();
        return "";
      }

      function parseOfxDate(dateStr) {
        if (!dateStr || dateStr.length < 8) return dateStr;
        const y = dateStr.substring(0, 4);
        const m = dateStr.substring(4, 6);
        const d = dateStr.substring(6, 8);
        return `${d}/${m}/${y}`;
      }

      function formatMoney(val) {
        return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function renderTable(data) {
        tableBody.innerHTML = "";
        
        data.forEach(item => {
          const tr = document.createElement("tr");
          
          const tdDate = document.createElement("td");
          tdDate.className = "col-data";
          tdDate.textContent = item.date;

          const tdDesc = document.createElement("td");
          tdDesc.className = "col-desc";
          tdDesc.textContent = item.desc;

          const tdDoc = document.createElement("td");
          tdDoc.className = "col-doc";
          tdDoc.textContent = item.doc;

          const tdVal = document.createElement("td");
          tdVal.className = "col-valor";
          tdVal.textContent = item.val < 0 ? formatMoney(item.val) : "+" + formatMoney(item.val);
          
          if (item.val < 0) tdVal.classList.add("valor-negativo");
          else tdVal.classList.add("valor-positivo");

          tr.appendChild(tdDate);
          tr.appendChild(tdDesc);
          tr.appendChild(tdDoc);
          tr.appendChild(tdVal);
          
          tableBody.appendChild(tr);
        });
      }

      function updateSummary(initial, cred, deb, final) {
        // Saldo Inicial
        const elInitial = document.getElementById("initialBalance");
        elInitial.textContent = formatMoney(initial);
        elInitial.className = "value " + (initial < 0 ? "valor-negativo" : "valor-neutro");

        // Créditos e Débitos
        document.getElementById("totalCredits").textContent = formatMoney(cred);
        document.getElementById("totalDebits").textContent = formatMoney(deb);
        
        // Saldo Final
        const elFinal = document.getElementById("finalBalance");
        elFinal.textContent = formatMoney(final);
        elFinal.className = "value " + (final < 0 ? "valor-negativo" : "valor-positivo");
      }
    </script>
  </body>
</html>