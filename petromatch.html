<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PETROLUB RM - Confer√™ncia de Pedidos</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>

    <style>
      :root {
        /* Paleta TOTVS Portinari / RM Nova MDI */
        --totvs-brand: #0c5e9b; /* Azul TOTVS */
        --totvs-brand-hover: #00447a;

        --bg-app: #f0f2f5;
        --bg-card: #ffffff;

        --text-primary: #262626;
        --text-secondary: #6e7a85;

        --border-color: #d6d6d6;
        --divider-color: #e6e6e6;

        --success-color: #0c9451;
        --success-bg: #e7f7ef;

        --error-color: #c62828;
        --error-bg: #fde8e8;

        --highlight-bg: #e3f2fd;
        --selection-border: #2196f3;
      }

      * {
        box-sizing: border-box;
      }

      body {
        background-color: var(--bg-app);
        font-family: "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
      }

      /* Topbar estilo RM */
      .rm-header {
        background-color: var(--totvs-brand);
        color: white;
        padding: 0 24px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .rm-logo {
        font-weight: 700;
        font-size: 1.1rem;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .rm-logo::before {
        content: "PETROLUB";
        font-weight: 900;
        background: white;
        color: var(--totvs-brand);
        padding: 2px 6px;
        border-radius: 2px;
        font-size: 0.8rem;
      }

      .container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 20px;
      }

      h1,
      h2,
      h3 {
        margin-top: 0;
        font-weight: 600;
        color: var(--text-primary);
      }

      h2 {
        font-size: 1.1rem;
      }
      h3 {
        font-size: 1rem;
        color: var(--text-secondary);
      }

      /* Cards estilo Portinari UI (Widget) */
      .po-widget {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      /* Bot√µes estilo Portinari */
      .po-btn {
        background: white;
        border: 1px solid var(--totvs-brand);
        color: var(--totvs-brand);
        padding: 8px 16px;
        font-family: inherit;
        font-weight: 600;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .po-btn:hover {
        background-color: #f5f9ff;
        box-shadow: 0 2px 4px rgba(12, 94, 155, 0.15);
      }

      .po-btn.primary {
        background-color: var(--totvs-brand);
        color: white;
      }
      .po-btn.primary:hover {
        background-color: var(--totvs-brand-hover);
      }

      .po-btn.danger {
        border-color: var(--error-color);
        color: var(--error-color);
      }
      .po-btn.danger:hover {
        background-color: var(--error-bg);
      }

      .po-btn.active-mode {
        background-color: var(--error-color);
        color: white;
      }

      /* Grid de Upload */
      .upload-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
      }

      .upload-zone {
        border: 1px dashed #b0b0b0;
        background-color: #fafafa;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s;
        color: var(--text-secondary);
      }
      .upload-zone:hover {
        border-color: var(--totvs-brand);
        background-color: #f5f9ff;
        color: var(--totvs-brand);
      }
      .upload-zone.highlight {
        border-color: var(--totvs-brand);
        background-color: #e3f2fd;
      }

      /* Grids de Confer√™ncia */
      .recon-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        overflow: hidden;
      }

      .panel-header {
        background: #f7f9fa;
        color: var(--text-secondary);
        padding: 12px 16px;
        font-weight: 600;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 0.85rem;
      }

      .panel-header-top {
        display: flex;
        justify-content: space-between;
        text-transform: uppercase;
      }

      .panel-sub {
        font-size: 0.8rem;
        color: var(--totvs-brand);
        font-weight: normal;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .table-scroll {
        max-height: 500px;
        overflow-y: auto;
        background: white;
        border-right: 1px solid var(--border-color);
      }
      .table-scroll:last-child {
        border-right: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      th {
        background: #ffffff;
        color: var(--text-secondary);
        font-weight: 600;
        padding: 12px 8px;
        text-align: left;
        border-bottom: 2px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.8rem;
      }

      td {
        border-bottom: 1px solid var(--divider-color);
        padding: 10px 8px;
        vertical-align: middle;
        color: var(--text-primary);
      }

      tr.item-row {
        cursor: pointer;
        transition: background 0.1s;
      }
      tr.item-row:hover {
        background: #f5f5f5;
      }

      tr.item-row:nth-child(even) {
        background-color: #fafafa;
      }

      .selected {
        background: var(--highlight-bg) !important;
        box-shadow: inset 3px 0 0 var(--selection-border);
      }

      .is-match {
        background: var(--success-bg) !important;
        color: var(--success-color);
      }

      .is-error {
        background: var(--error-bg) !important;
        color: var(--error-color);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 20px;
        min-width: 20px;
        padding: 0 6px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 0.7rem;
        background: white;
        border: 1px solid #ddd;
      }

      .footer-panel {
        background: #f7f9fa;
        border-top: 1px solid var(--border-color);
        padding: 16px;
      }

      .total-display {
        color: var(--text-primary);
        font-size: 1rem;
        font-weight: 700;
        text-align: right;
        margin-bottom: 10px;
      }

      .payment-info {
        font-size: 0.8rem;
        background: white;
        border: 1px solid var(--divider-color);
        padding: 10px;
        border-radius: 4px;
        margin-top: 8px;
      }

      .payment-header {
        font-weight: 700;
        color: var(--totvs-brand);
        margin-bottom: 4px;
        border-bottom: 1px solid #eee;
        padding-bottom: 4px;
      }

      .installment-row {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        color: #555;
      }

      .status-tag {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
      }
      .status-success {
        background: var(--success-bg);
        color: var(--success-color);
        border: 1px solid transparent;
      }
      .status-error {
        background: var(--error-bg);
        color: var(--error-color);
        border: 1px solid transparent;
      }

      @media print {
        body {
          background: white;
          padding: 0;
        }
        .no-print,
        .rm-header,
        .upload-grid,
        button {
          display: none !important;
        }

        .po-widget {
          box-shadow: none;
          border: 1px solid #ccc;
          margin-bottom: 0;
          break-inside: auto;
          page-break-after: always;
        }
        .po-widget:last-child {
          page-break-after: auto;
        }

        .table-scroll {
          max-height: none !important;
          overflow: visible !important;
          border: none;
        }
        .recon-grid {
          border: 1px solid #ccc;
        }
      }
    </style>
  </head>
  <body>
    <div class="rm-header no-print">
      <div class="rm-logo">RM | Confer√™ncia de Pedidos</div>
      <div>
        <button
          class="po-btn"
          style="
            background: transparent;
            border: none;
            color: white;
            font-size: 0.85rem;
          "
          onclick="window.print()"
        >
          üñ®Ô∏è Imprimir Relat√≥rio
        </button>
      </div>
    </div>

    <div class="container">
      <div class="upload-grid no-print">
        <div class="po-widget" style="margin: 0">
          <h3>Ordens de Compra (PDF)</h3>
          <div
            class="upload-zone"
            id="dropPDF"
            onclick="document.getElementById('inputPDF').click()"
          >
            <p>Clique ou arraste os arquivos PDF aqui</p>
            <input
              type="file"
              id="inputPDF"
              multiple
              accept=".pdf"
              style="display: none"
            />
          </div>
          <div
            id="statusPDF"
            style="
              margin-top: 12px;
              font-size: 0.85rem;
              color: var(--totvs-brand);
              font-weight: 600;
            "
          >
            0 arquivos selecionados
          </div>
        </div>

        <div class="po-widget" style="margin: 0">
          <h3>Notas Fiscais (XML)</h3>
          <div
            class="upload-zone"
            id="dropXML"
            onclick="document.getElementById('inputXML').click()"
          >
            <p>Clique ou arraste os arquivos XML aqui</p>
            <input
              type="file"
              id="inputXML"
              multiple
              accept=".xml"
              style="display: none"
            />
          </div>
          <div
            id="statusXML"
            style="
              margin-top: 12px;
              font-size: 0.85rem;
              color: var(--totvs-brand);
              font-weight: 600;
            "
          >
            0 arquivos selecionados
          </div>
        </div>
      </div>

      <div id="resultsArea"></div>
    </div>

    <script>
      const state = {
        rawPdfs: [],
        rawXmls: [],
        groups: [],
        selection: { grpIdx: null, side: null, itemIdx: null },
      };

      setupUpload("dropPDF", "inputPDF", "statusPDF", "pdf");
      setupUpload("dropXML", "inputXML", "statusXML", "xml");

      function setupUpload(dropId, inputId, statusId, type) {
        const drop = document.getElementById(dropId);
        const input = document.getElementById(inputId);
        const status = document.getElementById(statusId);

        ["dragenter", "dragover", "dragleave", "drop"].forEach((ev) => {
          drop.addEventListener(ev, (e) => {
            e.preventDefault();
            e.stopPropagation();
          });
        });

        drop.addEventListener("dragenter", () =>
          drop.classList.add("highlight"),
        );
        drop.addEventListener("dragleave", () =>
          drop.classList.remove("highlight"),
        );
        drop.addEventListener("drop", (e) => {
          drop.classList.remove("highlight");
          handleFiles(e.dataTransfer.files, type, status);
        });
        input.addEventListener("change", () =>
          handleFiles(input.files, type, status),
        );
      }

      async function handleFiles(files, type, statusElem) {
        const arr = Array.from(files);
        statusElem.innerText = `Lendo ${arr.length} arquivos...`;

        if (type === "pdf") {
          for (const f of arr) {
            if (
              f.type === "application/pdf" ||
              f.name.toLowerCase().endsWith(".pdf")
            ) {
              const data = await parsePDF(f);
              state.rawPdfs.push(data);
            }
          }
        } else {
          for (const f of arr) {
            if (f.name.toLowerCase().endsWith(".xml")) {
              const text = await f.text();
              state.rawXmls.push(parseXML(text, f.name));
            }
          }
        }

        statusElem.innerText = `${type === "pdf" ? state.rawPdfs.length : state.rawXmls.length} arquivos carregados`;
        recalcGroups();
      }

      function recalcGroups() {
        state.groups = [];

        state.rawPdfs.forEach((pdf) => {
          const cleanPdfNum = parseInt(pdf.orderNum.replace(/\D/g, "")) || 0;

          const relatedXMLs = state.rawXmls.filter((xml) => {
            const cleanBody = xml.infCpl.replace(/\D/g, "");
            const foundInItems = xml.items.some((i) => {
              const cleanPed = parseInt(i.xPed.replace(/\D/g, "")) || 0;
              return cleanPed === cleanPdfNum && cleanPdfNum !== 0;
            });
            return xml.infCpl.includes(cleanPdfNum) || foundInItems;
          });

          let allXmlItems = [];
          let xmlFilesData = [];

          relatedXMLs.forEach((x) => {
            xmlFilesData.push({
              filename: x.filename,
              vendor: x.vendor,
              installments: x.installments,
              totalValue: x.items.reduce((acc, i) => acc + i.totalPrice, 0),
            });

            x.items.forEach((item, idx) => {
              allXmlItems.push({ ...item, _file: x.filename, _realId: idx });
            });
          });

          state.groups.push({
            orderNum: pdf.orderNum,
            orderData: pdf,
            xmlData: allXmlItems,
            xmlFilesData: xmlFilesData,
            hasXml: relatedXMLs.length > 0,
            matches: [],
            errors: [],
            errorMode: false,
          });
        });
        render();
      }

      function parseXML(text, filename) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, "text/xml");

        const emit = doc.getElementsByTagName("emit")[0];
        const vendor = emit
          ? emit.getElementsByTagName("xNome")[0]?.textContent
          : "Fornecedor Desconhecido";

        const cobr = doc.getElementsByTagName("cobr")[0];
        let installments = [];

        if (cobr) {
          const dups = cobr.getElementsByTagName("dup");
          if (dups.length > 0) {
            for (let i = 0; i < dups.length; i++) {
              const dVenc =
                dups[i].getElementsByTagName("dVenc")[0]?.textContent;
              const vDup = parseFloat(
                dups[i].getElementsByTagName("vDup")[0]?.textContent || 0,
              );

              let dateFmt = dVenc;
              if (dVenc && dVenc.includes("-")) {
                const parts = dVenc.split("-");
                dateFmt = `${parts[2]}/${parts[1]}/${parts[0]}`;
              }

              installments.push({ date: dateFmt, value: vDup });
            }
          }
        }

        const items = [];
        const dets = doc.getElementsByTagName("det");

        for (let i = 0; i < dets.length; i++) {
          const prod = dets[i].getElementsByTagName("prod")[0];
          const xPed = prod.getElementsByTagName("xPed")[0]?.textContent || "";
          const infAd =
            dets[i].getElementsByTagName("infAdProd")[0]?.textContent || "";

          let finalPed = xPed;
          if (!finalPed) {
            const m = infAd.match(/Ped\.?:?\s*(\d+)/i);
            if (m) finalPed = m[1];
          }

          items.push({
            desc: prod.getElementsByTagName("xProd")[0]?.textContent,
            qty: parseFloat(
              prod.getElementsByTagName("qCom")[0]?.textContent || 0,
            ),
            unitPrice: parseFloat(
              prod.getElementsByTagName("vUnCom")[0]?.textContent || 0,
            ),
            totalPrice: parseFloat(
              prod.getElementsByTagName("vProd")[0]?.textContent || 0,
            ),
            xPed: finalPed,
          });
        }
        return {
          filename,
          vendor,
          installments,
          infCpl: doc.getElementsByTagName("infCpl")[0]?.textContent || "",
          items,
        };
      }

      async function parsePDF(file) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        let allTokens = [];

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          const strings = content.items
            .map((it) => it.str.trim())
            .filter((s) => s.length > 0);
          allTokens = allTokens.concat(strings);
        }

        let orderNum = "N/A";
        const idxNum = allTokens.findIndex((t) => t.match(/N(?:√∫|u)mero:/i));
        if (idxNum > -1 && allTokens[idxNum + 1])
          orderNum = allTokens[idxNum + 1];

        // L√ìGICA DE FORNECEDOR AJUSTADA (BASEADO NO DUMP [16] NOME, [17] LABEL)
        let vendor = "N/A";
        const idxFor = allTokens.findIndex((t) => t.match(/Fornecedor:/i));

        if (idxFor > -1) {
          // Tenta pegar o token ANTERIOR (comportamento observado no seu arquivo)
          if (
            idxFor > 0 &&
            allTokens[idxFor - 1] &&
            !allTokens[idxFor - 1].includes(":")
          ) {
            vendor = allTokens[idxFor - 1];
          }
          // Fallback: Tenta pegar o token POSTERIOR (padr√£o comum)
          else if (allTokens[idxFor + 1]) {
            vendor = allTokens[idxFor + 1];
          }
        }

        const items = [];
        const isInt = (s) => /^\d+$/.test(s);
        const isPrice = (s) => /^\d{1,3}(?:\.\d{3})*,\d{2}$/.test(s);
        const parseMoney = (s) =>
          parseFloat(s.replace(".", "").replace(",", "."));
        const isUnit = (s) =>
          ["UN", "PC", "KG", "L", "TB200", "M", "CX"].includes(s.toUpperCase());

        for (let i = 0; i < allTokens.length; i++) {
          const token = allTokens[i];
          if (isInt(token) && parseInt(token) < 500) {
            if (i + 1 < allTokens.length && isInt(allTokens[i + 1])) continue;

            const itemIdx = parseInt(token);
            let qty = 1;
            let descEndIndex = i - 1;

            if (i > 0 && isInt(allTokens[i - 1])) {
              qty = parseInt(allTokens[i - 1]);
              descEndIndex = i - 2;
            }
            while (descEndIndex > 0 && isUnit(allTokens[descEndIndex]))
              descEndIndex--;

            let totalPriceIndex = -1;
            for (let k = descEndIndex; k >= Math.max(0, i - 15); k--) {
              if (isPrice(allTokens[k])) {
                totalPriceIndex = k;
                break;
              }
            }

            if (totalPriceIndex > -1 && totalPriceIndex > 0) {
              const totalVal = parseMoney(allTokens[totalPriceIndex]);
              let unitVal = 0;
              if (isPrice(allTokens[totalPriceIndex - 1])) {
                unitVal = parseMoney(allTokens[totalPriceIndex - 1]);
              } else {
                unitVal = totalVal;
              }

              let descParts = [];
              for (let d = totalPriceIndex + 1; d <= descEndIndex; d++)
                descParts.push(allTokens[d]);
              const desc = descParts.join(" ");

              items.push({
                itemIdx,
                desc,
                qty,
                unitPrice: unitVal,
                totalPrice: totalVal,
              });
            }
          }
        }
        return { filename: file.name, orderNum, vendor, items };
      }

      function getNextAvailableId(matches) {
        const usedIds = matches.map((m) => m.id);
        let id = 1;
        while (usedIds.includes(id)) id++;
        return id;
      }

      function render() {
        const area = document.getElementById("resultsArea");
        area.innerHTML = "";

        if (
          state.groups.length === 0 &&
          (state.rawPdfs.length > 0 || state.rawXmls.length > 0)
        ) {
          area.innerHTML =
            '<div class="po-widget" style="text-align:center; padding:40px; color:#666"><h3>Nenhum v√≠nculo autom√°tico encontrado</h3><p>Verifique se o n√∫mero do pedido consta no XML (tag xPed ou InfCpl).</p></div>';
          return;
        }

        state.groups.forEach((grp, gIdx) => {
          const box = document.createElement("div");
          box.className = "po-widget";

          const status = grp.hasXml
            ? `<span class="status-tag status-success">V√≠nculo XML OK</span>`
            : `<span class="status-tag status-error">Sem XML correspondente</span>`;

          box.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                    <div>
                        <h2 style="margin:0; font-size:1.2rem; color:var(--totvs-brand)">Pedido: ${grp.orderNum}</h2>
                        <small style="color:#666">${grp.orderData.vendor}</small>
                    </div>
                    <div>${status}</div>
                </div>
            `;

          if (grp.hasXml) {
            const tools = document.createElement("div");
            tools.className = "no-print";
            tools.style.marginBottom = "20px";
            tools.style.display = "flex";
            tools.style.gap = "10px";

            tools.innerHTML = `
                    <button class="po-btn primary" onclick="autoMatch(${gIdx})">‚ö° Concilia√ß√£o Autom√°tica</button>
                    <button class="po-btn ${grp.errorMode ? "active-mode" : "danger"}" onclick="toggleError(${gIdx})">
                        ${grp.errorMode ? "Finalizar Apontamento" : "‚ö†Ô∏è Apontar Diverg√™ncia"}
                    </button>
                    <button class="po-btn" onclick="clearGroup(${gIdx})">Limpar Sele√ß√£o</button>
                `;
            box.appendChild(tools);

            if (grp.errorMode) {
              box.innerHTML += `<div style="background:var(--error-bg); color:var(--error-color); padding:12px; margin-bottom:15px; border-radius:4px; font-weight:600; font-size:0.9rem;">Modo de Apontamento Ativo: Clique nos itens para marcar diverg√™ncias.</div>`;
            }

            const grid = document.createElement("div");
            grid.className = "recon-grid";

            const money = (v) =>
              v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
            const totalPDF = grp.orderData.items.reduce(
              (acc, i) => acc + i.totalPrice,
              0,
            );
            const totalXML = grp.xmlData.reduce(
              (acc, i) => acc + i.totalPrice,
              0,
            );

            const distinctVendors = [
              ...new Set(grp.xmlFilesData.map((x) => x.vendor)),
            ].join(", ");

            const pdfPan = document.createElement("div");
            pdfPan.innerHTML = `
                <div class="panel-header">
                    <div class="panel-header-top"><span>Ordem de Compra (RM)</span> <span>${grp.orderData.items.length} itens</span></div>
                    <div class="panel-sub" title="${grp.orderData.vendor}">${grp.orderData.vendor}</div>
                </div>`;
            pdfPan.appendChild(createTable(grp.orderData.items, "pdf", gIdx));
            pdfPan.innerHTML += `
                <div class="footer-panel">
                    <div class="total-display">Total OC: ${money(totalPDF)}</div>
                </div>`;
            grid.appendChild(pdfPan);

            const xmlPan = document.createElement("div");
            xmlPan.style.borderLeft = "1px solid #e0e0e0";
            xmlPan.innerHTML = `
                <div class="panel-header">
                    <div class="panel-header-top"><span>Nota Fiscal (XML)</span> <span>${grp.xmlData.length} itens</span></div>
                    <div class="panel-sub" title="${distinctVendors}">${distinctVendors}</div>
                </div>`;
            xmlPan.appendChild(createTable(grp.xmlData, "xml", gIdx));

            let financeHtml = `<div class="footer-panel"><div class="total-display">Total NF: ${money(totalXML)}</div>`;

            grp.xmlFilesData.forEach((f) => {
              financeHtml += `<div class="payment-info">`;
              financeHtml += `<div class="payment-header">${f.vendor} (Total: ${money(f.totalValue)})</div>`;

              if (f.installments.length > 0) {
                f.installments.forEach((inst, idxInst) => {
                  financeHtml += `
                            <div class="installment-row">
                                <span>Parc ${idxInst + 1} (${inst.date})</span>
                                <span>${money(inst.value)}</span>
                            </div>`;
                });
              } else {
                financeHtml += `<div class="installment-row"><span>Pagamento √önico / √Ä Vista</span><span>${money(f.totalValue)}</span></div>`;
              }
              financeHtml += `</div>`;
            });
            financeHtml += `</div>`;

            xmlPan.innerHTML += financeHtml;
            grid.appendChild(xmlPan);

            box.appendChild(grid);
          } else {
            box.innerHTML += `<div style="padding:20px; background:#f9f9f9; border-radius:4px; color:#666">Nenhum XML com o pedido <strong>${grp.orderNum}</strong> foi localizado nos arquivos carregados.</div>`;
          }

          area.appendChild(box);
        });
      }

      function createTable(items, side, gIdx) {
        const wrap = document.createElement("div");
        wrap.className = "table-scroll";

        let html = `<table><thead><tr><th width="40">St</th><th width="40">#</th><th>Produto/Servi√ßo</th><th width="60">Qtd</th><th>Valor Unit.</th><th>Valor Total</th></tr></thead><tbody>`;

        items.forEach((item, idx) => {
          const grp = state.groups[gIdx];
          const match = grp.matches.find((m) =>
            m.items.some((x) => x.side === side && x.idx === idx),
          );
          const isErr = grp.errors.some(
            (e) => e.side === side && e.idx === idx,
          );
          const isSel =
            state.selection.grpIdx === gIdx &&
            state.selection.side === side &&
            state.selection.itemIdx === idx;

          let rowClass = "item-row";
          let badge = "";

          if (match) {
            rowClass += " is-match";
            badge = `<span class="badge" style="background:#0c9451; color:white; border:none;">${match.id}</span>`;
          } else if (isErr) {
            rowClass += " is-error";
            badge = `<span class="badge" style="background:#c62828; color:white; border:none;">!</span>`;
          }
          if (isSel) rowClass += " selected";

          const money = (v) =>
            v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
          const desc =
            side === "xml"
              ? `<span style="font-weight:500">${item.desc}</span><br><small style="color:#999; font-size:0.75rem">${item._file}</small>`
              : `<span style="font-weight:500">${item.desc}</span>`;
          const num = side === "pdf" ? item.itemIdx : idx + 1;

          html += `<tr class="${rowClass}" onclick="handleItemClick(${gIdx}, '${side}', ${idx})">
                <td align="center">${badge}</td>
                <td align="center" style="color:#888">${num}</td>
                <td>${desc}</td>
                <td align="center">${item.qty}</td>
                <td>${money(item.unitPrice)}</td>
                <td style="font-weight:600">${money(item.totalPrice)}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        wrap.innerHTML = html;
        return wrap;
      }

      function handleItemClick(gIdx, side, idx) {
        const grp = state.groups[gIdx];

        if (grp.errorMode) {
          const errIndex = grp.errors.findIndex(
            (e) => e.side === side && e.idx === idx,
          );
          if (errIndex > -1) {
            grp.errors.splice(errIndex, 1);
          } else {
            grp.matches = grp.matches.filter(
              (m) => !m.items.some((x) => x.side === side && x.idx === idx),
            );
            grp.errors.push({ side, idx });
          }
          render();
          return;
        }

        const sel = state.selection;

        if (sel.grpIdx === gIdx && sel.side === side && sel.itemIdx === idx) {
          state.selection = { grpIdx: null, side: null, itemIdx: null };
        } else if (sel.grpIdx === gIdx && sel.side && sel.side !== side) {
          cleanItem(gIdx, sel.side, sel.itemIdx);
          cleanItem(gIdx, side, idx);

          const newId = getNextAvailableId(grp.matches);
          grp.matches.push({
            id: newId,
            items: [
              { side: sel.side, idx: sel.itemIdx },
              { side, idx },
            ],
          });
          state.selection = { grpIdx: null, side: null, itemIdx: null };
        } else {
          state.selection = { grpIdx: gIdx, side, itemIdx: idx };
        }
        render();
      }

      function autoMatch(gIdx) {
        const grp = state.groups[gIdx];
        let changes = false;
        grp.orderData.items.forEach((pItem, pIdx) => {
          if (isBusy(grp, "pdf", pIdx)) return;
          const xIdx = grp.xmlData.findIndex((xItem, xi) => {
            if (isBusy(grp, "xml", xi)) return false;
            return Math.abs(xItem.unitPrice - pItem.unitPrice) < 0.05;
          });

          if (xIdx > -1) {
            const newId = getNextAvailableId(grp.matches);
            grp.matches.push({
              id: newId,
              items: [
                { side: "pdf", idx: pIdx },
                { side: "xml", idx: xIdx },
              ],
            });
            changes = true;
          }
        });
        if (changes) render();
        else
          alert("Nenhum match autom√°tico encontrado para os itens restantes.");
      }

      function toggleError(gIdx) {
        state.groups[gIdx].errorMode = !state.groups[gIdx].errorMode;
        render();
      }
      function clearGroup(gIdx) {
        if (confirm("Deseja limpar todas as concilia√ß√µes deste pedido?")) {
          state.groups[gIdx].matches = [];
          state.groups[gIdx].errors = [];
          render();
        }
      }
      function cleanItem(gIdx, side, idx) {
        state.groups[gIdx].matches = state.groups[gIdx].matches.filter(
          (m) => !m.items.some((x) => x.side === side && x.idx === idx),
        );
        state.groups[gIdx].errors = state.groups[gIdx].errors.filter(
          (e) => !(e.side === side && e.idx === idx),
        );
      }
      function isBusy(grp, side, idx) {
        return (
          grp.matches.some((m) =>
            m.items.some((x) => x.side === side && x.idx === idx),
          ) || grp.errors.some((e) => e.side === side && e.idx === idx)
        );
      }
    </script>
  </body>
</html>
